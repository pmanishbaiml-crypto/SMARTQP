<!DOCTYPE html>
<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8" />
    <title>Dashboard â€“ SmartQPGen</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- PWA Meta Tags -->
    <meta name="description" content="AI-powered question paper generation system for educational institutions">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SmartQPGen">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">

    <!-- PWA Icons -->
    <link rel="icon" type="image/jpeg" href="/static/assets/logo.jpg">
    <link rel="apple-touch-icon" href="/static/assets/logo.jpg">

    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/2.2.1/flowbite.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* Aggressive reset for body/html margins to prevent unwanted gaps */
        html,
        body {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            /* Ensure padding/border are included in element's total width/height */
            /* College background always set here, transparency via ::before */
            background: url("{{ url_for('static', filename='assets/college_bg.png') }}") no-repeat center center fixed;
            background-size: cover;
            /* No font-family added here to preserve original */
        }

        /* Ensure body is also h-full for proper flex calculation */
        body {
            min-height: 100vh;
            /* Ensure body takes full viewport height */
            display: flex;
            /* Make body a flex container for sidebar and main-content-wrapper */
        }

        /* Transparent white overlay for the body content - now with subtle margins */
        body::before {
            content: '';
            position: fixed;
            top: 0.5rem;
            /* 8px border */
            left: 0.5rem;
            right: 0.5rem;
            bottom: 0.5rem;
            background-color: rgba(255, 255, 255, 0.5);
            /* Light mode overlay: 50% white transparency */
            z-index: -1;
            /* Place it behind the main content but above the background image */
        }

        *,
        ::before,
        ::after {
            box-sizing: inherit;
        }

        /* --- Theme-agnostic base styles --- */
        /* Account avatar circle styles (same as before) */
        .account-avatar-circle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 9999px;
            border: 2px solid;
            font-weight: 600;
            font-size: 0.875rem;
            color: white;
            flex-shrink: 0;
        }

        .bg-avatar-1 {
            background-color: #EF4444;
            border-color: #DC2626;
        }

        /* red-500 */
        .bg-avatar-2 {
            background-color: #F97316;
            border-color: #EA580C;
        }

        /* orange-500 */
        .bg-avatar-3 {
            background-color: #EAB308;
            border-color: #D97706;
        }

        /* yellow-500 */
        .bg-avatar-4 {
            background-color: #22C55E;
            border-color: #16A34A;
        }

        /* green-500 */
        .bg-avatar-5 {
            background-color: #3B82F6;
            border-color: #2563EB;
        }

        /* blue-500 */
        .bg-avatar-6 {
            background-color: #8B5CF6;
            border-color: #7C3AED;
        }

        /* violet-500 */
        .bg-avatar-7 {
            background-color: #EC4899;
            border-color: #DB2777;
        }

        /* pink-500 */

        /* --- Sidebar & Main Content Layout (mostly same as last version, but with color variables) --- */
        .sidebar {
            width: 16rem;
            height: 100vh;
            flex-shrink: 0;
            transition: width 0.3s ease-in-out, transform 0.3s ease-in-out;
            overflow-x: hidden;
            white-space: nowrap;
        }

        .main-content-wrapper {
            flex-grow: 1;
            min-height: 100vh;
            /* Keep min-height for general responsiveness */
            height: 100vh;
            /* Make main wrapper explicitly take full viewport height */
            margin-left: 0;
            transition: margin-left 0.3s ease-in-out;
            display: flex;
            /* Make it a flex container */
            flex-direction: column;
            /* Stack its children (header, main-canvas) vertically */
        }

        /* main-content-area is now main#main-canvas */
        /* The existing .main-content-area CSS is fine, but main#main-canvas also needs flex-grow */

        /* --- Mobile Behavior: Sidebar Overlays --- */
        @media (max-width: 767px) {
            .sidebar {
                position: fixed;
                width: 16rem;
                transform: translateX(-100%);
                z-index: 1000;
            }

            body.sidebar-open-mobile .sidebar {
                transform: translateX(0);
            }

            body.sidebar-closed-desktop .sidebar {
                transform: translateX(-100%) !important;
                width: 16rem !important;
            }
        }

        /* --- Desktop Behavior: Sidebar Pushes/Expands --- */
        @media (min-width: 768px) {
            .sidebar {
                position: static;
                transform: translateX(0);
                width: 16rem;
                box-shadow: none;
            }

            body.sidebar-closed-desktop .sidebar {
                width: 4rem;

                & .text-2xl,
                & #new-qp-btn span,
                & nav a span,
                & .px-6.py-2.border-t.border-gray-700.space-y-2 a span {
                    display: none;
                }

                & #new-qp-btn {
                    width: calc(4rem - 1rem);
                    padding-left: 0;
                    padding-right: 0;
                    justify-content: center;
                }

                & #new-qp-btn i {
                    margin-right: 0;
                }
            }
        }

        /* --- THEME-SPECIFIC STYLES --- */
        /* Light Mode (Default) Colors */
        body {
            color: #1F2937;
            /* Default text color - gray-900 */
        }

        /* Body text */

        /* Sidebar Light Mode */
        .sidebar {
            background-color: #F9FAFB;
            /* gray-50 */
            color: #374151;
            /* gray-700 */
            border-right: 1px solid #E5E7EB;
        }

        /* gray-200 */
        .sidebar .border-gray-700 {
            border-color: #E5E7EB;
        }

        /* gray-200 */
        .sidebar a {
            color: #374151;
        }

        .sidebar a:hover {
            background-color: #F3F4F6;
            color: #1F2937;
        }

        /* gray-100 hover, gray-900 text */
        .sidebar button {
            background-color: #3B82F6;
            color: #FFFFFF;
        }

        /* blue-600, white */
        .sidebar button:hover {
            background-color: #2563EB;
        }

        /* blue-700 */

        /* Header Light Mode */
        header {
            background-color: rgba(255, 255, 255, 0.9);
            border-color: #E5E7EB;
        }

        /* white/90, gray-200 */
        header h1 {
            color: #1F2937;
        }

        /* gray-900 */
        header button {
            color: #374151;
        }

        /* gray-700 */
        header button:hover {
            color: #111827;
        }

        /* gray-900 hover */

        /* Main Canvas Light Mode */
        main#main-canvas {
            background-color: rgba(255, 255, 255, 0.7);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            flex-grow: 1;
            /* Crucial: make it grow to fill remaining vertical space */
            overflow-y: auto;
            /* Allow the main content area itself to scroll if absolutely necessary */
            padding: 0;
            /* Already there but emphasizing */
        }

        /* Content Sections inside Main Canvas Light Mode */
        #new-qp-canvas,
        #requirements-content,
        #saved-content,
        #recent-content,
        #settings-content,
        #help-content,
        #qp-editor-canvas {
            background-color: #FFFFFF;
            /* White */
            border-color: #E5E7EB;
            /* gray-200 */
        }

        #saved-content ul li {
            background-color: #F9FAFB;
        }

        /* gray-50 */


        /* --- Dark Mode Overrides --- */
        body.dark {
            background-color: #1F2937;
            color: #E5E7EB;
            background-image: none;
        }

        body.dark::before {
            background-color: rgba(0, 0, 0, 0.7);
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        /* Sidebar Dark Mode */
        body.dark .sidebar {
            background-color: #111827;
            color: #D1D5DB;
            border-right-color: #374151;
        }

        body.dark .sidebar .border-gray-700 {
            border-color: #374151;
        }

        body.dark .sidebar a {
            color: #D1D5DB;
        }

        body.dark .sidebar a:hover {
            background-color: #374151;
            color: #F9FAFB;
        }

        body.dark .sidebar button {
            background-color: #2563EB;
            color: #F9FAFB;
        }

        body.dark .sidebar button:hover {
            background-color: #1D4ED8;
        }

        /* Header Dark Mode */
        body.dark header {
            background-color: rgba(17, 24, 39, 0.9);
            border-color: #374151;
        }

        body.dark header h1 {
            color: #F9FAFB;
        }

        body.dark header button {
            color: #D1D5DB;
        }

        body.dark header button:hover {
            color: #F9FAFB;
        }

        /* Main Canvas Dark Mode */
        body.dark main#main-canvas {
            background-color: rgba(31, 41, 55, 0.7);
            box-shadow: none;
        }

        body.dark main#main-canvas h2,
        body.dark main#main-canvas h3 {
            color: #F9FAFB;
        }

        body.dark main#main-canvas p,
        body.dark main#main-canvas ul,
        body.dark main#main-canvas li {
            color: #D1D5DB;
        }

        /* Content Sections inside Main Canvas Dark Mode */
        body.dark #new-qp-canvas,
        body.dark #requirements-content,
        body.dark #saved-content,
        body.dark #recent-content,
        body.dark #settings-content,
        body.dark #help-content,
        body.dark #qp-editor-canvas {
            background-color: #1F2937;
            border-color: #374151;
        }

        body.dark #saved-content ul li {
            background-color: #374151;
        }

        /* Account Dropdown Dark Mode */
        body.dark #account-dropdown {
            background-color: #1F2937;
            border-color: #374151;
        }

        body.dark #account-dropdown .text-gray-700 {
            color: #D1D5DB;
        }

        body.dark #account-dropdown .text-gray-500 {
            color: #9CA3AF;
        }

        body.dark #account-dropdown .hover\:bg-gray-100:hover {
            background-color: #374151;
        }

        body.dark #account-dropdown .text-red-600 {
            color: #EF4444;
        }

        /* Theme Toggle Dark Mode */
        body.dark #theme-toggle+div {
            background-color: #4B5563;
        }

        body.dark #theme-toggle:checked+div {
            background-color: #2563EB;
        }

        /* Specific styles for QP Editor */
        .qp-main-question {
            border: 1px solid #CBD5E0;
            /* gray-300 */
            border-radius: 0.5rem;
            /* rounded-lg */
            padding: 1rem;
            /* p-4 */
            margin-bottom: 1.5rem;
            /* mb-6 */
            background-color: #F8FAFC;
            /* gray-50 */
            position: relative;
        }

        .qp-main-question.selected-alt {
            border-color: #3B82F6;
            /* blue-500 */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
            /* blue-500 with opacity */
        }

        .qp-main-question.qp-alt-option {
            background-color: #EFF6FF;
            /* blue-50 */
            border-style: dashed;
        }

        .qp-sub-question {
            border: 1px dashed #E2E8F0;
            /* gray-200 */
            border-radius: 0.375rem;
            /* rounded-md */
            padding: 0.75rem;
            /* p-3 */
            margin-top: 0.75rem;
            /* mt-3 */
            background-color: #FFFFFF;
            /* white */
        }

        .qp-sub-question .remove-sub-btn {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background-color: #EF4444;
            /* red-500 */
            color: white;
            border-radius: 9999px;
            /* full rounded */
            width: 1.25rem;
            height: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            line-height: 1;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }

        .qp-sub-question:hover .remove-sub-btn {
            opacity: 1;
        }

        .qp-question-number {
            font-weight: bold;
            margin-right: 0.5rem;
            display: inline-block;
            min-width: 1.5rem;
            /* For alignment */
            text-align: right;
        }

        .qp-question-text {
            display: inline-block;
            width: calc(100% - 2.5rem);
            /* Adjust for number and margin */
            vertical-align: top;
        }

        .qp-marks-input {
            width: 3rem;
            /* Small width for marks input */
            text-align: center;
            border: 1px solid #CBD5E0;
            border-radius: 0.25rem;
            padding: 0.1rem 0.2rem;
            font-size: 0.875rem;
        }

        .qp-total-marks {
            font-weight: bold;
            color: #10B981;
            /* green-500 */
        }

        .qp-total-marks.error {
            color: #EF4444;
            /* red-500 */
        }

        /* Styles for the modal */
        .modal {
            display: none;
            /* Hidden by default */
            position: fixed;
            /* Stay in place */
            z-index: 1000;
            /* Sit on top */
            left: 0;
            top: 0;
            width: 100%;
            /* Full width */
            height: 100%;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgba(0, 0, 0, 0.4);
            /* Black w/ opacity */
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* Styles for the splitter */
        .splitter {
            width: 8px;
            /* Width of the draggable bar */
            cursor: ew-resize;
            /* East-West resize cursor */
            background-color: #cbd5e0;
            /* light gray, tailwind gray-300 */
            flex-shrink: 0;
            /* Prevent the splitter from shrinking */
            z-index: 10;
            /* Ensure it's on top */
            transition: background-color 0.2s ease;
            /* Smooth hover effect */
        }

        .splitter:hover {
            background-color: #3b82f6;
            /* blue-500 on hover */
        }

        /* Ensure the parent of .splitter and panes is flex */
        .qp-editor-flex-container {
            display: flex;
            position: relative;
            /* Important for absolute positioning if needed, or just for context */
            height: 100%;
            /* Make it take up the full height of its flex-grow parent (#qp-editor-canvas) */
            gap: 0;
            /* No gap between elements */
        }

        /* Ensure equal pane sizes with stronger constraints */
        #left-pane,
        #right-pane {
            flex: 1 1 0 !important;
            /* Equal flex grow, shrink, and basis - force with !important */
            min-width: 0 !important;
            /* Allow shrinking below content width */
            max-width: none !important;
            /* No maximum width restriction */
            width: 0 !important;
            /* Reset width to let flex handle sizing */
            box-sizing: border-box;
            /* Include padding and border in width calculation */
            display: flex !important;
            flex-direction: column !important;
        }

        /* Prevent content from affecting pane width */
        #left-pane *,
        #right-pane * {
            max-width: 100%;
            box-sizing: border-box;
        }

        /* Ensure headers don't cause width differences */
        #left-pane h4,
        #right-pane h4 {
            min-width: 0;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            margin: 0 !important;
            padding: 0 0 12px 0 !important;
            flex-shrink: 0;
        }

        /* Ensure content areas are equal and contained */
        #parsed-questions-list,
        #qp-preview-list {
            min-width: 0;
            width: 100%;
            overflow-wrap: break-word;
            word-wrap: break-word;
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1;
            margin: 0;
            padding: 0;
        }

        /* Force equal width distribution regardless of content */
        .qp-editor-flex-container>#left-pane {
            flex: 1 1 50% !important;
        }

        .qp-editor-flex-container>#right-pane {
            flex: 1 1 50% !important;
        }

        /* Additional layout improvements */
        #qp-editor-canvas {
            min-height: 600px;
        }

        /* Ensure consistent spacing in both panes */
        #left-pane>*,
        #right-pane>* {
            margin-left: 0;
            margin-right: 0;
        }

        /* Fix button alignment */
        #add-main-question-btn,
        #generate-questions-btn {
            width: 100%;
            margin-bottom: 16px;
        }

        /* Ensure consistent padding for content sections */
        .mb-3 {
            margin-bottom: 12px !important;
        }

        .mb-4 {
            margin-bottom: 16px !important;
        }

        /* Cool Dashboard Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes bounce {

            0%,
            20%,
            50%,
            80%,
            100% {
                transform: translateY(0);
            }

            40% {
                transform: translateY(-10px);
            }

            60% {
                transform: translateY(-5px);
            }
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -200px 0;
            }

            100% {
                background-position: calc(200px + 100%) 0;
            }
        }

        .animate-fade-in {
            animation: fadeIn 1s ease-out;
        }

        .animate-slide-in-left {
            animation: slideInLeft 0.6s ease-out;
        }

        .animate-slide-in-right {
            animation: slideInRight 0.6s ease-out;
        }

        .animate-bounce-slow {
            animation: bounce 2s infinite;
        }

        .animate-pulse-slow {
            animation: pulse 3s ease-in-out infinite;
        }

        .animate-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200px 100%;
            animation: shimmer 2s infinite;
        }

        /* Stat Card Hover Effects */
        .stat-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        /* Quick Action Button Effects */
        .quick-action-btn {
            position: relative;
            overflow: hidden;
        }

        .quick-action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .quick-action-btn:hover::before {
            left: 100%;
        }

        /* Floating Animation */
        .float {
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }

            100% {
                transform: translateY(0px);
            }
        }

        /* Gradient Text Animation */
        .gradient-text {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientShift 4s ease infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* Loading Skeleton */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200px 100%;
            animation: shimmer 1.5s infinite;
        }

        /* Enhanced scrolling for independent panes */
        #parsed-questions-list {
            max-height: calc(100vh - 300px);
            /* Ensure definite height for scrolling */
            overflow-y: auto;
            overflow-x: hidden;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f1f5f9;
        }

        #qp-preview-list {
            max-height: calc(100vh - 350px);
            /* Account for buttons above */
            overflow-y: auto;
            overflow-x: hidden;
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f1f5f9;
        }

        /* Custom scrollbar for webkit browsers */
        #parsed-questions-list::-webkit-scrollbar,
        #qp-preview-list::-webkit-scrollbar {
            width: 6px;
        }

        #parsed-questions-list::-webkit-scrollbar-track,
        #qp-preview-list::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        #parsed-questions-list::-webkit-scrollbar-thumb,
        #qp-preview-list::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        #parsed-questions-list::-webkit-scrollbar-thumb:hover,
        #qp-preview-list::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body class="flex min-h-screen h-full">

    <aside id="sidebar" class="sidebar flex flex-col shadow-lg">
        <div class="py-3 px-6 flex items-center justify-between border-b border-gray-700">
            <button id="sidebar-toggle-desktop"
                class="hidden md:block text-gray-300 hover:text-white focus:outline-none mr-3">
                <i class="fas fa-bars text-xl"></i>
            </button>
            <span class="text-2xl font-bold flex-grow">SmartQPGen</span>
            <button id="sidebar-toggle-close-mobile"
                class="md:hidden text-gray-300 hover:text-white focus:outline-none">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <div class="p-4">
            <button id="new-qp-btn"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center justify-center space-x-2 transition duration-200">
                <i class="fas fa-plus"></i>
                <span>New Question Paper</span>
            </button>
        </div>

        <nav class="flex-grow px-6 py-2 space-y-2">
            <a href="#" id="nav-requirements"
                class="flex items-center p-2 text-base font-medium rounded-lg hover:bg-gray-700 transition duration-200">
                <i class="fas fa-clipboard-list w-5 h-5 mr-3"></i>
                <span>Requirements for QP</span>
            </a>
            <a href="#" id="nav-saved"
                class="flex items-center p-2 text-base font-medium rounded-lg hover:bg-gray-700 transition duration-200">
                <i class="fas fa-save w-5 h-5 mr-3"></i>
                <span>Saved QPs & Banks</span>
            </a>
            <a href="#" id="nav-recent"
                class="flex items-center p-2 text-base font-medium rounded-lg hover:bg-gray-700 transition duration-200">
                <i class="fas fa-history w-5 h-5 mr-3"></i>
                <span>Recent Generated QPs</span>
            </a>
        </nav>

        <div class="px-6 py-2 border-t border-gray-700 space-y-2">
            <a href="#" id="nav-settings"
                class="flex items-center p-2 text-base font-medium rounded-lg hover:bg-gray-700 transition duration-200">
                <i class="fas fa-cog w-5 h-5 mr-3"></i>
                <span>Settings</span>
            </a>
            <a href="#" id="nav-help"
                class="flex items-center p-2 text-base font-medium rounded-lg hover:bg-gray-700 transition duration-200">
                <i class="fas fa-question-circle w-5 h-5 mr-3"></i>
                <span>Help</span>
            </a>


        </div>
    </aside>

    <div id="main-content-wrapper" class="main-content-wrapper flex-grow flex flex-col h-full">
        <header
            class="backdrop-blur-md shadow-sm p-4 flex justify-between items-center border-b border-gray-200 sticky top-0 z-30">
            <button id="sidebar-toggle-open-mobile"
                class="md:hidden text-gray-700 hover:text-gray-900 focus:outline-none">
                <i class="fas fa-bars text-xl"></i>
            </button>
            <h1 id="current-view-title" class="text-xl font-semibold px-6 md:px-0 md:text-left">Dashboard</h1>
            <div class="relative ml-auto">
                <button id="account-menu-btn" type="button"
                    class="flex items-center space-x-2 text-gray-700 hover:text-gray-900 focus:outline-none">
                    <div id="account-avatar-circle" class="account-avatar-circle border-blue-500 bg-blue-600">
                        <span id="account-initial">U</span>
                    </div>
                    <i class="fas fa-chevron-down text-xs"></i>
                </button>

                <div id="account-dropdown"
                    class="absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg py-1 z-50 hidden">
                    <div class="px-4 py-2 text-sm border-b border-gray-200">
                        <p id="dropdown-username" class="font-semibold">User Name</p>
                        <p id="dropdown-email" class="text-gray-500 text-xs break-words"></p>
                        <div class="flex items-center mt-1">
                            <span
                                class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800"
                                id="user-role-badge">
                                <i class="fas fa-user mr-1"></i>Faculty
                            </span>
                            <span class="ml-2 text-xs text-gray-500" id="user-department">CSE</span>
                        </div>
                    </div>
                    <a href="#" class="block px-4 py-2 text-sm hover:bg-gray-100">
                        <i class="fas fa-user-circle mr-2"></i>Profile Settings
                    </a>
                    <a href="#" class="block px-4 py-2 text-sm hover:bg-gray-100">
                        <i class="fas fa-cog mr-2"></i>Account Settings
                    </a>

                    <div class="border-t border-gray-100"></div>
                    <a href="#" id="dropdown-add-account" class="block px-4 py-2 text-sm hover:bg-gray-100"><i
                            class="fas fa-user-plus mr-2"></i>Add Account</a>
                    <a href="#" id="dropdown-delete-account"
                        class="block px-4 py-2 text-sm text-red-600 hover:bg-red-50"><i
                            class="fas fa-user-times mr-2"></i>Delete Account</a>
                    <a href="#" id="dropdown-sign-out" class="block px-4 py-2 text-sm hover:bg-gray-100"><i
                            class="fas fa-sign-out-alt mr-2"></i>Sign Out</a>
                </div>
            </div>
        </header>

        <main id="main-canvas" class="main-content-area flex-grow backdrop-blur-sm shadow-inner h-full">
            <div id="welcome-content" class="p-6 space-y-8">
                <!-- Hero Section with Animation -->
                <div class="text-center mb-8">
                    <div class="inline-block">
                        <h1
                            class="text-4xl font-bold bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 bg-clip-text text-transparent mb-2 animate-pulse">
                            Welcome to SmartQPGen! ðŸš€
                        </h1>
                        <div class="h-1 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full animate-pulse"></div>
                    </div>
                    <p class="text-lg text-gray-600 mt-4 animate-fade-in" id="welcome-message">
                        Hello, <span class="font-semibold text-blue-600" id="user-name-display">User</span>! Ready to
                        create amazing question papers?
                    </p>
                </div>

                <!-- Quick Stats Dashboard -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Total Questions Stat -->
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-6 text-white shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 cursor-pointer"
                        id="stat-questions">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm font-medium">Total Questions</p>
                                <p class="text-3xl font-bold" id="total-questions-count">0</p>
                                <p class="text-blue-200 text-xs mt-1">In your bank</p>
                            </div>
                            <div class="bg-blue-400 bg-opacity-30 rounded-full p-3">
                                <i class="fas fa-question-circle text-2xl"></i>
                            </div>
                        </div>
                        <div class="mt-4 flex items-center">
                            <i class="fas fa-arrow-up text-green-300 text-sm mr-1"></i>
                            <span class="text-green-300 text-sm font-medium">+12% this week</span>
                        </div>
                    </div>

                    <!-- Generated Papers Stat -->
                    <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-6 text-white shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 cursor-pointer"
                        id="stat-papers">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm font-medium">Papers Generated</p>
                                <p class="text-3xl font-bold" id="generated-papers-count">0</p>
                                <p class="text-green-200 text-xs mt-1">This month</p>
                            </div>
                            <div class="bg-green-400 bg-opacity-30 rounded-full p-3">
                                <i class="fas fa-file-alt text-2xl"></i>
                            </div>
                        </div>
                        <div class="mt-4 flex items-center">
                            <i class="fas fa-arrow-up text-green-300 text-sm mr-1"></i>
                            <span class="text-green-300 text-sm font-medium">+8% this month</span>
                        </div>
                    </div>

                    <!-- Templates Saved Stat -->
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-6 text-white shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 cursor-pointer"
                        id="stat-templates">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100 text-sm font-medium">Saved Templates</p>
                                <p class="text-3xl font-bold" id="saved-templates-count">0</p>
                                <p class="text-purple-200 text-xs mt-1">Ready to use</p>
                            </div>
                            <div class="bg-purple-400 bg-opacity-30 rounded-full p-3">
                                <i class="fas fa-bookmark text-2xl"></i>
                            </div>
                        </div>
                        <div class="mt-4 flex items-center">
                            <i class="fas fa-plus text-purple-300 text-sm mr-1"></i>
                            <span class="text-purple-300 text-sm font-medium">Create new</span>
                        </div>
                    </div>

                    <!-- Success Rate Stat -->
                    <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl p-6 text-white shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 cursor-pointer"
                        id="stat-success">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-orange-100 text-sm font-medium">Success Rate</p>
                                <p class="text-3xl font-bold">98%</p>
                                <p class="text-orange-200 text-xs mt-1">Generation success</p>
                            </div>
                            <div class="bg-orange-400 bg-opacity-30 rounded-full p-3">
                                <i class="fas fa-chart-line text-2xl"></i>
                            </div>
                        </div>
                        <div class="mt-4 flex items-center">
                            <i class="fas fa-check text-green-300 text-sm mr-1"></i>
                            <span class="text-green-300 text-sm font-medium">Excellent!</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions Section -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-bolt text-yellow-500 mr-2"></i>
                        Quick Actions
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- New Question Paper -->
                        <button
                            class="quick-action-btn bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white p-4 rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-300 flex items-center space-x-3"
                            id="quick-new-qp">
                            <div class="bg-blue-400 bg-opacity-30 rounded-full p-2">
                                <i class="fas fa-plus text-lg"></i>
                            </div>
                            <div class="text-left">
                                <p class="font-semibold">New Question Paper</p>
                                <p class="text-blue-100 text-sm">Start creating</p>
                            </div>
                        </button>

                        <!-- Upload Questions -->
                        <button
                            class="quick-action-btn bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white p-4 rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-300 flex items-center space-x-3"
                            id="quick-upload">
                            <div class="bg-green-400 bg-opacity-30 rounded-full p-2">
                                <i class="fas fa-upload text-lg"></i>
                            </div>
                            <div class="text-left">
                                <p class="font-semibold">Upload Questions</p>
                                <p class="text-green-100 text-sm">Add to bank</p>
                            </div>
                        </button>

                        <!-- Requirements -->
                        <button
                            class="quick-action-btn bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white p-4 rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-300 flex items-center space-x-3"
                            id="quick-requirements">
                            <div class="bg-purple-400 bg-opacity-30 rounded-full p-2">
                                <i class="fas fa-clipboard-list text-lg"></i>
                            </div>
                            <div class="text-left">
                                <p class="font-semibold">Set Requirements</p>
                                <p class="text-purple-100 text-sm">Configure QP</p>
                            </div>
                        </button>

                        <!-- Saved Papers -->
                        <button
                            class="quick-action-btn bg-gradient-to-r from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700 text-white p-4 rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-300 flex items-center space-x-3"
                            id="quick-saved">
                            <div class="bg-indigo-400 bg-opacity-30 rounded-full p-2">
                                <i class="fas fa-save text-lg"></i>
                            </div>
                            <div class="text-left">
                                <p class="font-semibold">Saved Papers</p>
                                <p class="text-indigo-100 text-sm">View collection</p>
                            </div>
                        </button>

                        <!-- Recent Papers -->
                        <button
                            class="quick-action-btn bg-gradient-to-r from-pink-500 to-pink-600 hover:from-pink-600 hover:to-pink-700 text-white p-4 rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-300 flex items-center space-x-3"
                            id="quick-recent">
                            <div class="bg-pink-400 bg-opacity-30 rounded-full p-2">
                                <i class="fas fa-history text-lg"></i>
                            </div>
                            <div class="text-left">
                                <p class="font-semibold">Recent Papers</p>
                                <p class="text-pink-100 text-sm">View history</p>
                            </div>
                        </button>

                        <!-- Settings -->
                        <button
                            class="quick-action-btn bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white p-4 rounded-lg shadow-md hover:shadow-lg transform hover:scale-105 transition-all duration-300 flex items-center space-x-3"
                            id="quick-settings">
                            <div class="bg-gray-400 bg-opacity-30 rounded-full p-2">
                                <i class="fas fa-cog text-lg"></i>
                            </div>
                            <div class="text-left">
                                <p class="font-semibold">Settings</p>
                                <p class="text-gray-100 text-sm">Customize app</p>
                            </div>
                        </button>


                    </div>
                </div>

                <!-- Recent Activity & Tips Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Recent Activity -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-clock text-blue-500 mr-2"></i>
                            Recent Activity
                        </h3>
                        <div class="space-y-4" id="recent-activity-list">
                            <div
                                class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                                <div class="bg-green-500 rounded-full p-2">
                                    <i class="fas fa-file-alt text-white text-sm"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="font-medium text-gray-800">Generated CS701 Question Paper</p>
                                    <p class="text-gray-500 text-sm">2 hours ago</p>
                                </div>
                                <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">Success</span>
                            </div>

                            <div
                                class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                                <div class="bg-blue-500 rounded-full p-2">
                                    <i class="fas fa-upload text-white text-sm"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="font-medium text-gray-800">Uploaded 23 new questions</p>
                                    <p class="text-gray-500 text-sm">5 hours ago</p>
                                </div>
                                <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">Completed</span>
                            </div>

                            <div
                                class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                                <div class="bg-purple-500 rounded-full p-2">
                                    <i class="fas fa-bookmark text-white text-sm"></i>
                                </div>
                                <div class="flex-1">
                                    <p class="font-medium text-gray-800">Saved requirements template</p>
                                    <p class="text-gray-500 text-sm">1 day ago</p>
                                </div>
                                <span class="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded-full">Saved</span>
                            </div>
                        </div>
                        <button class="mt-4 text-blue-600 hover:text-blue-800 font-medium text-sm flex items-center">
                            View all activity <i class="fas fa-arrow-right ml-1"></i>
                        </button>
                    </div>

                    <!-- Tips & Features -->
                    <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
                        <h3 class="text-xl font-bold mb-4 flex items-center">
                            <i class="fas fa-lightbulb text-yellow-300 mr-2"></i>
                            Pro Tips
                        </h3>
                        <div class="space-y-4">
                            <div class="flex items-start space-x-3">
                                <div class="bg-white bg-opacity-20 rounded-full p-1 mt-1">
                                    <i class="fas fa-check text-xs"></i>
                                </div>
                                <div>
                                    <p class="font-medium">Use Requirements Templates</p>
                                    <p class="text-indigo-100 text-sm">Save time by creating reusable requirement
                                        configurations</p>
                                </div>
                            </div>

                            <div class="flex items-start space-x-3">
                                <div class="bg-white bg-opacity-20 rounded-full p-1 mt-1">
                                    <i class="fas fa-check text-xs"></i>
                                </div>
                                <div>
                                    <p class="font-medium">Auto-Generate Questions</p>
                                    <p class="text-indigo-100 text-sm">Let AI create balanced question papers
                                        automatically</p>
                                </div>
                            </div>

                            <div class="flex items-start space-x-3">
                                <div class="bg-white bg-opacity-20 rounded-full p-1 mt-1">
                                    <i class="fas fa-check text-xs"></i>
                                </div>
                                <div>
                                    <p class="font-medium">PDF Export Ready</p>
                                    <p class="text-indigo-100 text-sm">Generate professional PDFs with proper formatting
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-6 p-4 bg-white bg-opacity-10 rounded-lg">
                            <p class="text-sm">
                                <i class="fas fa-star text-yellow-300 mr-1"></i>
                                <strong>New Feature:</strong> Bloom's Taxonomy validation ensures educational standards
                                compliance!
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Footer Message -->
                <div
                    class="text-center mt-8 p-6 bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl border border-blue-100">
                    <p class="text-gray-600">
                        <i class="fas fa-rocket text-blue-500 mr-2"></i>
                        Ready to create your next question paper? Choose an action above or explore the sidebar!
                    </p>
                </div>
            </div>

            <div id="new-qp-canvas" class="hidden p-6 mt-8 border border-blue-200 rounded-lg bg-blue-50">
                <h3 class="text-xl font-semibold mb-4">Generate New Question Paper</h3>

                <div class="mt-4 p-4 border border-blue-300 rounded-lg bg-white shadow-sm">
                    <h4 class="text-lg font-semibold mb-3">Upload Question Bank (PDF or DOCX)</h4>

                    <!-- CIE Selection Dropdown -->
                    <div class="mb-4">
                        <label for="cie-type-select" class="block text-sm font-medium text-gray-700 mb-2">Select CIE
                            Type:</label>
                        <select id="cie-type-select"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="standard">Standard Pattern (All Modules)</option>
                            <option value="cie1">CIE 1 (Modules 1, 2, 3)</option>
                            <option value="cie2">CIE 2 (Modules 3, 4, 5)</option>
                        </select>
                    </div>

                    <!-- Standard Upload (for Standard Pattern) -->
                    <div id="standard-upload" class="upload-section">
                        <form id="upload-qb-form" enctype="multipart/form-data">
                            <label for="file-input" class="block text-sm font-medium text-gray-700 mb-1">Select
                                File:</label>
                            <div class="flex items-center space-x-2">
                                <input type="file" id="file-input" name="file" accept=".pdf,.docx"
                                    class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                                    required>
                                <button type="button" id="clear-file-btn"
                                    class="px-3 py-2 text-sm bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition duration-200"
                                    title="Clear selected file">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <p id="selected-file-name" class="mt-2 text-sm text-gray-600 italic hidden"></p>

                            <div class="mt-4 flex items-center">
                                <label for="rephrasing-toggle" class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" value="" id="rephrasing-toggle" class="sr-only peer">
                                    <div
                                        class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white peer-checked:bg-blue-600">
                                    </div>
                                    <span class="ms-3 text-sm font-medium text-gray-900">Enable Rephrasing (AI
                                        Feature)</span>
                                </label>
                            </div>

                            <button type="submit" id="parse-file-btn"
                                class="mt-6 px-6 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition duration-200">
                                Parse Document & Start QP Generation
                            </button>
                        </form>
                    </div>

                    <!-- CIE 1 Upload (Modules 1, 2, 3) -->
                    <div id="cie1-upload" class="upload-section hidden">
                        <form id="upload-cie1-form" enctype="multipart/form-data">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <!-- Module 1 -->
                                <div class="p-3 border border-gray-300 rounded-lg bg-gray-50">
                                    <h5 class="text-sm font-semibold text-gray-700 mb-2">Module 1</h5>
                                    <input type="file" name="module1_file" accept=".pdf,.docx"
                                        class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-white focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                    <p id="module1-file-name" class="mt-1 text-xs text-gray-600 italic hidden"></p>
                                </div>

                                <!-- Module 2 -->
                                <div class="p-3 border border-gray-300 rounded-lg bg-gray-50">
                                    <h5 class="text-sm font-semibold text-gray-700 mb-2">Module 2</h5>
                                    <input type="file" name="module2_file" accept=".pdf,.docx"
                                        class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-white focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                    <p id="module2-file-name" class="mt-1 text-xs text-gray-600 italic hidden"></p>
                                </div>

                                <!-- Module 3 -->
                                <div class="p-3 border border-gray-300 rounded-lg bg-gray-50">
                                    <h5 class="text-sm font-semibold text-gray-700 mb-2">Module 3</h5>
                                    <input type="file" name="module3_file" accept=".pdf,.docx"
                                        class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-white focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                    <p id="module3-file-name" class="mt-1 text-xs text-gray-600 italic hidden"></p>
                                </div>
                            </div>

                            <div class="mt-4 flex items-center">
                                <label for="rephrasing-toggle-cie1" class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" value="" id="rephrasing-toggle-cie1" class="sr-only peer">
                                    <div
                                        class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white peer-checked:bg-blue-600">
                                    </div>
                                    <span class="ms-3 text-sm font-medium text-gray-900">Enable Rephrasing (AI
                                        Feature)</span>
                                </label>
                            </div>

                            <button type="submit" id="parse-cie1-btn"
                                class="mt-6 px-6 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition duration-200">
                                Parse All Modules & Start QP Generation
                            </button>
                        </form>
                    </div>

                    <!-- CIE 2 Upload (Modules 3, 4, 5) -->
                    <div id="cie2-upload" class="upload-section hidden">
                        <form id="upload-cie2-form" enctype="multipart/form-data">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <!-- Module 3 -->
                                <div class="p-3 border border-gray-300 rounded-lg bg-gray-50">
                                    <h5 class="text-sm font-semibold text-gray-700 mb-2">Module 3</h5>
                                    <input type="file" name="module3_file" accept=".pdf,.docx"
                                        class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-white focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                    <p id="module3-file-name-cie2" class="mt-1 text-xs text-gray-600 italic hidden"></p>
                                </div>

                                <!-- Module 4 -->
                                <div class="p-3 border border-gray-300 rounded-lg bg-gray-50">
                                    <h5 class="text-sm font-semibold text-gray-700 mb-2">Module 4</h5>
                                    <input type="file" name="module4_file" accept=".pdf,.docx"
                                        class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-white focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                    <p id="module4-file-name" class="mt-1 text-xs text-gray-600 italic hidden"></p>
                                </div>

                                <!-- Module 5 -->
                                <div class="p-3 border border-gray-300 rounded-lg bg-gray-50">
                                    <h5 class="text-sm font-semibold text-gray-700 mb-2">Module 5</h5>
                                    <input type="file" name="module5_file" accept=".pdf,.docx"
                                        class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-white focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                    <p id="module5-file-name" class="mt-1 text-xs text-gray-600 italic hidden"></p>
                                </div>
                            </div>

                            <div class="mt-4 flex items-center">
                                <label for="rephrasing-toggle-cie2" class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" value="" id="rephrasing-toggle-cie2" class="sr-only peer">
                                    <div
                                        class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white peer-checked:bg-blue-600">
                                    </div>
                                    <span class="ms-3 text-sm font-medium text-gray-900">Enable Rephrasing (AI
                                        Feature)</span>
                                </label>
                            </div>

                            <button type="submit" id="parse-cie2-btn"
                                class="mt-6 px-6 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition duration-200">
                                Parse All Modules & Start QP Generation
                            </button>
                        </form>
                    </div>

                    <div id="upload-status" class="mt-3 text-sm font-medium"></div>
                </div>
            </div>

            <div id="qp-editor-canvas"
                class="hidden p-6 mt-8 border border-indigo-200 rounded-lg bg-indigo-50 gap-6 flex-grow">
                <h3 class="text-xl font-semibold mb-4 lg:hidden">Question Paper Editor</h3>

                <div class="qp-editor-flex-container flex-grow flex h-full">
                    <div id="left-pane"
                        class="p-4 border border-indigo-300 rounded-lg bg-white shadow-md flex flex-col h-full overflow-hidden"
                        style="flex: 1; min-width: 0;">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-semibold m-0">
                                Available Questions (Parsed & Custom)
                            </h4>
                            <button id="add-new-question-btn"
                                class="px-3 py-1 text-xs bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-200 flex-shrink-0">
                                <i class="fas fa-plus mr-1"></i> Add New
                            </button>
                        </div>
                        <div id="parsed-questions-list" class="flex-grow space-y-3 pr-2">
                            <p class="text-gray-500">Upload and parse a question bank or add new questions.</p>
                            <p>Left content line 1</p>
                            <p>Left content line 2</p>
                            <p>Left content line 3</p>
                            <p>Left content line 4</p>
                            <p>Left content line 5</p>
                            <p>Left content line 6</p>
                            <p>Left content line 7</p>
                            <p>Left content line 8</p>
                            <p>Left content line 9</p>
                            <p>Left content line 10</p>
                            <p>Left content line 11</p>
                            <p>Left content line 12</p>
                            <p>Left content line 13</p>
                            <p>Left content line 14</p>
                            <p>Left content line 15</p>
                            <p>Left content line 16</p>
                            <p>Left content line 17</p>
                            <p>Left content line 18</p>
                            <p>Left content line 19</p>
                            <p>Left content line 20</p>
                            <p>Left content line 21</p>
                            <p>Left content line 22</p>
                            <p>Left content line 23</p>
                            <p>Left content line 24</p>
                            <p>Left content line 25</p>
                            <p>Left content line 26</p>
                            <p>Left content line 27</p>
                            <p>Left content line 28</p>
                            <p>Left content line 29</p>
                            <p>Left content line 30</p>
                        </div>
                    </div>

                    <div id="splitter" class="splitter h-full"></div>

                    <div id="right-pane"
                        class="p-4 border border-indigo-300 rounded-lg bg-white shadow-md flex flex-col h-full overflow-hidden"
                        style="flex: 1; min-width: 0;">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-semibold m-0">
                                Question Paper Preview
                            </h4>
                            <span class="text-sm text-gray-600 flex-shrink-0">Total Marks: <span
                                    id="qp-current-total-marks" class="font-bold text-green-600">0</span> / <input
                                    type="number" id="overall-max-marks-input" value="100" min="1"
                                    class="qp-marks-input w-16 text-center">
                            </span>
                        </div>
                        <button id="add-main-question-btn"
                            class="mb-3 px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition duration-200 w-full">
                            <i class="fas fa-plus mr-1"></i> Add New Main Question
                        </button>

                        <!-- Question Source Selection -->
                        <div class="mb-3 p-3 bg-gray-50 rounded-md border">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-database mr-1"></i> Question Source for Auto-Generation
                            </label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="radio" name="question-source" value="latest" checked
                                        class="mr-2 text-green-600 focus:ring-green-500">
                                    <span class="text-sm">
                                        <strong>Latest Upload Only</strong> - Generate from most recently uploaded
                                        document
                                    </span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="question-source" value="all"
                                        class="mr-2 text-green-600 focus:ring-green-500">
                                    <span class="text-sm">
                                        <strong>All Uploads</strong> - Generate from all uploaded question banks
                                    </span>
                                </label>
                            </div>

                            <!-- Latest Upload Info -->
                            <div id="latest-upload-info"
                                class="mt-2 p-2 bg-blue-50 rounded text-xs text-blue-700 border border-blue-200">
                                <i class="fas fa-info-circle mr-1"></i>
                                <span id="latest-upload-text">Latest upload info will appear here after uploading a
                                    document</span>
                            </div>
                        </div>

                        <!-- Question Pattern Selection -->
                        <div class="mb-3 p-3 bg-blue-50 rounded-md border border-blue-200">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="fas fa-clipboard-list mr-1"></i> Question Paper Pattern
                            </label>
                            <select id="question-pattern-select"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="standard">Standard Pattern (4 Questions, 25 marks each)</option>
                                <option value="cie1">CIE1 Pattern (Modules 1,2,3 - Q1 OR Q2 from Module 1)</option>
                                <option value="cie2">CIE2 Pattern (Modules 3,4,5 - Q1 OR Q2 from Module 4)</option>
                            </select>
                            <div class="mt-2 text-xs text-gray-600">
                                <span id="pattern-description">Standard: 4 questions with 3 sub-questions each, covering
                                    all modules</span>
                            </div>
                        </div>

                        <button id="generate-questions-btn"
                            class="mb-4 px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition duration-200 w-full">
                            <i class="fas fa-magic mr-1"></i> Generate Questions (Auto)
                        </button>

                        <!-- Export Buttons (shown when paper is generated) -->
                        <div id="export-buttons" class="mb-4 hidden">
                            <div class="flex space-x-2">
                                <button id="export-docx-btn"
                                    class="flex-1 px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition duration-200">
                                    <i class="fas fa-file-word mr-1"></i> Export DOCX
                                </button>
                                <button id="export-pdf-btn"
                                    class="flex-1 px-4 py-2 bg-red-600 text-white font-semibold rounded-md hover:bg-red-700 transition duration-200">
                                    <i class="fas fa-file-pdf mr-1"></i> Export PDF
                                </button>
                            </div>
                        </div>

                        <!-- Approval System -->
                        <div id="approval-section" class="mb-4 hidden">
                            <div
                                class="bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-3">
                                    <h5 class="font-semibold text-purple-800">
                                        <i class="fas fa-clipboard-check mr-2"></i>Approval Status
                                    </h5>
                                    <span id="approval-status-badge" class="px-3 py-1 rounded-full text-xs font-medium">
                                        <!-- Status will be populated here -->
                                    </span>
                                </div>

                                <div id="approval-actions" class="space-y-2">
                                    <!-- Submit for Approval Button -->
                                    <button id="submit-approval-btn"
                                        class="w-full px-4 py-2 bg-purple-600 text-white font-semibold rounded-md hover:bg-purple-700 transition duration-200">
                                        <i class="fas fa-paper-plane mr-2"></i> Submit for HOD Approval
                                    </button>

                                    <!-- Approval Details (shown when submitted) -->
                                    <div id="approval-details" class="hidden text-sm text-gray-600">
                                        <div class="space-y-1">
                                            <div id="approval-submitted-at"></div>
                                            <div id="approval-approved-by"></div>
                                            <div id="approval-comments-display"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="qp-preview-list" class="flex-grow space-y-4 pr-2">
                            <p class="text-gray-500">Add main questions above or drag questions here to create new ones.
                            </p>
                            <p>Right content line A</p>
                            <p>Right content line B</p>
                            <p>Right content line C</p>
                            <p>Right content line D</p>
                            <p>Right content line E</p>
                            <p>Right content line F</p>
                            <p>Right content line G</p>
                            <p>Right content line H</p>
                            <p>Right content line I</p>
                            <p>Right content line J</p>
                            <p>Right content line K</p>
                            <p>Right content line L</p>
                            <p>Right content line M</p>
                            <p>Right content line N</p>
                            <p>Right content line O</p>
                            <p>Right content line P</p>
                            <p>Right content line Q</p>
                            <p>Right content line R</p>
                            <p>Right content line S</p>
                            <p>Right content line T</p>
                            <p>Right content line U</p>
                            <p>Right content line V</p>
                            <p>Right content line W</p>
                            <p>Right content line X</p>
                            <p>Right content line Y</p>
                            <p>Right content line Z</p>
                        </div>
                        <div class="mt-4 pt-4 border-t border-indigo-200 flex flex-col gap-3">
                            <!-- Save Question Paper Button -->
                            <button id="save-question-paper-btn"
                                class="w-full px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-700 transition duration-200">
                                <i class="fas fa-save mr-1"></i> Save Question Paper
                            </button>



                            <!-- Generate Buttons -->
                            <div class="flex gap-2">
                                <button id="generate-final-docx-btn"
                                    class="flex-1 px-4 py-2 bg-purple-600 text-white font-semibold rounded-md hover:bg-purple-700 transition duration-200">
                                    <i class="fas fa-file-word mr-1"></i> Generate DOCX
                                </button>
                                <button id="generate-final-pdf-btn"
                                    class="flex-1 px-4 py-2 bg-red-600 text-white font-semibold rounded-md hover:bg-red-700 transition duration-200">
                                    <i class="fas fa-file-pdf mr-1"></i> Generate PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="requirements-content" class="hidden p-6 mt-8 border border-purple-200 rounded-lg bg-purple-50">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-purple-800">Requirements for Question Paper</h3>
                    <div class="flex space-x-2">
                        <button id="load-template-btn"
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200">
                            <i class="fas fa-upload mr-2"></i>Load Template
                        </button>
                        <button id="save-template-btn"
                            class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-200">
                            <i class="fas fa-save mr-2"></i>Save Template
                        </button>
                    </div>
                </div>

                <!-- Requirements Form -->
                <form id="qp-requirements-form" class="space-y-8">
                    <!-- Basic Information Section -->
                    <div class="bg-white p-6 rounded-lg shadow-md border border-purple-100">
                        <h4 class="text-lg font-semibold text-purple-700 mb-4 flex items-center">
                            <i class="fas fa-info-circle mr-2"></i>Basic Information
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Subject Name *</label>
                                <input type="text" id="req-subject"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    placeholder="e.g., Design and Analysis of Algorithms" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Subject Code *</label>
                                <input type="text" id="req-subject-code"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    placeholder="e.g., CS701" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Department *</label>
                                <select id="req-department"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    required>
                                    <option value="">Select Department</option>
                                    <option value="CSE">Computer Science & Engineering</option>
                                    <option value="ECE">Electronics & Communication Engineering</option>
                                    <option value="ME">Mechanical Engineering</option>
                                    <option value="CE">Civil Engineering</option>
                                    <option value="EE">Electrical Engineering</option>
                                    <option value="IT">Information Technology</option>
                                    <option value="MBA">Master of Business Administration</option>
                                    <option value="MCA">Master of Computer Applications</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Semester *</label>
                                <select id="req-semester"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    required>
                                    <option value="">Select Semester</option>
                                    <option value="1">1st Semester</option>
                                    <option value="2">2nd Semester</option>
                                    <option value="3">3rd Semester</option>
                                    <option value="4">4th Semester</option>
                                    <option value="5">5th Semester</option>
                                    <option value="6">6th Semester</option>
                                    <option value="7">7th Semester</option>
                                    <option value="8">8th Semester</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Academic Year *</label>
                                <input type="text" id="req-academic-year"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    placeholder="e.g., 2024-25" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Exam Type *</label>
                                <select id="req-exam-type"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    required>
                                    <option value="">Select Exam Type</option>
                                    <option value="Mid-Term">Mid-Term Examination</option>
                                    <option value="End-Term">End-Term Examination</option>
                                    <option value="Supplementary">Supplementary Examination</option>
                                    <option value="Remedial">Remedial Examination</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Exam Details Section -->
                    <div class="bg-white p-6 rounded-lg shadow-md border border-purple-100">
                        <h4 class="text-lg font-semibold text-purple-700 mb-4 flex items-center">
                            <i class="fas fa-clock mr-2"></i>Exam Details
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Duration *</label>
                                <select id="req-duration"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    required>
                                    <option value="">Select Duration</option>
                                    <option value="2">2 Hours</option>
                                    <option value="3">3 Hours</option>
                                    <option value="4">4 Hours</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Total Marks *</label>
                                <select id="req-total-marks"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    required>
                                    <option value="">Select Total Marks</option>
                                    <option value="50">50 Marks</option>
                                    <option value="75">75 Marks</option>
                                    <option value="100">100 Marks</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                                <input type="date" id="req-exam-date"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Time</label>
                                <input type="time" id="req-exam-time"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                        </div>
                    </div>

                    <!-- Question Distribution Section -->
                    <div class="bg-white p-6 rounded-lg shadow-md border border-purple-100">
                        <h4 class="text-lg font-semibold text-purple-700 mb-4 flex items-center">
                            <i class="fas fa-chart-pie mr-2"></i>Question Distribution Rules
                        </h4>

                        <!-- Question Pattern -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Question Pattern *</label>
                            <select id="req-question-pattern"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                required>
                                <option value="">Select Pattern</option>
                                <option value="standard">Standard Pattern (4 Main Questions, 25 marks each)</option>
                                <option value="cie1">CIE1 Pattern (4 Questions, 25 marks each - Modules 1,2,3)</option>
                                <option value="cie2">CIE2 Pattern (4 Questions, 25 marks each - Modules 3,4,5)</option>
                                <option value="custom">Custom Pattern</option>
                            </select>
                        </div>

                        <!-- Module Distribution -->
                        <div class="mb-6">
                            <h5 class="text-md font-semibold text-gray-800 mb-3">Module Distribution</h5>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Number of Modules
                                        *</label>
                                    <select id="req-num-modules"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                        required>
                                        <option value="">Select</option>
                                        <option value="3">3 Modules</option>
                                        <option value="4">4 Modules</option>
                                        <option value="5">5 Modules</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Module Coverage
                                        *</label>
                                    <select id="req-module-coverage"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                        required>
                                        <option value="">Select Coverage</option>
                                        <option value="all">All Modules</option>
                                        <option value="selective">Selective Modules</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Distribution Rule
                                        *</label>
                                    <select id="req-distribution-rule"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                        required>
                                        <option value="">Select Rule</option>
                                        <option value="equal">Equal Distribution</option>
                                        <option value="weighted">Weighted Distribution</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Bloom's Taxonomy Distribution -->
                        <div class="mb-6">
                            <h5 class="text-md font-semibold text-gray-800 mb-3">Bloom's Taxonomy Distribution</h5>
                            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">L1 (Remember) %</label>
                                    <input type="number" id="req-l1-percent"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                        min="0" max="100" value="10">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">L2 (Understand)
                                        %</label>
                                    <input type="number" id="req-l2-percent"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                        min="0" max="100" value="20">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">L3 (Apply) %</label>
                                    <input type="number" id="req-l3-percent"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                        min="0" max="100" value="30">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">L4 (Analyze) %</label>
                                    <input type="number" id="req-l4-percent"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                        min="0" max="100" value="25">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">L5 (Evaluate) %</label>
                                    <input type="number" id="req-l5-percent"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                        min="0" max="100" value="10">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">L6 (Create) %</label>
                                    <input type="number" id="req-l6-percent"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                        min="0" max="100" value="5">
                                </div>
                            </div>
                            <div class="mt-2">
                                <span class="text-sm text-gray-600">Total: <span id="blooms-total"
                                        class="font-semibold">100</span>%</span>
                                <span id="blooms-validation" class="ml-4 text-sm"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Course Outcomes Mapping Section -->
                    <div class="bg-white p-6 rounded-lg shadow-md border border-purple-100">
                        <h4 class="text-lg font-semibold text-purple-700 mb-4 flex items-center">
                            <i class="fas fa-target mr-2"></i>Course Outcomes (CO) Mapping
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">CO1 Weight %</label>
                                <input type="number" id="req-co1-weight"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    min="0" max="100" value="20">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">CO2 Weight %</label>
                                <input type="number" id="req-co2-weight"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    min="0" max="100" value="20">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">CO3 Weight %</label>
                                <input type="number" id="req-co3-weight"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    min="0" max="100" value="20">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">CO4 Weight %</label>
                                <input type="number" id="req-co4-weight"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    min="0" max="100" value="20">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">CO5 Weight %</label>
                                <input type="number" id="req-co5-weight"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    min="0" max="100" value="20">
                            </div>
                        </div>
                        <div class="mt-2">
                            <span class="text-sm text-gray-600">Total CO Weight: <span id="co-total"
                                    class="font-semibold">100</span>%</span>
                            <span id="co-validation" class="ml-4 text-sm"></span>
                        </div>
                    </div>

                    <!-- Additional Requirements Section -->
                    <div class="bg-white p-6 rounded-lg shadow-md border border-purple-100">
                        <h4 class="text-lg font-semibold text-purple-700 mb-4 flex items-center">
                            <i class="fas fa-cogs mr-2"></i>Additional Requirements
                        </h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Question Selection
                                    Strategy</label>
                                <select id="req-selection-strategy"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <option value="random">Random Selection</option>
                                    <option value="balanced">Balanced Selection</option>
                                    <option value="difficulty">Difficulty-based Selection</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Difficulty Level</label>
                                <select id="req-difficulty-level"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <option value="mixed">Mixed Difficulty</option>
                                    <option value="easy">Easy</option>
                                    <option value="medium">Medium</option>
                                    <option value="hard">Hard</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Special Instructions</label>
                            <textarea id="req-special-instructions"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                rows="3"
                                placeholder="Any special instructions for question paper generation..."></textarea>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex justify-between items-center pt-6 border-t border-purple-200">
                        <div class="flex space-x-3">
                            <button type="button" id="validate-requirements-btn"
                                class="px-6 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 transition duration-200">
                                <i class="fas fa-check-circle mr-2"></i>Validate Requirements
                            </button>
                            <button type="button" id="reset-requirements-btn"
                                class="px-6 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition duration-200">
                                <i class="fas fa-undo mr-2"></i>Reset Form
                            </button>
                        </div>
                        <div class="flex space-x-3">
                            <button type="button" id="preview-requirements-btn"
                                class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200">
                                <i class="fas fa-eye mr-2"></i>Preview
                            </button>
                            <button type="submit" id="apply-requirements-btn"
                                class="px-6 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition duration-200">
                                <i class="fas fa-arrow-right mr-2"></i>Apply & Generate QP
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Requirements Summary Panel -->
                <div id="requirements-summary"
                    class="hidden mt-8 bg-white p-6 rounded-lg shadow-md border border-purple-100">
                    <h4 class="text-lg font-semibold text-purple-700 mb-4 flex items-center">
                        <i class="fas fa-clipboard-check mr-2"></i>Requirements Summary
                    </h4>
                    <div id="summary-content" class="space-y-3">
                        <!-- Summary content will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <div id="saved-content" class="hidden p-6 mt-8 border border-green-200 rounded-lg bg-green-50">
                <!-- Header Section -->
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-2xl font-bold text-green-800 flex items-center">
                            <i class="fas fa-save text-green-600 mr-3"></i>
                            Saved QPs & Banks
                        </h3>
                        <p class="text-green-600 mt-1">Manage your saved question papers and question banks</p>
                    </div>
                    <div class="flex space-x-3">
                        <button id="refresh-saved-btn"
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                        <button id="export-all-btn"
                            class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition duration-200">
                            <i class="fas fa-download mr-2"></i>Export All
                        </button>
                    </div>
                </div>

                <!-- Filter and Search Section -->
                <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                            <div class="relative">
                                <input type="text" id="saved-search"
                                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                                    placeholder="Search by name, subject, or type...">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            </div>
                        </div>
                        <div class="md:w-48">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Type</label>
                            <select id="saved-filter"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="all">All Items</option>
                                <option value="question-papers">Question Papers</option>
                                <option value="question-banks">Question Banks</option>
                                <option value="templates">Templates</option>
                            </select>
                        </div>
                        <div class="md:w-48">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sort by</label>
                            <select id="saved-sort"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="date-desc">Newest First</option>
                                <option value="date-asc">Oldest First</option>
                                <option value="name-asc">Name A-Z</option>
                                <option value="name-desc">Name Z-A</option>
                                <option value="size-desc">Largest First</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Statistics Overview -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg p-4 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm">Question Papers</p>
                                <p class="text-2xl font-bold" id="saved-qp-count">0</p>
                            </div>
                            <i class="fas fa-file-alt text-2xl text-blue-200"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg p-4 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm">Question Banks</p>
                                <p class="text-2xl font-bold" id="saved-bank-count">0</p>
                            </div>
                            <i class="fas fa-database text-2xl text-green-200"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg p-4 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100 text-sm">Templates</p>
                                <p class="text-2xl font-bold" id="saved-template-count">0</p>
                            </div>
                            <i class="fas fa-bookmark text-2xl text-purple-200"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-orange-500 to-orange-600 rounded-lg p-4 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-orange-100 text-sm">Total Size</p>
                                <p class="text-2xl font-bold" id="saved-total-size">0 MB</p>
                            </div>
                            <i class="fas fa-hdd text-2xl text-orange-200"></i>
                        </div>
                    </div>
                </div>

                <!-- Main Content Area -->
                <div class="bg-white rounded-lg shadow-md">
                    <!-- Tab Navigation -->
                    <div class="border-b border-gray-200">
                        <nav class="flex space-x-8 px-6 py-3">
                            <button
                                class="saved-tab-btn active border-b-2 border-green-500 text-green-600 font-medium py-2"
                                data-tab="all">
                                All Items (<span id="tab-all-count">0</span>)
                            </button>
                            <button
                                class="saved-tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium py-2"
                                data-tab="question-papers">
                                Question Papers (<span id="tab-qp-count">0</span>)
                            </button>
                            <button
                                class="saved-tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium py-2"
                                data-tab="question-banks">
                                Question Banks (<span id="tab-bank-count">0</span>)
                            </button>
                            <button
                                class="saved-tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium py-2"
                                data-tab="templates">
                                Templates (<span id="tab-template-count">0</span>)
                            </button>
                        </nav>
                    </div>

                    <!-- Content List -->
                    <div class="p-6">
                        <!-- Loading State -->
                        <div id="saved-loading" class="hidden text-center py-8">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-green-600">
                            </div>
                            <p class="mt-2 text-gray-600">Loading saved items...</p>
                        </div>

                        <!-- Empty State -->
                        <div id="saved-empty" class="hidden text-center py-12">
                            <div class="mx-auto h-24 w-24 text-gray-400 mb-4">
                                <i class="fas fa-folder-open text-6xl"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No saved items found</h3>
                            <p class="text-gray-500 mb-6">Start creating question papers and they'll appear here</p>
                            <button
                                class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-200"
                                onclick="showContent(newQpCanvas, 'New Question Paper')">
                                <i class="fas fa-plus mr-2"></i>Create New Question Paper
                            </button>
                        </div>

                        <!-- Items List -->
                        <div id="saved-items-list" class="space-y-4">
                            <!-- Items will be populated by JavaScript -->
                        </div>

                        <!-- Pagination -->
                        <div id="saved-pagination"
                            class="hidden justify-between items-center mt-6 pt-6 border-t border-gray-200">
                            <div class="text-sm text-gray-700">
                                Showing <span id="pagination-start">1</span> to <span id="pagination-end">10</span> of
                                <span id="pagination-total">0</span> results
                            </div>
                            <div class="flex space-x-2">
                                <button id="pagination-prev"
                                    class="px-3 py-1 border border-gray-300 rounded-md text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i class="fas fa-chevron-left mr-1"></i>Previous
                                </button>
                                <div id="pagination-numbers" class="flex space-x-1">
                                    <!-- Page numbers will be populated by JavaScript -->
                                </div>
                                <button id="pagination-next"
                                    class="px-3 py-1 border border-gray-300 rounded-md text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                    Next<i class="fas fa-chevron-right ml-1"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Dialogs -->
                <!-- View Details Modal -->
                <div id="view-modal"
                    class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
                    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                        <div class="flex justify-between items-center p-6 border-b border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-900" id="view-modal-title">Item Details</h3>
                            <button class="text-gray-400 hover:text-gray-600" onclick="closeModal('view-modal')">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="p-6 overflow-y-auto max-h-[70vh]" id="view-modal-content">
                            <!-- Content will be populated by JavaScript -->
                        </div>
                        <div class="flex justify-end space-x-3 p-6 border-t border-gray-200">
                            <button
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition duration-200"
                                onclick="closeModal('view-modal')">
                                Close
                            </button>
                            <button id="view-modal-action"
                                class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-200">
                                Use This Item
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Delete Confirmation Modal -->
                <div id="delete-modal"
                    class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
                    <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                        <div class="p-6">
                            <div class="flex items-center mb-4">
                                <div class="bg-red-100 rounded-full p-3 mr-4">
                                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">Confirm Deletion</h3>
                                    <p class="text-gray-600">This action cannot be undone.</p>
                                </div>
                            </div>
                            <p class="text-gray-700 mb-6" id="delete-modal-message">
                                Are you sure you want to delete this item?
                            </p>
                            <div class="flex justify-end space-x-3">
                                <button
                                    class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition duration-200"
                                    onclick="closeModal('delete-modal')">
                                    Cancel
                                </button>
                                <button id="confirm-delete-btn"
                                    class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-200">
                                    <i class="fas fa-trash mr-2"></i>Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Export Options Modal -->
                <div id="export-modal"
                    class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
                    <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                        <div class="flex justify-between items-center p-6 border-b border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-900">Export Options</h3>
                            <button class="text-gray-400 hover:text-gray-600" onclick="closeModal('export-modal')">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="p-6">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Export Format</label>
                                    <select id="export-format"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                        <option value="json">JSON (Complete Data)</option>
                                        <option value="csv">CSV (Summary)</option>
                                        <option value="pdf">PDF (Formatted)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Include</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center">
                                            <input type="checkbox" id="export-qp" class="mr-2" checked>
                                            <span class="text-sm">Question Papers</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="export-banks" class="mr-2" checked>
                                            <span class="text-sm">Question Banks</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="export-templates" class="mr-2" checked>
                                            <span class="text-sm">Templates</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 p-6 border-t border-gray-200">
                            <button
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition duration-200"
                                onclick="closeModal('export-modal')">
                                Cancel
                            </button>
                            <button id="confirm-export-btn"
                                class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-200">
                                <i class="fas fa-download mr-2"></i>Export
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Approval Submission Modal -->
                <div id="approval-modal"
                    class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
                    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full">
                        <div class="flex justify-between items-center p-6 border-b border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-900">
                                <i class="fas fa-paper-plane mr-2 text-purple-600"></i>Submit for Approval
                            </h3>
                            <button class="text-gray-400 hover:text-gray-600" onclick="closeModal('approval-modal')">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="p-6">
                            <div class="space-y-4">
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <div class="flex items-center">
                                        <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                                        <p class="text-sm text-blue-800">
                                            Your question paper will be submitted to the HOD for review and approval.
                                        </p>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Comments
                                        (Optional)</label>
                                    <textarea id="approval-comments" rows="4"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                        placeholder="Add any additional comments or notes for the HOD..."></textarea>
                                </div>

                                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                    <div class="flex items-start">
                                        <i class="fas fa-clock text-yellow-600 mr-2 mt-0.5"></i>
                                        <div class="text-sm text-yellow-800">
                                            <p class="font-medium">Expected Review Time:</p>
                                            <p>2-3 business days for standard review</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 p-6 border-t border-gray-200">
                            <button onclick="closeModal('approval-modal')"
                                class="px-4 py-2 text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 transition duration-200">
                                Cancel
                            </button>
                            <button id="confirm-approval-btn"
                                class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition duration-200">
                                <i class="fas fa-paper-plane mr-2"></i>Submit for Approval
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="recent-content" class="hidden p-6 mt-8 border border-yellow-200 rounded-lg bg-yellow-50">
                <!-- Header Section -->
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-2xl font-bold text-yellow-800 flex items-center">
                            <i class="fas fa-history text-yellow-600 mr-3"></i>
                            Recent Generated QPs
                        </h3>
                        <p class="text-yellow-600 mt-1">View and manage your recently generated question papers</p>
                    </div>
                    <div class="flex space-x-3">
                        <button id="refresh-recent-btn"
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                        <button id="clear-history-btn"
                            class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-200">
                            <i class="fas fa-trash mr-2"></i>Clear History
                        </button>
                        <button id="export-recent-btn"
                            class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition duration-200">
                            <i class="fas fa-download mr-2"></i>Export List
                        </button>
                    </div>
                </div>

                <!-- Filter and Search Section -->
                <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Search Recent QPs</label>
                            <div class="relative">
                                <input type="text" id="recent-search"
                                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                    placeholder="Search by name, subject, or date...">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            </div>
                        </div>
                        <div class="md:w-48">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Time Period</label>
                            <select id="recent-period-filter"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500">
                                <option value="all">All Time</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="quarter">Last 3 Months</option>
                            </select>
                        </div>
                        <div class="md:w-48">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                            <select id="recent-status-filter"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500">
                                <option value="all">All Status</option>
                                <option value="success">Successfully Generated</option>
                                <option value="downloaded">Downloaded</option>
                                <option value="shared">Shared</option>
                                <option value="archived">Archived</option>
                            </select>
                        </div>
                        <div class="md:w-48">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sort by</label>
                            <select id="recent-sort"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500">
                                <option value="date-desc">Newest First</option>
                                <option value="date-asc">Oldest First</option>
                                <option value="name-asc">Name A-Z</option>
                                <option value="name-desc">Name Z-A</option>
                                <option value="downloads-desc">Most Downloaded</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Statistics Overview -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-lg p-4 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-yellow-100 text-sm">Total Generated</p>
                                <p class="text-2xl font-bold" id="recent-total-count">0</p>
                            </div>
                            <i class="fas fa-file-alt text-2xl text-yellow-200"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg p-4 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm">This Week</p>
                                <p class="text-2xl font-bold" id="recent-week-count">0</p>
                            </div>
                            <i class="fas fa-calendar-week text-2xl text-green-200"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg p-4 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm">Downloaded</p>
                                <p class="text-2xl font-bold" id="recent-downloaded-count">0</p>
                            </div>
                            <i class="fas fa-download text-2xl text-blue-200"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg p-4 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100 text-sm">Success Rate</p>
                                <p class="text-2xl font-bold" id="recent-success-rate">100%</p>
                            </div>
                            <i class="fas fa-chart-line text-2xl text-purple-200"></i>
                        </div>
                    </div>
                </div>

                <!-- View Toggle -->
                <div class="bg-white rounded-lg shadow-md mb-6">
                    <div class="border-b border-gray-200 px-6 py-3">
                        <div class="flex justify-between items-center">
                            <h4 class="text-lg font-semibold text-gray-900">Recent Question Papers</h4>
                            <div class="flex space-x-2">
                                <button id="list-view-btn"
                                    class="view-toggle-btn active px-3 py-1 text-sm bg-yellow-600 text-white rounded-md hover:bg-yellow-700 transition duration-200">
                                    <i class="fas fa-list mr-1"></i>List View
                                </button>
                                <button id="timeline-view-btn"
                                    class="view-toggle-btn px-3 py-1 text-sm bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition duration-200">
                                    <i class="fas fa-clock mr-1"></i>Timeline View
                                </button>
                                <button id="grid-view-btn"
                                    class="view-toggle-btn px-3 py-1 text-sm bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition duration-200">
                                    <i class="fas fa-th-large mr-1"></i>Grid View
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Content Area -->
                    <div class="p-6">
                        <!-- Loading State -->
                        <div id="recent-loading" class="hidden text-center py-8">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-yellow-600">
                            </div>
                            <p class="mt-2 text-gray-600">Loading recent question papers...</p>
                        </div>

                        <!-- Empty State -->
                        <div id="recent-empty" class="hidden text-center py-12">
                            <div class="mx-auto h-24 w-24 text-gray-400 mb-4">
                                <i class="fas fa-file-alt text-6xl"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No recent question papers</h3>
                            <p class="text-gray-500 mb-6">Generate your first question paper to see it here</p>
                            <button
                                class="px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 transition duration-200"
                                onclick="showContent(newQpCanvas, 'New Question Paper')">
                                <i class="fas fa-plus mr-2"></i>Generate Question Paper
                            </button>
                        </div>

                        <!-- List View -->
                        <div id="recent-list-view" class="space-y-4">
                            <!-- Items will be populated by JavaScript -->
                        </div>

                        <!-- Timeline View -->
                        <div id="recent-timeline-view" class="hidden">
                            <div class="relative">
                                <!-- Timeline line -->
                                <div class="absolute left-8 top-0 bottom-0 w-0.5 bg-gray-300"></div>
                                <!-- Timeline items will be populated by JavaScript -->
                                <div id="recent-timeline-items" class="space-y-6">
                                    <!-- Timeline items will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>

                        <!-- Grid View -->
                        <div id="recent-grid-view" class="hidden grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Grid items will be populated by JavaScript -->
                        </div>

                        <!-- Pagination -->
                        <div id="recent-pagination"
                            class="hidden justify-between items-center mt-6 pt-6 border-t border-gray-200">
                            <div class="text-sm text-gray-700">
                                Showing <span id="recent-pagination-start">1</span> to <span
                                    id="recent-pagination-end">10</span> of <span id="recent-pagination-total">0</span>
                                results
                            </div>
                            <div class="flex space-x-2">
                                <button id="recent-pagination-prev"
                                    class="px-3 py-1 border border-gray-300 rounded-md text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i class="fas fa-chevron-left mr-1"></i>Previous
                                </button>
                                <div id="recent-pagination-numbers" class="flex space-x-1">
                                    <!-- Page numbers will be populated by JavaScript -->
                                </div>
                                <button id="recent-pagination-next"
                                    class="px-3 py-1 border border-gray-300 rounded-md text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                    Next<i class="fas fa-chevron-right ml-1"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Dialogs -->
                <!-- View QP Details Modal -->
                <div id="recent-view-modal"
                    class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
                    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                        <div class="flex justify-between items-center p-6 border-b border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-900" id="recent-view-modal-title">Question Paper
                                Details</h3>
                            <button class="text-gray-400 hover:text-gray-600"
                                onclick="closeRecentModal('recent-view-modal')">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="p-6 overflow-y-auto max-h-[70vh]" id="recent-view-modal-content">
                            <!-- Content will be populated by JavaScript -->
                        </div>
                        <div class="flex justify-end space-x-3 p-6 border-t border-gray-200">
                            <button
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition duration-200"
                                onclick="closeRecentModal('recent-view-modal')">
                                Close
                            </button>
                            <button id="recent-view-modal-download"
                                class="px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 transition duration-200">
                                <i class="fas fa-download mr-2"></i>Download
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Share Modal -->
                <div id="recent-share-modal"
                    class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
                    <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                        <div class="flex justify-between items-center p-6 border-b border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-900">Share Question Paper</h3>
                            <button class="text-gray-400 hover:text-gray-600"
                                onclick="closeRecentModal('recent-share-modal')">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="p-6">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Share Link</label>
                                    <div class="flex">
                                        <input type="text" id="share-link-input"
                                            class="flex-1 px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                            readonly>
                                        <button id="copy-link-btn"
                                            class="px-4 py-2 bg-yellow-600 text-white rounded-r-md hover:bg-yellow-700 transition duration-200">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Share via</label>
                                    <div class="flex space-x-2">
                                        <button
                                            class="share-btn flex-1 px-3 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200"
                                            data-platform="email">
                                            <i class="fas fa-envelope mr-2"></i>Email
                                        </button>
                                        <button
                                            class="share-btn flex-1 px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-200"
                                            data-platform="whatsapp">
                                            <i class="fab fa-whatsapp mr-2"></i>WhatsApp
                                        </button>
                                        <button
                                            class="share-btn flex-1 px-3 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-200"
                                            data-platform="twitter">
                                            <i class="fab fa-twitter mr-2"></i>Twitter
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 p-6 border-t border-gray-200">
                            <button
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition duration-200"
                                onclick="closeRecentModal('recent-share-modal')">
                                Close
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Rename Modal -->
                <div id="recent-rename-modal"
                    class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
                    <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                        <div class="flex justify-between items-center p-6 border-b border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-900">Rename Question Paper</h3>
                            <button class="text-gray-400 hover:text-gray-600"
                                onclick="closeRecentModal('recent-rename-modal')">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="p-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">New Name</label>
                                <input type="text" id="rename-input"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                    placeholder="Enter new name...">
                            </div>
                        </div>
                        <div class="flex justify-end space-x-3 p-6 border-t border-gray-200">
                            <button
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition duration-200"
                                onclick="closeRecentModal('recent-rename-modal')">
                                Cancel
                            </button>
                            <button id="confirm-rename-btn"
                                class="px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 transition duration-200">
                                <i class="fas fa-save mr-2"></i>Save
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Delete Confirmation Modal -->
                <div id="recent-delete-modal"
                    class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
                    <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                        <div class="p-6">
                            <div class="flex items-center mb-4">
                                <div class="bg-red-100 rounded-full p-3 mr-4">
                                    <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">Confirm Deletion</h3>
                                    <p class="text-gray-600">This action cannot be undone.</p>
                                </div>
                            </div>
                            <p class="text-gray-700 mb-6" id="recent-delete-modal-message">
                                Are you sure you want to delete this question paper?
                            </p>
                            <div class="flex justify-end space-x-3">
                                <button
                                    class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400 transition duration-200"
                                    onclick="closeRecentModal('recent-delete-modal')">
                                    Cancel
                                </button>
                                <button id="recent-confirm-delete-btn"
                                    class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-200">
                                    <i class="fas fa-trash mr-2"></i>Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="settings-content" class="hidden p-6 mt-8 border border-gray-200 rounded-lg bg-gray-50">
                <!-- Header Section -->
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800 flex items-center">
                            <i class="fas fa-cog text-gray-600 mr-3"></i>
                            Settings & Preferences
                        </h3>
                        <p class="text-gray-600 mt-1">Customize your SmartQPGen experience</p>
                    </div>
                    <div class="flex space-x-3">
                        <button id="reset-settings-btn"
                            class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-200">
                            <i class="fas fa-undo mr-2"></i>Reset All
                        </button>
                        <button id="export-settings-btn"
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200">
                            <i class="fas fa-download mr-2"></i>Export Settings
                        </button>
                    </div>
                </div>

                <!-- Settings Tabs -->
                <div class="bg-white rounded-lg shadow-md mb-6">
                    <div class="border-b border-gray-200">
                        <nav class="flex space-x-8 px-6 py-3">
                            <button
                                class="settings-tab-btn active border-b-2 border-gray-500 text-gray-600 font-medium py-2"
                                data-tab="general">
                                <i class="fas fa-sliders-h mr-2"></i>General
                            </button>
                            <button
                                class="settings-tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium py-2"
                                data-tab="appearance">
                                <i class="fas fa-palette mr-2"></i>Appearance
                            </button>
                            <button
                                class="settings-tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium py-2"
                                data-tab="generation">
                                <i class="fas fa-file-alt mr-2"></i>Generation
                            </button>
                            <button
                                class="settings-tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium py-2"
                                data-tab="data">
                                <i class="fas fa-database mr-2"></i>Data & Storage
                            </button>
                            <button
                                class="settings-tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium py-2"
                                data-tab="advanced">
                                <i class="fas fa-cogs mr-2"></i>Advanced
                            </button>
                        </nav>
                    </div>

                    <!-- General Settings Tab -->
                    <div id="settings-general-tab" class="settings-tab-content p-6">
                        <div class="space-y-6">
                            <!-- User Preferences -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                    <i class="fas fa-user-cog text-gray-600 mr-2"></i>
                                    User Preferences
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Default
                                            Subject</label>
                                        <input type="text" id="default-subject"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500"
                                            placeholder="Enter default subject">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Default
                                            Department</label>
                                        <input type="text" id="default-department"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500"
                                            placeholder="Enter default department">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Default
                                            Semester</label>
                                        <select id="default-semester"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500">
                                            <option value="">Select semester</option>
                                            <option value="1">Semester 1</option>
                                            <option value="2">Semester 2</option>
                                            <option value="3">Semester 3</option>
                                            <option value="4">Semester 4</option>
                                            <option value="5">Semester 5</option>
                                            <option value="6">Semester 6</option>
                                            <option value="7">Semester 7</option>
                                            <option value="8">Semester 8</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Academic
                                            Year</label>
                                        <input type="text" id="default-academic-year"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500"
                                            placeholder="e.g., 2024-25">
                                    </div>
                                </div>
                            </div>

                            <!-- Notification Settings -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                    <i class="fas fa-bell text-gray-600 mr-2"></i>
                                    Notifications
                                </h4>
                                <div class="space-y-3">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="notify-generation-complete" class="mr-3 rounded">
                                        <span class="text-sm">Notify when question paper generation is complete</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="notify-save-success" class="mr-3 rounded">
                                        <span class="text-sm">Notify when items are saved successfully</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="notify-errors" class="mr-3 rounded">
                                        <span class="text-sm">Show error notifications</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="notify-tips" class="mr-3 rounded">
                                        <span class="text-sm">Show helpful tips and suggestions</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Auto-save Settings -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                    <i class="fas fa-save text-gray-600 mr-2"></i>
                                    Auto-save & Backup
                                </h4>
                                <div class="space-y-3">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="auto-save-enabled" class="mr-3 rounded">
                                        <span class="text-sm">Enable auto-save for question papers</span>
                                    </label>
                                    <div class="ml-6">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Auto-save
                                            interval</label>
                                        <select id="auto-save-interval"
                                            class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500">
                                            <option value="30">30 seconds</option>
                                            <option value="60">1 minute</option>
                                            <option value="300">5 minutes</option>
                                            <option value="600">10 minutes</option>
                                        </select>
                                    </div>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="backup-to-cloud" class="mr-3 rounded">
                                        <span class="text-sm">Backup data to cloud storage (when available)</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Appearance Settings Tab -->
                    <div id="settings-appearance-tab" class="settings-tab-content hidden p-6">
                        <div class="space-y-6">
                            <!-- Theme Settings -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                    <i class="fas fa-moon text-gray-600 mr-2"></i>
                                    Theme & Display
                                </h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-3">Theme Mode</label>
                                        <div class="flex items-center space-x-6">
                                            <label class="flex items-center cursor-pointer">
                                                <input type="radio" name="theme-mode" value="light" class="mr-2">
                                                <i class="fas fa-sun text-yellow-500 mr-2"></i>
                                                <span class="text-sm">Light Mode</span>
                                            </label>
                                            <label class="flex items-center cursor-pointer">
                                                <input type="radio" name="theme-mode" value="dark" class="mr-2">
                                                <i class="fas fa-moon text-blue-500 mr-2"></i>
                                                <span class="text-sm">Dark Mode</span>
                                            </label>
                                            <label class="flex items-center cursor-pointer">
                                                <input type="radio" name="theme-mode" value="auto" class="mr-2">
                                                <i class="fas fa-adjust text-gray-500 mr-2"></i>
                                                <span class="text-sm">Auto (System)</span>
                                            </label>
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Font Size</label>
                                        <select id="font-size-setting"
                                            class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500">
                                            <option value="small">Small</option>
                                            <option value="medium">Medium (Default)</option>
                                            <option value="large">Large</option>
                                            <option value="extra-large">Extra Large</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Sidebar
                                            Width</label>
                                        <select id="sidebar-width-setting"
                                            class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500">
                                            <option value="narrow">Narrow</option>
                                            <option value="normal">Normal (Default)</option>
                                            <option value="wide">Wide</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Animation Settings -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                    <i class="fas fa-magic text-gray-600 mr-2"></i>
                                    Animations & Effects
                                </h4>
                                <div class="space-y-3">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="enable-animations" class="mr-3 rounded">
                                        <span class="text-sm">Enable smooth animations and transitions</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="enable-hover-effects" class="mr-3 rounded">
                                        <span class="text-sm">Enable hover effects on buttons and cards</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="enable-loading-animations" class="mr-3 rounded">
                                        <span class="text-sm">Show loading animations</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="reduce-motion" class="mr-3 rounded">
                                        <span class="text-sm">Reduce motion (accessibility)</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Color Customization -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                    <i class="fas fa-palette text-gray-600 mr-2"></i>
                                    Color Customization
                                </h4>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Primary
                                            Color</label>
                                        <div class="flex space-x-2">
                                            <input type="color" id="primary-color"
                                                class="w-12 h-8 border border-gray-300 rounded cursor-pointer"
                                                value="#3B82F6">
                                            <input type="text"
                                                class="flex-1 px-2 py-1 text-xs border border-gray-300 rounded"
                                                value="#3B82F6" readonly>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Accent Color</label>
                                        <div class="flex space-x-2">
                                            <input type="color" id="accent-color"
                                                class="w-12 h-8 border border-gray-300 rounded cursor-pointer"
                                                value="#10B981">
                                            <input type="text"
                                                class="flex-1 px-2 py-1 text-xs border border-gray-300 rounded"
                                                value="#10B981" readonly>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Warning
                                            Color</label>
                                        <div class="flex space-x-2">
                                            <input type="color" id="warning-color"
                                                class="w-12 h-8 border border-gray-300 rounded cursor-pointer"
                                                value="#F59E0B">
                                            <input type="text"
                                                class="flex-1 px-2 py-1 text-xs border border-gray-300 rounded"
                                                value="#F59E0B" readonly>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Danger Color</label>
                                        <div class="flex space-x-2">
                                            <input type="color" id="danger-color"
                                                class="w-12 h-8 border border-gray-300 rounded cursor-pointer"
                                                value="#EF4444">
                                            <input type="text"
                                                class="flex-1 px-2 py-1 text-xs border border-gray-300 rounded"
                                                value="#EF4444" readonly>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <button id="reset-colors-btn"
                                        class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition duration-200">
                                        <i class="fas fa-undo mr-2"></i>Reset to Default Colors
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Generation Settings Tab -->
                    <div id="settings-generation-tab" class="settings-tab-content hidden p-6">
                        <div class="space-y-6">
                            <!-- Default Generation Settings -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                    <i class="fas fa-file-alt text-gray-600 mr-2"></i>
                                    Default Generation Settings
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Default Total
                                            Marks</label>
                                        <input type="number" id="default-total-marks"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500"
                                            value="100" min="1" max="1000">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Default Duration
                                            (hours)</label>
                                        <input type="number" id="default-duration"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500"
                                            value="3" min="1" max="8" step="0.5">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Default Selection
                                            Strategy</label>
                                        <select id="default-selection-strategy"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500">
                                            <option value="balanced">Balanced Selection</option>
                                            <option value="random">Random Selection</option>
                                            <option value="difficulty-based">Difficulty-based</option>
                                            <option value="co-based">CO-based</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Default Difficulty
                                            Level</label>
                                        <select id="default-difficulty"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500">
                                            <option value="mixed">Mixed Difficulty</option>
                                            <option value="easy">Easy</option>
                                            <option value="medium">Medium</option>
                                            <option value="hard">Hard</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Question Paper Format -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                    <i class="fas fa-file-pdf text-gray-600 mr-2"></i>
                                    Question Paper Format
                                </h4>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Default Export
                                            Format</label>
                                        <div class="flex space-x-4">
                                            <label class="flex items-center">
                                                <input type="radio" name="default-format" value="docx" class="mr-2">
                                                <i class="fas fa-file-word text-blue-600 mr-2"></i>
                                                <span class="text-sm">DOCX</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="radio" name="default-format" value="pdf" class="mr-2">
                                                <i class="fas fa-file-pdf text-red-600 mr-2"></i>
                                                <span class="text-sm">PDF</span>
                                            </label>
                                            <label class="flex items-center">
                                                <input type="radio" name="default-format" value="both" class="mr-2">
                                                <i class="fas fa-files text-gray-600 mr-2"></i>
                                                <span class="text-sm">Both</span>
                                            </label>
                                        </div>
                                    </div>

                                    <div class="space-y-3">
                                        <label class="flex items-center">
                                            <input type="checkbox" id="include-header" class="mr-3 rounded">
                                            <span class="text-sm">Include header with institution details</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="include-instructions" class="mr-3 rounded">
                                            <span class="text-sm">Include general instructions</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="include-marking-scheme" class="mr-3 rounded">
                                            <span class="text-sm">Include marking scheme</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="checkbox" id="number-questions" class="mr-3 rounded">
                                            <span class="text-sm">Auto-number questions</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Validation Settings -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                    <i class="fas fa-check-circle text-gray-600 mr-2"></i>
                                    Validation & Quality Control
                                </h4>
                                <div class="space-y-3">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="validate-blooms-taxonomy" class="mr-3 rounded">
                                        <span class="text-sm">Validate Bloom's Taxonomy distribution</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="validate-co-coverage" class="mr-3 rounded">
                                        <span class="text-sm">Validate Course Outcome coverage</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="validate-difficulty-balance" class="mr-3 rounded">
                                        <span class="text-sm">Validate difficulty level balance</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="check-duplicate-questions" class="mr-3 rounded">
                                        <span class="text-sm">Check for duplicate questions</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="validate-total-marks" class="mr-3 rounded">
                                        <span class="text-sm">Validate total marks calculation</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Settings Tab -->
                    <div id="settings-advanced-tab" class="settings-tab-content hidden p-6">
                        <div class="space-y-6">
                            <!-- Developer Options -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                    <i class="fas fa-code text-gray-600 mr-2"></i>
                                    Developer Options
                                </h4>
                                <div class="space-y-3">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="enable-debug-mode" class="mr-3 rounded">
                                        <span class="text-sm">Enable debug mode (shows console logs)</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="show-performance-metrics" class="mr-3 rounded">
                                        <span class="text-sm">Show performance metrics</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="enable-experimental-features" class="mr-3 rounded">
                                        <span class="text-sm">Enable experimental features</span>
                                    </label>
                                </div>
                            </div>

                            <!-- System Information -->
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                    <i class="fas fa-info-circle text-gray-600 mr-2"></i>
                                    System Information
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <dl class="space-y-2">
                                            <div class="flex justify-between">
                                                <dt class="text-gray-600">Version:</dt>
                                                <dd class="font-medium">SmartQPGen v2.0.0</dd>
                                            </div>
                                            <div class="flex justify-between">
                                                <dt class="text-gray-600">Browser:</dt>
                                                <dd class="font-medium" id="browser-info">Loading...</dd>
                                            </div>
                                            <div class="flex justify-between">
                                                <dt class="text-gray-600">Screen Resolution:</dt>
                                                <dd class="font-medium" id="screen-resolution">Loading...</dd>
                                            </div>
                                        </dl>
                                    </div>
                                    <div>
                                        <dl class="space-y-2">
                                            <div class="flex justify-between">
                                                <dt class="text-gray-600">Local Storage:</dt>
                                                <dd class="font-medium" id="storage-support">Supported</dd>
                                            </div>
                                            <div class="flex justify-between">
                                                <dt class="text-gray-600">Last Updated:</dt>
                                                <dd class="font-medium" id="last-updated">Loading...</dd>
                                            </div>
                                            <div class="flex justify-between">
                                                <dt class="text-gray-600">Session Duration:</dt>
                                                <dd class="font-medium" id="session-duration">Loading...</dd>
                                            </div>
                                        </dl>
                                    </div>
                                </div>
                            </div>

                            <!-- Reset Options -->
                            <div class="bg-red-50 rounded-lg p-4 border border-red-200">
                                <h4 class="text-lg font-semibold text-red-900 mb-4 flex items-center">
                                    <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                                    Reset Options
                                </h4>
                                <div class="space-y-3">
                                    <p class="text-sm text-red-700">These actions cannot be undone. Please proceed with
                                        caution.</p>
                                    <div class="flex flex-wrap gap-3">
                                        <button id="reset-settings-only-btn"
                                            class="px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 transition duration-200">
                                            <i class="fas fa-undo mr-2"></i>Reset Settings Only
                                        </button>
                                        <button id="reset-data-only-btn"
                                            class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 transition duration-200">
                                            <i class="fas fa-database mr-2"></i>Reset Data Only
                                        </button>
                                        <button id="factory-reset-btn"
                                            class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-200">
                                            <i class="fas fa-exclamation-triangle mr-2"></i>Factory Reset
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="help-content" class="hidden p-6 mt-8 border border-orange-200 rounded-lg bg-orange-50">
                <!-- Header Section -->
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-2xl font-bold text-orange-800 flex items-center">
                            <i class="fas fa-question-circle text-orange-600 mr-3"></i>
                            Help & Documentation
                        </h3>
                        <p class="text-orange-600 mt-1">Complete guide to using SmartQPGen effectively</p>
                    </div>
                    <div class="flex space-x-3">
                        <button id="help-search-btn"
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200">
                            <i class="fas fa-search mr-2"></i>Search Help
                        </button>
                        <button id="help-print-btn"
                            class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-200">
                            <i class="fas fa-print mr-2"></i>Print Guide
                        </button>
                    </div>
                </div>

                <!-- Search Box -->
                <div class="bg-white p-4 rounded-lg shadow-md mb-6 hidden" id="help-search-box">
                    <div class="relative">
                        <input type="text" id="help-search-input"
                            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                            placeholder="Search help topics...">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                    <div id="help-search-results" class="mt-4 hidden">
                        <!-- Search results will be populated here -->
                    </div>
                </div>

                <!-- Help Navigation -->
                <div class="bg-white rounded-lg shadow-md mb-6">
                    <div class="border-b border-gray-200">
                        <nav class="flex space-x-8 px-6 py-3">
                            <button
                                class="help-tab-btn active border-b-2 border-orange-500 text-orange-600 font-medium py-2"
                                data-tab="getting-started">
                                <i class="fas fa-play mr-2"></i>Getting Started
                            </button>
                            <button
                                class="help-tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium py-2"
                                data-tab="features">
                                <i class="fas fa-star mr-2"></i>Features
                            </button>
                            <button
                                class="help-tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium py-2"
                                data-tab="tutorials">
                                <i class="fas fa-graduation-cap mr-2"></i>Tutorials
                            </button>
                            <button
                                class="help-tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium py-2"
                                data-tab="faq">
                                <i class="fas fa-question mr-2"></i>FAQ
                            </button>
                            <button
                                class="help-tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium py-2"
                                data-tab="troubleshooting">
                                <i class="fas fa-wrench mr-2"></i>Troubleshooting
                            </button>
                        </nav>
                    </div>

                    <!-- Getting Started Tab -->
                    <div id="help-getting-started-tab" class="help-tab-content p-6">
                        <div class="space-y-6">
                            <!-- Welcome Section -->
                            <div class="bg-gradient-to-r from-orange-100 to-yellow-100 rounded-lg p-6">
                                <h4 class="text-xl font-bold text-orange-900 mb-4 flex items-center">
                                    <i class="fas fa-rocket text-orange-600 mr-2"></i>
                                    Welcome to SmartQPGen!
                                </h4>
                                <p class="text-orange-800 mb-4">
                                    SmartQPGen is an intelligent question paper generation system that helps educators
                                    create balanced,
                                    high-quality question papers efficiently. Whether you're a teacher, professor, or
                                    educational administrator,
                                    this tool streamlines the entire process from question bank management to final
                                    paper generation.
                                </p>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                                    <div class="bg-white rounded-lg p-4 shadow-sm">
                                        <i class="fas fa-upload text-blue-500 text-2xl mb-2"></i>
                                        <h5 class="font-semibold text-gray-800">1. Upload Questions</h5>
                                        <p class="text-sm text-gray-600">Start by uploading your question bank or
                                            creating questions manually</p>
                                    </div>
                                    <div class="bg-white rounded-lg p-4 shadow-sm">
                                        <i class="fas fa-cogs text-green-500 text-2xl mb-2"></i>
                                        <h5 class="font-semibold text-gray-800">2. Set Requirements</h5>
                                        <p class="text-sm text-gray-600">Define your question paper requirements and
                                            constraints</p>
                                    </div>
                                    <div class="bg-white rounded-lg p-4 shadow-sm">
                                        <i class="fas fa-file-alt text-purple-500 text-2xl mb-2"></i>
                                        <h5 class="font-semibold text-gray-800">3. Generate Paper</h5>
                                        <p class="text-sm text-gray-600">Let AI create a balanced question paper meeting
                                            your criteria</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Start Guide -->
                            <div class="bg-gray-50 rounded-lg p-6">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                    <i class="fas fa-bolt text-gray-600 mr-2"></i>
                                    Quick Start Guide
                                </h4>
                                <div class="space-y-4">
                                    <div class="flex items-start space-x-4">
                                        <div
                                            class="bg-orange-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold text-sm">
                                            1</div>
                                        <div>
                                            <h5 class="font-medium text-gray-800">Create Your First Question Paper</h5>
                                            <p class="text-sm text-gray-600">Click on "New Question Paper" in the
                                                sidebar to begin the process.</p>
                                        </div>
                                    </div>
                                    <div class="flex items-start space-x-4">
                                        <div
                                            class="bg-orange-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold text-sm">
                                            2</div>
                                        <div>
                                            <h5 class="font-medium text-gray-800">Upload Your Question Bank</h5>
                                            <p class="text-sm text-gray-600">Use the file upload feature to import
                                                questions from Excel, CSV, or JSON files.</p>
                                        </div>
                                    </div>
                                    <div class="flex items-start space-x-4">
                                        <div
                                            class="bg-orange-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold text-sm">
                                            3</div>
                                        <div>
                                            <h5 class="font-medium text-gray-800">Set Paper Requirements</h5>
                                            <p class="text-sm text-gray-600">Define total marks, duration, difficulty
                                                levels, and Course Outcome distribution.</p>
                                        </div>
                                    </div>
                                    <div class="flex items-start space-x-4">
                                        <div
                                            class="bg-orange-500 text-white rounded-full w-8 h-8 flex items-center justify-center font-bold text-sm">
                                            4</div>
                                        <div>
                                            <h5 class="font-medium text-gray-800">Generate and Download</h5>
                                            <p class="text-sm text-gray-600">Click "Generate Question Paper" and
                                                download your professionally formatted paper.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- System Requirements -->
                            <div class="bg-gray-50 rounded-lg p-6">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                    <i class="fas fa-desktop text-gray-600 mr-2"></i>
                                    System Requirements
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <h5 class="font-medium text-gray-800 mb-2">Supported Browsers</h5>
                                        <ul class="text-sm text-gray-600 space-y-1">
                                            <li><i class="fab fa-chrome text-blue-500 mr-2"></i>Google Chrome 90+</li>
                                            <li><i class="fab fa-firefox text-orange-500 mr-2"></i>Mozilla Firefox 88+
                                            </li>
                                            <li><i class="fab fa-safari text-blue-600 mr-2"></i>Safari 14+</li>
                                            <li><i class="fab fa-edge text-blue-700 mr-2"></i>Microsoft Edge 90+</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <h5 class="font-medium text-gray-800 mb-2">Recommended Specifications</h5>
                                        <ul class="text-sm text-gray-600 space-y-1">
                                            <li><i class="fas fa-memory text-gray-500 mr-2"></i>4GB RAM minimum</li>
                                            <li><i class="fas fa-hdd text-gray-500 mr-2"></i>100MB free storage</li>
                                            <li><i class="fas fa-wifi text-gray-500 mr-2"></i>Stable internet connection
                                            </li>
                                            <li><i class="fas fa-mobile-alt text-gray-500 mr-2"></i>1024x768 screen
                                                resolution</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- FAQ Tab -->
                    <div id="help-faq-tab" class="help-tab-content hidden p-6">
                        <div class="space-y-6">
                            <div class="bg-gray-50 rounded-lg p-6">
                                <h4 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
                                    <i class="fas fa-question text-gray-600 mr-2"></i>
                                    Frequently Asked Questions
                                </h4>
                                <div class="space-y-4">
                                    <div class="faq-item bg-white rounded-lg border border-gray-200">
                                        <button
                                            class="faq-question w-full text-left p-4 font-medium text-gray-800 hover:bg-gray-50 flex justify-between items-center">
                                            <span>How do I upload questions to the system?</span>
                                            <i class="fas fa-chevron-down text-gray-400"></i>
                                        </button>
                                        <div
                                            class="faq-answer hidden p-4 border-t border-gray-200 text-sm text-gray-600">
                                            <p>You can upload questions in multiple ways:</p>
                                            <ul class="list-disc list-inside mt-2 space-y-1">
                                                <li>Use the file upload feature to import Excel (.xlsx), CSV, or JSON
                                                    files</li>
                                                <li>Add questions manually using the question editor</li>
                                                <li>Copy and paste from existing documents</li>
                                            </ul>
                                            <p class="mt-2">Make sure your file includes columns for question text,
                                                marks, difficulty level, and Course Outcomes.</p>
                                        </div>
                                    </div>

                                    <div class="faq-item bg-white rounded-lg border border-gray-200">
                                        <button
                                            class="faq-question w-full text-left p-4 font-medium text-gray-800 hover:bg-gray-50 flex justify-between items-center">
                                            <span>What file formats are supported for question import?</span>
                                            <i class="fas fa-chevron-down text-gray-400"></i>
                                        </button>
                                        <div
                                            class="faq-answer hidden p-4 border-t border-gray-200 text-sm text-gray-600">
                                            <p>SmartQPGen supports the following file formats:</p>
                                            <ul class="list-disc list-inside mt-2 space-y-1">
                                                <li><strong>Excel files (.xlsx, .xls)</strong> - Most commonly used
                                                    format</li>
                                                <li><strong>CSV files (.csv)</strong> - Comma-separated values</li>
                                                <li><strong>JSON files (.json)</strong> - For advanced users and data
                                                    exchange</li>
                                                <li><strong>Text files (.txt)</strong> - Simple text format with proper
                                                    delimiters</li>
                                            </ul>
                                        </div>
                                    </div>

                                    <div class="faq-item bg-white rounded-lg border border-gray-200">
                                        <button
                                            class="faq-question w-full text-left p-4 font-medium text-gray-800 hover:bg-gray-50 flex justify-between items-center">
                                            <span>How does the AI ensure balanced question papers?</span>
                                            <i class="fas fa-chevron-down text-gray-400"></i>
                                        </button>
                                        <div
                                            class="faq-answer hidden p-4 border-t border-gray-200 text-sm text-gray-600">
                                            <p>Our AI system uses multiple criteria to ensure balance:</p>
                                            <ul class="list-disc list-inside mt-2 space-y-1">
                                                <li><strong>Difficulty Distribution:</strong> Maintains proper ratio of
                                                    easy, medium, and hard questions</li>
                                                <li><strong>Bloom's Taxonomy:</strong> Ensures coverage across all
                                                    cognitive levels</li>
                                                <li><strong>Course Outcomes:</strong> Distributes questions according to
                                                    CO weightings</li>
                                                <li><strong>Topic Coverage:</strong> Avoids clustering questions from
                                                    the same topic</li>
                                                <li><strong>Mark Distribution:</strong> Optimizes marks allocation
                                                    across question types</li>
                                            </ul>
                                        </div>
                                    </div>

                                    <div class="faq-item bg-white rounded-lg border border-gray-200">
                                        <button
                                            class="faq-question w-full text-left p-4 font-medium text-gray-800 hover:bg-gray-50 flex justify-between items-center">
                                            <span>Can I customize the question paper format?</span>
                                            <i class="fas fa-chevron-down text-gray-400"></i>
                                        </button>
                                        <div
                                            class="faq-answer hidden p-4 border-t border-gray-200 text-sm text-gray-600">
                                            <p>Yes! SmartQPGen offers extensive customization options:</p>
                                            <ul class="list-disc list-inside mt-2 space-y-1">
                                                <li>Custom headers with institution details</li>
                                                <li>Configurable instructions and guidelines</li>
                                                <li>Multiple export formats (DOCX, PDF)</li>
                                                <li>Question numbering and formatting options</li>
                                                <li>Marking scheme inclusion</li>
                                                <li>Custom fonts and styling (in advanced settings)</li>
                                            </ul>
                                        </div>
                                    </div>

                                    <div class="faq-item bg-white rounded-lg border border-gray-200">
                                        <button
                                            class="faq-question w-full text-left p-4 font-medium text-gray-800 hover:bg-gray-50 flex justify-between items-center">
                                            <span>Is my data secure and private?</span>
                                            <i class="fas fa-chevron-down text-gray-400"></i>
                                        </button>
                                        <div
                                            class="faq-answer hidden p-4 border-t border-gray-200 text-sm text-gray-600">
                                            <p>Absolutely! We take data security seriously:</p>
                                            <ul class="list-disc list-inside mt-2 space-y-1">
                                                <li>All data is stored locally in your browser</li>
                                                <li>No question content is sent to external servers</li>
                                                <li>Optional encryption for sensitive data</li>
                                                <li>You have full control over data export and deletion</li>
                                                <li>No tracking or analytics without your consent</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- HOD Dashboard Content -->
            <div id="hod-dashboard-content" class="hidden p-6 mt-8 border border-purple-200 rounded-lg bg-purple-50">
                <!-- Header Section -->
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-2xl font-bold text-purple-800 flex items-center">
                            <i class="fas fa-crown text-purple-600 mr-3"></i>
                            HOD Dashboard
                        </h3>
                        <p class="text-purple-600 mt-1">Head of Department - Question Paper Review & Management</p>
                    </div>
                    <div class="flex space-x-3">
                        <button id="hod-refresh-btn"
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition duration-200">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                        <button id="hod-reports-btn"
                            class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-200">
                            <i class="fas fa-chart-bar mr-2"></i>Reports
                        </button>
                        <button id="hod-settings-btn"
                            class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition duration-200">
                            <i class="fas fa-cog mr-2"></i>HOD Settings
                        </button>
                    </div>
                </div>

                <!-- HOD Statistics Overview -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gradient-to-r from-red-500 to-red-600 rounded-lg p-4 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-red-100 text-sm">Pending Review</p>
                                <p class="text-2xl font-bold" id="hod-pending-count">0</p>
                            </div>
                            <i class="fas fa-clock text-2xl text-red-200"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg p-4 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm">Approved</p>
                                <p class="text-2xl font-bold" id="hod-approved-count">0</p>
                            </div>
                            <i class="fas fa-check-circle text-2xl text-green-200"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-lg p-4 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-yellow-100 text-sm">Needs Revision</p>
                                <p class="text-2xl font-bold" id="hod-revision-count">0</p>
                            </div>
                            <i class="fas fa-edit text-2xl text-yellow-200"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg p-4 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm">Total Faculty</p>
                                <p class="text-2xl font-bold" id="hod-faculty-count">0</p>
                            </div>
                            <i class="fas fa-users text-2xl text-blue-200"></i>
                        </div>
                    </div>
                </div>

                <!-- Filter and Search Section -->
                <div class="bg-white p-4 rounded-lg shadow-md mb-6">
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="flex-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Search Question Papers</label>
                            <div class="relative">
                                <input type="text" id="hod-search"
                                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    placeholder="Search by faculty, subject, or paper name...">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            </div>
                        </div>
                        <div class="md:w-48">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status Filter</label>
                            <select id="hod-status-filter"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="all">All Status</option>
                                <option value="pending">Pending Review</option>
                                <option value="approved">Approved</option>
                                <option value="revision">Needs Revision</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>
                        <div class="md:w-48">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Faculty Filter</label>
                            <select id="hod-faculty-filter"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="all">All Faculty</option>
                                <!-- Faculty options will be populated dynamically -->
                            </select>
                        </div>
                        <div class="md:w-48">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sort by</label>
                            <select id="hod-sort"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="date-desc">Newest First</option>
                                <option value="date-asc">Oldest First</option>
                                <option value="priority-desc">High Priority First</option>
                                <option value="faculty-asc">Faculty A-Z</option>
                                <option value="subject-asc">Subject A-Z</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Main Content Area -->
                <div class="bg-white rounded-lg shadow-md">
                    <!-- Tab Navigation -->
                    <div class="border-b border-gray-200">
                        <nav class="flex space-x-8 px-6 py-3">
                            <button
                                class="hod-tab-btn active border-b-2 border-purple-500 text-purple-600 font-medium py-2"
                                data-tab="pending">
                                <i class="fas fa-clock mr-2"></i>Pending Review (<span id="tab-pending-count">0</span>)
                            </button>
                            <button
                                class="hod-tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium py-2"
                                data-tab="approved">
                                <i class="fas fa-check-circle mr-2"></i>Approved (<span
                                    id="tab-approved-count">0</span>)
                            </button>
                            <button
                                class="hod-tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium py-2"
                                data-tab="revision">
                                <i class="fas fa-edit mr-2"></i>Needs Revision (<span id="tab-revision-count">0</span>)
                            </button>
                            <button
                                class="hod-tab-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium py-2"
                                data-tab="faculty">
                                <i class="fas fa-users mr-2"></i>Faculty Management
                            </button>
                        </nav>
                    </div>

                    <!-- Content List -->
                    <div class="p-6">
                        <!-- Loading State -->
                        <div id="hod-loading" class="hidden text-center py-8">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600">
                            </div>
                            <p class="mt-2 text-gray-600">Loading question papers...</p>
                        </div>

                        <!-- Empty State -->
                        <div id="hod-empty" class="hidden text-center py-12">
                            <div class="mx-auto h-24 w-24 text-gray-400 mb-4">
                                <i class="fas fa-clipboard-list text-6xl"></i>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">No question papers found</h3>
                            <p class="text-gray-500 mb-6">Question papers submitted by faculty will appear here for
                                review</p>
                        </div>

                        <!-- Question Papers List -->
                        <div id="hod-papers-list" class="space-y-4">
                            <!-- Papers will be populated by JavaScript -->
                        </div>

                        <!-- Faculty Management Tab Content -->
                        <div id="hod-faculty-management" class="hidden">
                            <div class="space-y-6">
                                <!-- Faculty Statistics -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="bg-blue-50 rounded-lg p-4">
                                        <h4 class="font-semibold text-blue-900 mb-2">Active Faculty</h4>
                                        <p class="text-2xl font-bold text-blue-600" id="active-faculty-count">0</p>
                                    </div>
                                    <div class="bg-green-50 rounded-lg p-4">
                                        <h4 class="font-semibold text-green-900 mb-2">Papers This Month</h4>
                                        <p class="text-2xl font-bold text-green-600" id="monthly-papers-count">0</p>
                                    </div>
                                    <div class="bg-yellow-50 rounded-lg p-4">
                                        <h4 class="font-semibold text-yellow-900 mb-2">Avg. Review Time</h4>
                                        <p class="text-2xl font-bold text-yellow-600" id="avg-review-time">0h</p>
                                    </div>
                                </div>

                                <!-- Faculty List -->
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h4 class="font-semibold text-gray-900 mb-4">Faculty Performance</h4>
                                    <div id="faculty-performance-list" class="space-y-3">
                                        <!-- Faculty performance cards will be populated -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Pagination -->
                        <div id="hod-pagination"
                            class="hidden justify-between items-center mt-6 pt-6 border-t border-gray-200">
                            <div class="text-sm text-gray-700">
                                Showing <span id="hod-pagination-start">1</span> to <span
                                    id="hod-pagination-end">10</span> of <span id="hod-pagination-total">0</span>
                                results
                            </div>
                            <div class="flex space-x-2">
                                <button id="hod-pagination-prev"
                                    class="px-3 py-1 border border-gray-300 rounded-md text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <i class="fas fa-chevron-left mr-1"></i>Previous
                                </button>
                                <div id="hod-pagination-numbers" class="flex space-x-1">
                                    <!-- Page numbers will be populated by JavaScript -->
                                </div>
                                <button id="hod-pagination-next"
                                    class="px-3 py-1 border border-gray-300 rounded-md text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                    Next<i class="fas fa-chevron-right ml-1"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- HOD Modal Dialogs -->
                <!-- Review Question Paper Modal -->
                <div id="hod-review-modal"
                    class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
                    <div class="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] overflow-hidden">
                        <div class="flex justify-between items-center p-6 border-b border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-900" id="review-modal-title">Review Question
                                Paper</h3>
                            <button class="text-gray-400 hover:text-gray-600"
                                onclick="closeHODModal('hod-review-modal')">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="flex h-[70vh]">
                            <!-- Question Paper Preview -->
                            <div class="flex-1 p-6 overflow-y-auto border-r border-gray-200">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4">Question Paper Preview</h4>
                                <div id="review-paper-content" class="bg-gray-50 rounded-lg p-4 min-h-96">
                                    <!-- Question paper content will be populated here -->
                                </div>
                            </div>
                            <!-- Review Panel -->
                            <div class="w-96 p-6 bg-gray-50">
                                <h4 class="text-lg font-semibold text-gray-900 mb-4">Review & Comments</h4>

                                <!-- Paper Information -->
                                <div class="bg-white rounded-lg p-4 mb-4">
                                    <h5 class="font-medium text-gray-800 mb-2">Paper Details</h5>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Faculty:</span>
                                            <span class="font-medium" id="review-faculty-name">-</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Subject:</span>
                                            <span class="font-medium" id="review-subject">-</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Total Marks:</span>
                                            <span class="font-medium" id="review-total-marks">-</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Duration:</span>
                                            <span class="font-medium" id="review-duration">-</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Questions:</span>
                                            <span class="font-medium" id="review-question-count">-</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Submitted:</span>
                                            <span class="font-medium" id="review-submit-date">-</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Quality Checks -->
                                <div class="bg-white rounded-lg p-4 mb-4">
                                    <h5 class="font-medium text-gray-800 mb-2">Quality Checks</h5>
                                    <div class="space-y-2">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm text-gray-600">Bloom's Taxonomy</span>
                                            <span class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-800"
                                                id="blooms-check">âœ“ Balanced</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm text-gray-600">CO Coverage</span>
                                            <span class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-800"
                                                id="co-check">âœ“ Complete</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm text-gray-600">Difficulty Balance</span>
                                            <span class="text-xs px-2 py-1 rounded-full bg-yellow-100 text-yellow-800"
                                                id="difficulty-check">âš  Review</span>
                                        </div>
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm text-gray-600">Duplicates</span>
                                            <span class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-800"
                                                id="duplicate-check">âœ“ None</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Comments Section -->
                                <div class="bg-white rounded-lg p-4 mb-4">
                                    <h5 class="font-medium text-gray-800 mb-2">HOD Comments</h5>
                                    <textarea id="hod-comments"
                                        class="w-full h-24 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm"
                                        placeholder="Add your review comments here..."></textarea>
                                </div>

                                <!-- Priority Setting -->
                                <div class="bg-white rounded-lg p-4 mb-4">
                                    <h5 class="font-medium text-gray-800 mb-2">Priority Level</h5>
                                    <select id="review-priority"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                                        <option value="low">Low Priority</option>
                                        <option value="medium" selected>Medium Priority</option>
                                        <option value="high">High Priority</option>
                                        <option value="urgent">Urgent</option>
                                    </select>
                                </div>

                                <!-- Action Buttons -->
                                <div class="space-y-2">
                                    <button id="approve-paper-btn"
                                        class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition duration-200">
                                        <i class="fas fa-check mr-2"></i>Approve Paper
                                    </button>
                                    <button id="request-revision-btn"
                                        class="w-full px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 transition duration-200">
                                        <i class="fas fa-edit mr-2"></i>Request Revision
                                    </button>
                                    <button id="reject-paper-btn"
                                        class="w-full px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition duration-200">
                                        <i class="fas fa-times mr-2"></i>Reject Paper
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Faculty Management Modal -->
                <div id="hod-faculty-modal"
                    class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-hidden">
                        <div class="flex justify-between items-center p-6 border-b border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-900">Faculty Management</h3>
                            <button class="text-gray-400 hover:text-gray-600"
                                onclick="closeHODModal('hod-faculty-modal')">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="p-6 overflow-y-auto max-h-[60vh]">
                            <div class="space-y-6">
                                <!-- Add Faculty Form -->
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h4 class="font-semibold text-gray-900 mb-4">Add New Faculty</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Faculty
                                                Name</label>
                                            <input type="text" id="new-faculty-name"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                            <input type="email" id="new-faculty-email"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        </div>
                                        <div>
                                            <label
                                                class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                                            <input type="text" id="new-faculty-dept"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        </div>
                                        <div>
                                            <label
                                                class="block text-sm font-medium text-gray-700 mb-2">Specialization</label>
                                            <input type="text" id="new-faculty-spec"
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                        </div>
                                    </div>
                                    <button id="add-faculty-btn"
                                        class="mt-4 px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition duration-200">
                                        <i class="fas fa-plus mr-2"></i>Add Faculty
                                    </button>
                                </div>

                                <!-- Faculty List -->
                                <div class="bg-gray-50 rounded-lg p-4">
                                    <h4 class="font-semibold text-gray-900 mb-4">Current Faculty</h4>
                                    <div id="faculty-list" class="space-y-3">
                                        <!-- Faculty cards will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Modal -->
                <div id="hod-reports-modal"
                    class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
                    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[80vh] overflow-hidden">
                        <div class="flex justify-between items-center p-6 border-b border-gray-200">
                            <h3 class="text-xl font-semibold text-gray-900">Department Reports</h3>
                            <button class="text-gray-400 hover:text-gray-600"
                                onclick="closeHODModal('hod-reports-modal')">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="p-6 overflow-y-auto max-h-[60vh]">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Report Cards -->
                                <div class="bg-blue-50 rounded-lg p-4 cursor-pointer hover:bg-blue-100 transition duration-200"
                                    onclick="generateReport('faculty-performance')">
                                    <div class="flex items-center">
                                        <i class="fas fa-chart-line text-blue-600 text-2xl mr-4"></i>
                                        <div>
                                            <h4 class="font-semibold text-blue-900">Faculty Performance</h4>
                                            <p class="text-sm text-blue-700">Detailed performance analysis</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-green-50 rounded-lg p-4 cursor-pointer hover:bg-green-100 transition duration-200"
                                    onclick="generateReport('paper-analytics')">
                                    <div class="flex items-center">
                                        <i class="fas fa-file-chart text-green-600 text-2xl mr-4"></i>
                                        <div>
                                            <h4 class="font-semibold text-green-900">Paper Analytics</h4>
                                            <p class="text-sm text-green-700">Question paper statistics</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-yellow-50 rounded-lg p-4 cursor-pointer hover:bg-yellow-100 transition duration-200"
                                    onclick="generateReport('quality-metrics')">
                                    <div class="flex items-center">
                                        <i class="fas fa-award text-yellow-600 text-2xl mr-4"></i>
                                        <div>
                                            <h4 class="font-semibold text-yellow-900">Quality Metrics</h4>
                                            <p class="text-sm text-yellow-700">Quality assessment reports</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-purple-50 rounded-lg p-4 cursor-pointer hover:bg-purple-100 transition duration-200"
                                    onclick="generateReport('department-summary')">
                                    <div class="flex items-center">
                                        <i class="fas fa-building text-purple-600 text-2xl mr-4"></i>
                                        <div>
                                            <h4 class="font-semibold text-purple-900">Department Summary</h4>
                                            <p class="text-sm text-purple-700">Overall department overview</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Approval Management Section -->
                <div class="mt-8">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h4 class="text-xl font-semibold text-gray-800">
                                <i class="fas fa-clipboard-check mr-2 text-purple-600"></i>
                                Pending Approvals
                            </h4>
                            <div class="flex space-x-2">
                                <button id="refresh-approvals-btn"
                                    class="px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">
                                    <i class="fas fa-sync-alt mr-1"></i>Refresh
                                </button>
                                <select id="approval-filter"
                                    class="px-3 py-1 border border-gray-300 rounded-md text-sm">
                                    <option value="all">All Status</option>
                                    <option value="pending_approval">Pending Review</option>
                                    <option value="revision_requested">Needs Revision</option>
                                    <option value="approved">Approved</option>
                                </select>
                            </div>
                        </div>

                        <!-- Approvals List -->
                        <div id="approvals-list" class="space-y-4">
                            <!-- Approvals will be populated here -->
                        </div>

                        <!-- No approvals message -->
                        <div id="no-approvals-message" class="text-center py-8 text-gray-500 hidden">
                            <i class="fas fa-inbox text-4xl mb-4"></i>
                            <p>No pending approvals found</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="question-modal" class="modal">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl">
            <span class="close-button text-gray-500 hover:text-gray-800">&times;</span>
            <h3 id="modal-title" class="text-xl font-semibold mb-4">Add New Question</h3>
            <form id="question-form" class="space-y-4">
                <div>
                    <label for="question-text-input" class="block text-sm font-medium text-gray-700">Question
                        Text:</label>
                    <textarea id="question-text-input" rows="4"
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                        required></textarea>
                </div>
                <div class="grid grid-cols-4 gap-4">
                    <div>
                        <label for="co-input" class="block text-sm font-medium text-gray-700">CO:</label>
                        <input type="text" id="co-input"
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="blooms-level-input" class="block text-sm font-medium text-gray-700">Level
                            (L1-L6):</label>
                        <input type="text" id="blooms-level-input"
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="marks-input" class="block text-sm font-medium text-gray-700">Marks:</label>
                        <input type="number" id="marks-input" min="0" max="100"
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                            required>
                    </div>
                    <div>
                        <label for="module-input" class="block text-sm font-medium text-gray-700">Module:</label>
                        <select id="module-input"
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="1">Module 1</option>
                            <option value="2">Module 2</option>
                            <option value="3">Module 3</option>
                            <option value="4">Module 4</option>
                            <option value="5">Module 5</option>
                        </select>
                    </div>
                </div>
                <button type="submit"
                    class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition duration-200">
                    Save Question
                </button>
            </form>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>

    <script>
        // Your Firebase project configuration goes here
        const firebaseConfig = {
            apiKey: "AIzaSyBSnzIj-z4shuJs6IAib6MzKv5JdE7azks",
            authDomain: "skit-qp.firebaseapp.com",
            projectId: "skit-qp",
            storageBucket: "skit-qp.firebasestorage.app",
            messagingSenderId: "1039823538914",
            appId: "1:1039823538914:web:a5d1b95e1dde98bc65ecbb",
            measurementId: "G-KEXRFLLP2Y"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        } else {
            try {
                firebase.app();
            } catch (e) {
                firebase.initializeApp(firebaseConfig);
            }
        }

        window.firebaseAuth = firebase.auth();
        window.firebaseFirestore = firebase.firestore();

        // --- Global Data Model for the Question Paper ---
        const currentQuestionPaper = []; // Array of main question objects
        let mainQuestionCounter = 0; // Counter for display numbers (Q1, Q2, etc.)
        let currentParsedQuestions = []; // Stores all questions in the left pane (parsed + manually added)

        // --- Global HOD System Variables ---
        let currentUserRole = 'faculty'; // Initialize role as faculty
        let hodQuestionPapers = [];
        let facultyList = [];
        let currentHODFilter = 'all';
        let currentHODTab = 'pending';
        let currentHODPage = 1;
        const hodItemsPerPage = 10;

        document.addEventListener('DOMContentLoaded', async () => {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggleDesktop = document.getElementById('sidebar-toggle-desktop');
            const sidebarToggleOpenMobile = document.getElementById('sidebar-toggle-open-mobile');
            const sidebarToggleCloseMobile = document.getElementById('sidebar-toggle-close-mobile');
            const mainContentWrapper = document.getElementById('main-content-wrapper');
            const currentViewTitle = document.getElementById('current-view-title');

            // Account Dropdown Elements
            const accountMenuBtn = document.getElementById('account-menu-btn');
            const accountDropdown = document.getElementById('account-dropdown');
            const accountInitial = document.getElementById('account-initial');
            const accountAvatarCircle = document.getElementById('account-avatar-circle');
            const dropdownUsername = document.getElementById('dropdown-username');
            const dropdownEmail = document.getElementById('dropdown-email');
            const dropdownSignOutBtn = document.getElementById('dropdown-sign-out');
            const dropdownDeleteAccountBtn = document.getElementById('dropdown-delete-account');
            const dropdownAddAccountBtn = document.getElementById('dropdown-add-account');


            // Navigation Buttons
            const newQpBtn = document.getElementById('new-qp-btn');
            const navRequirements = document.getElementById('nav-requirements');
            const navSaved = document.getElementById('nav-saved');
            const navRecent = document.getElementById('nav-recent');
            const navSettings = document.getElementById('nav-settings');
            const navHelp = document.getElementById('nav-help');

            // Content Sections
            const welcomeContent = document.getElementById('welcome-content');
            const newQpCanvas = document.getElementById('new-qp-canvas');
            const requirementsContent = document.getElementById('requirements-content');
            const savedContent = document.getElementById('saved-content');
            const recentContent = document.getElementById('recent-content');
            const settingsContent = document.getElementById('settings-content');
            const helpContent = document.getElementById('help-content');
            const hodDashboardContent = document.getElementById('hod-dashboard-content');
            const qpEditorCanvas = document.getElementById('qp-editor-canvas');

            // Upload Form Elements
            const uploadQbForm = document.getElementById('upload-qb-form');
            const fileInput = document.getElementById('file-input');
            const clearFileBtn = document.getElementById('clear-file-btn');
            const selectedFileName = document.getElementById('selected-file-name');
            const uploadStatus = document.getElementById('upload-status');
            const rephrasingToggle = document.getElementById('rephrasing-toggle');

            // CIE Upload Elements
            const cieTypeSelect = document.getElementById('cie-type-select');
            const standardUpload = document.getElementById('standard-upload');
            const cie1Upload = document.getElementById('cie1-upload');
            const cie2Upload = document.getElementById('cie2-upload');
            const uploadCie1Form = document.getElementById('upload-cie1-form');
            const uploadCie2Form = document.getElementById('upload-cie2-form');
            const parseCie1Btn = document.getElementById('parse-cie1-btn');
            const parseCie2Btn = document.getElementById('parse-cie2-btn');
            const parsedQuestionsList = document.getElementById('parsed-questions-list');
            const qpPreviewList = document.getElementById('qp-preview-list');
            const qpCurrentTotalMarksDisplay = document.getElementById('qp-current-total-marks'); // Renamed
            const overallMaxMarksInput = document.getElementById('overall-max-marks-input'); // New input
            const addMainQuestionBtn = document.getElementById('add-main-question-btn'); // Moved button
            const addNewQuestionBtn = document.getElementById('add-new-question-btn'); // New button for left pane

            // Modal Elements
            const questionModal = document.getElementById('question-modal');
            const closeModalBtn = questionModal.querySelector('.close-button');
            const modalTitle = document.getElementById('modal-title');
            const questionForm = document.getElementById('question-form');
            const questionTextInput = document.getElementById('question-text-input');
            const coInput = document.getElementById('co-input');
            const bloomsLevelInput = document.getElementById('blooms-level-input');
            const marksInput = document.getElementById('marks-input');
            let editingQuestionId = null; // To store the ID of the question being edited

            // Theme Toggle
            const themeToggle = document.getElementById('theme-toggle');

            // --- Sidebar Toggle Logic ---
            const applyInitialSidebarState = () => {
                if (window.innerWidth >= 768) { // Desktop
                    document.body.classList.remove('sidebar-open-mobile');
                    document.body.classList.add('sidebar-open-desktop-default');
                    if (localStorage.getItem('sidebarState') === 'collapsed') {
                        document.body.classList.add('sidebar-closed-desktop');
                    } else {
                        document.body.classList.remove('sidebar-closed-desktop');
                    }
                } else { // Mobile
                    document.body.classList.remove('sidebar-open-desktop-default');
                    document.body.classList.remove('sidebar-closed-desktop');
                    document.body.classList.remove('sidebar-open-mobile');
                }
            };

            const toggleSidebar = () => {
                if (window.innerWidth < 768) { // Mobile: Toggle overlay
                    document.body.classList.toggle('sidebar-open-mobile');
                } else { // Desktop: Toggle collapse/expand (pushing)
                    const isCollapsed = document.body.classList.toggle('sidebar-closed-desktop');
                    localStorage.setItem('sidebarState', isCollapsed ? 'collapsed' : 'expanded'); // Persist state
                }
            };

            // Event Listeners for sidebar toggles
            sidebarToggleDesktop.addEventListener('click', toggleSidebar);
            sidebarToggleOpenMobile.addEventListener('click', toggleSidebar);
            sidebarToggleCloseMobile.addEventListener('click', toggleSidebar);

            // Close sidebar if clicked outside on mobile (and if it's open)
            document.addEventListener('click', (event) => {
                if (window.innerWidth < 768 && !sidebar.contains(event.target) && !sidebarToggleOpenMobile.contains(event.target) && document.body.classList.contains('sidebar-open-mobile')) {
                    toggleSidebar();
                }
            });

            // Apply initial state and listen for resize
            applyInitialSidebarState();
            window.addEventListener('resize', applyInitialSidebarState);


            // --- Account Dropdown Logic ---
            accountMenuBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                accountDropdown.classList.toggle('hidden');
            });
            document.addEventListener('click', (event) => {
                if (!accountDropdown.contains(event.target) && !accountMenuBtn.contains(event.target)) {
                    accountDropdown.classList.add('hidden');
                }
            });


            // --- Content Switching Logic ---
            const showContent = (contentElement, title) => {
                const allContentSections = [welcomeContent, newQpCanvas, requirementsContent, savedContent, recentContent, settingsContent, helpContent, qpEditorCanvas];
                allContentSections.forEach(section => {
                    if (section) {
                        section.classList.add('hidden');
                        // Remove display classes when hiding
                        section.classList.remove('flex', 'flex-col', 'grid');
                    }
                });

                if (contentElement) {
                    contentElement.classList.remove('hidden');

                    // Add appropriate display class based on element type
                    if (contentElement.id === 'qp-editor-canvas') {
                        contentElement.classList.add('flex', 'flex-col');
                    } else if (contentElement.id === 'recent-grid-view') {
                        contentElement.classList.add('grid');
                    } else if (contentElement.id.includes('modal') || contentElement.id.includes('pagination')) {
                        contentElement.classList.add('flex');
                    }

                    // If showing welcome content, initialize cool dashboard
                    if (contentElement === welcomeContent) {
                        setTimeout(() => {
                            if (window.initializeCoolDashboard) {
                                window.initializeCoolDashboard();
                            }
                        }, 100);
                    }

                    // If showing saved content, initialize saved functionality
                    if (contentElement === savedContent) {
                        setTimeout(() => {
                            if (window.initializeSavedContent) {
                                window.initializeSavedContent();
                            }
                        }, 100);
                    }

                    // If showing recent content, initialize recent functionality
                    if (contentElement === recentContent) {
                        setTimeout(() => {
                            if (window.initializeRecentContent) {
                                window.initializeRecentContent();
                            }
                        }, 100);
                    }

                    // If showing settings content, initialize settings functionality
                    if (contentElement === settingsContent) {
                        setTimeout(() => {
                            if (window.initializeSettingsContent) {
                                window.initializeSettingsContent();
                            }
                        }, 100);
                    }

                    // If showing help content, initialize help functionality
                    if (contentElement === helpContent) {
                        setTimeout(() => {
                            if (window.initializeHelpContent) {
                                window.initializeHelpContent();
                            }
                        }, 100);
                    }

                    // If showing HOD dashboard, initialize HOD functionality
                    if (contentElement === hodDashboardContent) {
                        setTimeout(() => {
                            if (window.initializeHODDashboard) {
                                window.initializeHODDashboard();
                            }
                        }, 100);
                    }
                }
                if (currentViewTitle) {
                    currentViewTitle.textContent = title;
                }
                if (window.innerWidth < 768 && document.body.classList.contains('sidebar-open-mobile')) {
                    toggleSidebar(); // Close sidebar after clicking a nav item on mobile
                }
            };

            // Event Listeners for Navigation
            newQpBtn.addEventListener('click', () => {
                showContent(newQpCanvas, 'New Question Paper');
                // Reset QP data when starting a new paper
                currentQuestionPaper.length = 0; // Clear the array
                mainQuestionCounter = 0; // Reset counter
                renderQPPreview(); // Render empty preview
            });
            navRequirements.addEventListener('click', () => showContent(requirementsContent, 'Requirements for QP'));
            navSaved.addEventListener('click', () => {
                showContent(savedContent, 'Saved QPs & Banks');
                // Initialize saved content when shown
                setTimeout(() => {
                    if (typeof initializeSavedContent === 'function') {
                        initializeSavedContent();
                    }
                }, 100);
            });
            navRecent.addEventListener('click', () => {
                showContent(recentContent, 'Recent Generated QPs');
                // Initialize recent content when shown
                setTimeout(() => {
                    if (typeof initializeRecentContent === 'function') {
                        initializeRecentContent();
                    }
                }, 100);
            });
            navSettings.addEventListener('click', () => showContent(settingsContent, 'Settings'));
            navHelp.addEventListener('click', () => showContent(helpContent, 'Help'));

            // HOD Dashboard Navigation
            const navHODDashboard = document.getElementById('nav-hod-dashboard');
            if (navHODDashboard) {
                navHODDashboard.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('HOD Dashboard navigation clicked');

                    // Use the main switchToHODView function for consistency
                    if (typeof switchToHODView === 'function') {
                        switchToHODView();
                    } else {
                        console.error('switchToHODView function not available');
                        displayMessageBox('âŒ HOD Dashboard not available. Please refresh the page.', 'error');
                    }
                });
            }

            // --- File Input & Clear Logic ---
            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    selectedFileName.textContent = `Selected: ${fileInput.files[0].name}`;
                    selectedFileName.classList.remove('hidden');
                } else {
                    selectedFileName.textContent = '';
                    selectedFileName.classList.add('hidden');
                }
                uploadStatus.textContent = ''; // Clear status on new file selection
            });

            clearFileBtn.addEventListener('click', () => {
                fileInput.value = ''; // Clear the selected file
                selectedFileName.textContent = '';
                selectedFileName.classList.add('hidden');
                uploadStatus.textContent = 'File selection cleared.';
                uploadStatus.className = 'mt-3 text-sm font-medium text-gray-600';
            });


            // --- Upload and Parse Logic ---
            if (uploadQbForm) {
                uploadQbForm.addEventListener('submit', async (event) => {
                    event.preventDefault();

                    uploadStatus.textContent = 'Uploading and parsing... Please wait.';
                    uploadStatus.className = 'mt-3 text-sm font-medium text-blue-600';

                    const formData = new FormData(uploadQbForm);
                    formData.append('enable_rephrasing', rephrasingToggle.checked);

                    const user = window.firebaseAuth.currentUser;
                    if (!user) {
                        displayMessageBox("You must be logged in to upload files.", 'error');
                        uploadStatus.textContent = 'Error: Not logged in.';
                        uploadStatus.className = 'mt-3 text-sm font-medium text-red-600';
                        return;
                    }
                    const idToken = await user.getIdToken();

                    try {
                        const response = await fetch('/upload_and_parse', {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'Authorization': `Bearer ${idToken}`
                            }
                        });

                        const data = await response.json();

                        if (response.ok) {
                            uploadStatus.textContent = `Success: ${data.message} Found ${data.parsed_questions_count} questions.`;
                            uploadStatus.className = 'mt-3 text-sm font-medium text-green-600';
                            console.log('Parsed data:', data.parsed_data);

                            showContent(qpEditorCanvas, 'Question Paper Editor');
                            // Store the parsed questions globally for the left pane
                            currentParsedQuestions = data.parsed_data;
                            populateLeftPane(currentParsedQuestions);
                            renderQPPreview();

                            // Update the latest upload info display
                            updateLatestUploadInfo(data.filename, data.parsed_questions_count);

                        } else {
                            uploadStatus.textContent = `Error: ${data.error}`;
                            uploadStatus.className = 'mt-3 text-sm font-medium text-red-600';
                            console.error('Upload error:', data);
                        }
                    } catch (error) {
                        console.error('Upload error:', error);
                        let errorMessage = 'âŒ Upload failed. ';

                        if (error.message.includes('network') || error.message.includes('fetch')) {
                            errorMessage += 'Please check your internet connection and ensure the server is running.';
                        } else if (error.message.includes('quota')) {
                            errorMessage += 'Database quota exceeded. Please try again later.';
                        } else {
                            errorMessage += `Error: ${error.message}`;
                        }

                        uploadStatus.textContent = errorMessage;
                        uploadStatus.className = 'mt-3 text-sm font-medium text-red-600';
                    }
                });
            }

            // --- CIE Dropdown and Upload Section Logic ---
            if (cieTypeSelect) {
                cieTypeSelect.addEventListener('change', (event) => {
                    const selectedType = event.target.value;

                    // Hide all upload sections
                    standardUpload.classList.add('hidden');
                    cie1Upload.classList.add('hidden');
                    cie2Upload.classList.add('hidden');

                    // Show the selected upload section
                    switch (selectedType) {
                        case 'standard':
                            standardUpload.classList.remove('hidden');
                            break;
                        case 'cie1':
                            cie1Upload.classList.remove('hidden');
                            break;
                        case 'cie2':
                            cie2Upload.classList.remove('hidden');
                            break;
                    }
                });
            }

            // --- CIE 1 Form Handler ---
            if (uploadCie1Form) {
                uploadCie1Form.addEventListener('submit', async (event) => {
                    event.preventDefault();

                    uploadStatus.textContent = 'Uploading and parsing CIE 1 modules... Please wait.';
                    uploadStatus.className = 'mt-3 text-sm font-medium text-blue-600';

                    const formData = new FormData(uploadCie1Form);
                    formData.append('enable_rephrasing', document.getElementById('rephrasing-toggle-cie1').checked);
                    formData.append('cie_type', 'cie1');

                    const user = window.firebaseAuth.currentUser;
                    if (!user) {
                        displayMessageBox("You must be logged in to upload files.", 'error');
                        uploadStatus.textContent = 'Error: Not logged in.';
                        uploadStatus.className = 'mt-3 text-sm font-medium text-red-600';
                        return;
                    }
                    const idToken = await user.getIdToken();

                    try {
                        const response = await fetch('/upload_and_parse_cie', {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'Authorization': `Bearer ${idToken}`
                            }
                        });

                        const data = await response.json();

                        if (response.ok) {
                            uploadStatus.textContent = `Success: CIE 1 modules uploaded and parsed! Found ${data.total_questions} questions across all modules.`;
                            uploadStatus.className = 'mt-3 text-sm font-medium text-green-600';
                            console.log('Parsed CIE 1 data:', data);

                            showContent(qpEditorCanvas, 'Question Paper Editor');
                            // Store the parsed questions globally for the left pane
                            currentParsedQuestions = data.all_questions;
                            populateLeftPane(currentParsedQuestions);
                            renderQPPreview();

                            // Update the latest upload info display
                            updateLatestUploadInfo('CIE 1 Modules', data.total_questions);

                        } else {
                            uploadStatus.textContent = `Error: ${data.error || 'Failed to parse CIE 1 modules'}`;
                            uploadStatus.className = 'mt-3 text-sm font-medium text-red-600';
                        }
                    } catch (error) {
                        uploadStatus.textContent = `Network error: ${error.message}. Ensure Flask server is running.`;
                        uploadStatus.className = 'mt-3 text-sm font-medium text-red-600';
                        console.error('Fetch error:', error);
                    }
                });
            }

            // --- CIE 2 Form Handler ---
            if (uploadCie2Form) {
                uploadCie2Form.addEventListener('submit', async (event) => {
                    event.preventDefault();

                    uploadStatus.textContent = 'Uploading and parsing CIE 2 modules... Please wait.';
                    uploadStatus.className = 'mt-3 text-sm font-medium text-blue-600';

                    const formData = new FormData(uploadCie2Form);
                    formData.append('enable_rephrasing', document.getElementById('rephrasing-toggle-cie2').checked);
                    formData.append('cie_type', 'cie2');

                    const user = window.firebaseAuth.currentUser;
                    if (!user) {
                        displayMessageBox("You must be logged in to upload files.", 'error');
                        uploadStatus.textContent = 'Error: Not logged in.';
                        uploadStatus.className = 'mt-3 text-sm font-medium text-red-600';
                        return;
                    }
                    const idToken = await user.getIdToken();

                    try {
                        const response = await fetch('/upload_and_parse_cie', {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'Authorization': `Bearer ${idToken}`
                            }
                        });

                        const data = await response.json();

                        if (response.ok) {
                            uploadStatus.textContent = `Success: CIE 2 modules uploaded and parsed! Found ${data.total_questions} questions across all modules.`;
                            uploadStatus.className = 'mt-3 text-sm font-medium text-green-600';
                            console.log('Parsed CIE 2 data:', data);

                            showContent(qpEditorCanvas, 'Question Paper Editor');
                            // Store the parsed questions globally for the left pane
                            currentParsedQuestions = data.all_questions;
                            populateLeftPane(currentParsedQuestions);
                            renderQPPreview();

                            // Update the latest upload info display
                            updateLatestUploadInfo('CIE 2 Modules', data.total_questions);

                        } else {
                            uploadStatus.textContent = `Error: ${data.error || 'Failed to parse CIE 2 modules'}`;
                            uploadStatus.className = 'mt-3 text-sm font-medium text-red-600';
                        }
                    } catch (error) {
                        uploadStatus.textContent = `Network error: ${error.message}. Ensure Flask server is running.`;
                        uploadStatus.className = 'mt-3 text-sm font-medium text-red-600';
                        console.error('Fetch error:', error);
                    }
                });
            }

            // Function to format question text for proper display
            function formatQuestionText(questionText) {
                if (!questionText) return '';

                // Escape HTML characters first
                let formatted = questionText.replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');

                // Check if the text contains table markers or table-like data
                if (formatted.includes('Table:') || formatted.includes('|') || formatted.includes('\t')) {
                    // Split the text at "Table:" marker if it exists
                    let parts;
                    if (formatted.includes('Table:')) {
                        parts = formatted.split('Table:');
                    } else {
                        // Look for table data patterns - any text with multiple | separators
                        const tableStart = formatted.search(/\|.*\|/);
                        if (tableStart > 0) {
                            parts = [formatted.substring(0, tableStart), formatted.substring(tableStart)];
                        } else {
                            parts = [formatted];
                        }
                    }

                    let result = parts[0]; // The question text before the table

                    if (parts.length > 1) {
                        result += '<div class="mt-2"><strong>Table:</strong></div>';

                        // Process the table data
                        const tableData = parts[1].trim();

                        // Create a proper HTML table
                        result += '<div class="mt-1 overflow-x-auto"><table class="min-w-full text-xs border border-gray-300 bg-white">';

                        // Check if table data is already formatted with | separators
                        if (tableData.includes('|')) {
                            // Table is already formatted, parse it properly
                            const lines = tableData.split('\n').filter(line => line.trim());
                            lines.forEach((line, index) => {
                                const cells = line.split('|').map(cell => cell.trim()).filter(cell => cell);
                                if (cells.length > 0) {
                                    result += '<tr>';
                                    cells.forEach(cell => {
                                        const cellClass = index === 0 ? 'bg-gray-100 font-semibold' : '';
                                        result += `<td class="border border-gray-300 px-2 py-1 ${cellClass}">${cell}</td>`;
                                    });
                                    result += '</tr>';
                                }
                            });
                        } else {
                            // Table data needs formatting - try to detect structure
                            const lines = tableData.split('\n').filter(line => line.trim());
                            if (lines.length > 0) {
                                lines.forEach((line, index) => {
                                    if (line.trim()) {
                                        // Split by multiple spaces and create table cells
                                        const cells = line.trim().split(/\s+/);
                                        if (cells.length > 0) {
                                            result += '<tr>';
                                            cells.forEach(cell => {
                                                const cellClass = index === 0 ? 'bg-gray-100 font-semibold' : '';
                                                result += `<td class="border border-gray-300 px-2 py-1 ${cellClass}">${cell}</td>`;
                                            });
                                            result += '</tr>';
                                        }
                                    }
                                });
                            } else {
                                // Single line table data - try to parse it intelligently
                                const words = tableData.split(/\s+/);

                                // Try to detect if this is a structured dataset
                                if (words.length > 6) {
                                    // Look for patterns like "S.NO", "GPA", "CGPA", "X", "Y", "Class", etc.
                                    const headerKeywords = ['s.no', 'sno', 'no', 'gpa', 'cgpa', 'x', 'y', 'class', 'award', 'result', 'assessment', 'project'];
                                    const hasHeaders = headerKeywords.some(keyword =>
                                        words.some(word => word.toLowerCase().includes(keyword))
                                    );

                                    if (hasHeaders) {
                                        // This looks like a structured dataset, try to format it as a table
                                        let currentRow = [];
                                        let rowCount = 0;
                                        let expectedColumns = 0;

                                        for (let i = 0; i < words.length; i++) {
                                            const word = words[i].trim();
                                            if (!word) continue;

                                            // Check if this looks like a row number (1, 2, 3, etc.)
                                            if (/^\d+$/.test(word) && rowCount < 20) {
                                                if (currentRow.length > 0) {
                                                    // Output the previous row
                                                    result += '<tr>';
                                                    currentRow.forEach((cell, cellIndex) => {
                                                        const cellClass = rowCount === 1 ? 'bg-gray-100 font-semibold' : '';
                                                        result += `<td class="border border-gray-300 px-2 py-1 ${cellClass}">${cell}</td>`;
                                                    });
                                                    result += '</tr>';

                                                    if (rowCount === 1) {
                                                        expectedColumns = currentRow.length;
                                                    }
                                                }
                                                currentRow = [word];
                                                rowCount++;
                                            } else if (currentRow.length > 0) {
                                                currentRow.push(word);
                                            }
                                        }

                                        // Output the last row
                                        if (currentRow.length > 0) {
                                            result += '<tr>';
                                            currentRow.forEach((cell, cellIndex) => {
                                                const cellClass = rowCount === 1 ? 'bg-gray-100 font-semibold' : '';
                                                result += `<td class="border border-gray-300 px-2 py-1 ${cellClass}">${cell}</td>`;
                                            });
                                            result += '</tr>';
                                        }
                                    } else {
                                        // Fallback: just display as a simple table
                                        const cells = words.slice(0, 10); // Limit to first 10 words
                                        result += '<tr>';
                                        cells.forEach(cell => {
                                            result += `<td class="border border-gray-300 px-2 py-1">${cell}</td>`;
                                        });
                                        result += '</tr>';
                                    }
                                } else {
                                    // Simple case: just display the words
                                    result += '<tr>';
                                    words.forEach(word => {
                                        result += `<td class="border border-gray-300 px-2 py-1">${word}</td>`;
                                    });
                                    result += '</tr>';
                                }
                            }
                        }

                        result += '</table></div>';
                    }

                    return result;
                }

                // For regular text, just preserve line breaks
                return formatted.replace(/\n/g, '<br>');
            }

            // Function to populate the left pane with parsed questions
            function populateLeftPane(questions) {
                parsedQuestionsList.innerHTML = ''; // Clear previous content
                if (questions.length === 0) {
                    parsedQuestionsList.innerHTML = '<p class="text-gray-500">No questions in bank. Upload a document or add new questions manually.</p>';
                    return;
                }

                questions.forEach((q, index) => {
                    const questionCard = document.createElement('div');
                    questionCard.className = 'bg-gray-50 p-3 rounded-md shadow-sm border border-gray-200';
                    questionCard.dataset.questionId = q.firestore_id || `q-${index}`;
                    questionCard.dataset.questionData = JSON.stringify(q);
                    questionCard.draggable = true;

                    // Format question text to handle tables properly
                    const formattedQuestionText = formatQuestionText(q.question_text);

                    questionCard.innerHTML = `
                        <div class="font-semibold text-gray-800 mb-1">
                            <span class="text-blue-600">Q${q.sl_no || (index + 1)}.</span>
                            <div class="mt-1 text-sm font-normal text-gray-700 whitespace-pre-wrap">${formattedQuestionText}</div>
                        </div>
                        <div class="text-xs text-gray-600 flex flex-wrap gap-2">
                            <span>CO: <span class="font-medium">${q.co || 'N/A'}</span></span>
                            <span>Level: <span class="font-medium">${q.blooms_level || 'N/A'}</span></span>
                            <span>Marks: <span class="font-medium">${q.marks || 'N/A'}</span></span>
                            <span>Module: <span class="font-medium text-blue-600">${q.module || 'N/A'}</span></span>
                        </div>
                        <div class="mt-2 flex space-x-2">
                            <button class="add-to-qp-btn px-3 py-1 text-xs bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-200">
                                Add to QP
                            </button>
                            <button class="rephrase-btn px-3 py-1 text-xs bg-purple-500 text-white rounded-md hover:bg-purple-600 transition duration-200">
                                Rephrase
                            </button>
                            <button class="edit-bank-question-btn px-3 py-1 text-xs bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition duration-200">
                                Edit
                            </button>
                            <button class="delete-bank-question-btn px-3 py-1 text-xs bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-200">
                                Delete
                            </button>
                        </div>
                    `;
                    parsedQuestionsList.appendChild(questionCard);
                });

                addDragDropListeners();
                attachLeftPaneEventListeners(); // Attach listeners for new buttons

                // Maintain equal pane sizes after content changes
                if (window.maintainEqualPaneSizes) {
                    window.maintainEqualPaneSizes();
                }
            }

            // --- Left Pane (Question Bank) Event Listeners ---
            function attachLeftPaneEventListeners() {
                // Add New Question button
                addNewQuestionBtn.addEventListener('click', () => {
                    openQuestionModal('add');
                });

                // Edit/Delete buttons on question cards (delegated)
                parsedQuestionsList.addEventListener('click', async (e) => {
                    const questionCard = e.target.closest('[data-question-id]');
                    if (!questionCard) return;

                    const questionId = questionCard.dataset.questionId;
                    const questionData = JSON.parse(questionCard.dataset.questionData);

                    if (e.target.classList.contains('edit-bank-question-btn')) {
                        openQuestionModal('edit', questionId, questionData);
                    } else if (e.target.classList.contains('delete-bank-question-btn')) {
                        if (confirm('Are you sure you want to delete this question from your bank?')) {
                            await deleteQuestionFromBank(questionId);
                        }
                    } else if (e.target.classList.contains('rephrase-btn')) {
                        // Rephrasing logic for left pane questions
                        const rephraseButton = e.target;
                        rephraseButton.disabled = true; // Disable button during rephrasing
                        rephraseButton.textContent = 'Rephrasing...';

                        try {
                            const user = window.firebaseAuth.currentUser;
                            if (!user) {
                                displayMessageBox("You must be logged in to rephrase questions.", 'error');
                                rephraseButton.disabled = false;
                                rephraseButton.textContent = 'Rephrase';
                                return;
                            }
                            const idToken = await user.getIdToken();

                            const response = await fetch('/rephrase_question', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${idToken}`
                                },
                                body: JSON.stringify({
                                    question_id: questionId,
                                    original_text: questionData.question_text
                                })
                            });

                            const result = await response.json();

                            if (response.ok) {
                                const rephrasedText = result.rephrased_text;
                                // Update the question in Firestore
                                await updateQuestionInBank(questionId, { question_text: rephrasedText });
                                displayMessageBox("Question rephrased successfully!", 'success');
                            } else {
                                displayMessageBox(`Rephrasing failed: ${result.error || 'Unknown error'}`, 'error');
                            }
                        } catch (error) {
                            displayMessageBox(`Network error during rephrasing: ${error.message}`, 'error');
                            console.error('Rephrasing fetch error:', error);
                        } finally {
                            rephraseButton.disabled = false;
                            rephraseButton.textContent = 'Rephrase';
                        }
                    }
                });
            }

            // --- Modal Functions for Add/Edit Question ---
            function openQuestionModal(mode, qId = null, qData = {}) {
                questionForm.reset(); // Clear previous form data
                editingQuestionId = qId; // Set the ID of the question being edited

                if (mode === 'add') {
                    modalTitle.textContent = 'Add New Question';
                } else if (mode === 'edit') {
                    modalTitle.textContent = 'Edit Question';
                    questionTextInput.value = qData.question_text || '';
                    coInput.value = qData.co || '';
                    bloomsLevelInput.value = qData.blooms_level || '';
                    marksInput.value = qData.marks || '';
                }
                questionModal.style.display = 'flex'; // Show the modal
            }

            closeModalBtn.addEventListener('click', () => {
                questionModal.style.display = 'none'; // Hide the modal
            });

            window.addEventListener('click', (event) => {
                if (event.target == questionModal) {
                    questionModal.style.display = 'none'; // Hide modal if clicked outside
                }
            });

            questionForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const newQData = {
                    question_text: questionTextInput.value,
                    co: coInput.value,
                    blooms_level: bloomsLevelInput.value,
                    marks: parseInt(marksInput.value) || 0,
                    module: document.getElementById('module-input').value || '1'
                };

                if (editingQuestionId) {
                    await updateQuestionInBank(editingQuestionId, newQData);
                } else {
                    await addNewQuestionToBank(newQData);
                }
                questionModal.style.display = 'none'; // Hide modal after submission
            });

            // --- CRUD Operations for Question Bank (via Backend) ---
            async function addNewQuestionToBank(qData) {
                const user = window.firebaseAuth.currentUser;
                if (!user) { displayMessageBox("Not logged in.", 'error'); return; }
                const idToken = await user.getIdToken();

                try {
                    const response = await fetch('/add_question_to_bank', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${idToken}`
                        },
                        body: JSON.stringify(qData)
                    });
                    const result = await response.json();
                    if (response.ok) {
                        displayMessageBox("Question added to bank successfully!", 'success');
                        // Add the new question to our local array and re-render
                        currentParsedQuestions.push(result.new_question);
                        populateLeftPane(currentParsedQuestions);
                    } else {
                        displayMessageBox(`Failed to add question: ${result.error || 'Unknown error'}`, 'error');
                    }
                } catch (error) {
                    displayMessageBox(`Network error adding question: ${error.message}`, 'error');
                    console.error('Add question fetch error:', error);
                }
            }

            async function updateQuestionInBank(qId, updatedFields) {
                const user = window.firebaseAuth.currentUser;
                if (!user) { displayMessageBox("Not logged in.", 'error'); return; }
                const idToken = await user.getIdToken();

                try {
                    const response = await fetch('/update_question_in_bank', {
                        method: 'POST', // Or PUT/PATCH
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${idToken}`
                        },
                        body: JSON.stringify({ question_id: qId, ...updatedFields })
                    });
                    const result = await response.json();
                    if (response.ok) {
                        displayMessageBox("Question updated successfully!", 'success');
                        // Update the local array and re-render
                        const index = currentParsedQuestions.findIndex(q => q.firestore_id === qId);
                        if (index !== -1) {
                            currentParsedQuestions[index] = { ...currentParsedQuestions[index], ...updatedFields };
                            populateLeftPane(currentParsedQuestions);
                        }
                    } else {
                        displayMessageBox(`Failed to update question: ${result.error || 'Unknown error'}`, 'error');
                    }
                } catch (error) {
                    displayMessageBox(`Network error updating question: ${error.message}`, 'error');
                    console.error('Update question fetch error:', error);
                }
            }

            async function deleteQuestionFromBank(qId) {
                const user = window.firebaseAuth.currentUser;
                if (!user) { displayMessageBox("Not logged in.", 'error'); return; }
                const idToken = await user.getIdToken();

                try {
                    const response = await fetch('/delete_question_from_bank', {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${idToken}`
                        },
                        body: JSON.stringify({ question_id: qId })
                    });
                    const result = await response.json();
                    if (response.ok) {
                        displayMessageBox("Question deleted successfully!", 'success');
                        // Remove from local array and re-render
                        currentParsedQuestions = currentParsedQuestions.filter(q => q.firestore_id !== qId);
                        populateLeftPane(currentParsedQuestions);
                    } else {
                        displayMessageBox(`Failed to delete question: ${result.error || 'Unknown error'}`, 'error');
                    }
                } catch (error) {
                    displayMessageBox(`Network error deleting question: ${error.message}`, 'error');
                    console.error('Delete question fetch error:', error);
                }
            }


            // --- Drag and Drop Logic for Left Pane ---
            let draggedItem = null;

            function addDragDropListeners() {
                const questionCards = parsedQuestionsList.querySelectorAll('[draggable="true"]');
                questionCards.forEach(card => {
                    card.addEventListener('dragstart', (e) => {
                        draggedItem = card;
                        e.dataTransfer.effectAllowed = 'copy';
                        e.dataTransfer.setData('text/plain', card.dataset.questionId);
                        e.dataTransfer.setData('application/json', card.dataset.questionData);
                        setTimeout(() => {
                            card.classList.add('opacity-50', 'border-dashed', 'border-blue-500');
                        }, 0);
                    });

                    card.addEventListener('dragend', () => {
                        if (draggedItem) {
                            draggedItem.classList.remove('opacity-50', 'border-dashed', 'border-blue-500');
                        }
                        draggedItem = null;
                    });
                });
            }

            // --- QP Preview Rendering and Interaction Logic (Right Pane) ---
            function renderQPPreview() {
                qpPreviewList.innerHTML = ''; // Clear existing content

                if (currentQuestionPaper.length === 0) {
                    qpPreviewList.innerHTML = '<p class="text-gray-500">Add main questions above or drag questions here to create new ones.</p>';
                } else {
                    currentQuestionPaper.forEach((mainQ, mainQIndex) => {
                        const mainQElement = document.createElement('div');
                        mainQElement.className = 'qp-main-question';
                        mainQElement.dataset.mainQIndex = mainQIndex;
                        mainQElement.dataset.mainQId = mainQ.id;

                        mainQElement.innerHTML = `
                            <div class="flex justify-between items-center mb-2">
                                <h5 class="font-bold text-lg">
                                    Question <span contenteditable="true" class="inline-block min-w-[20px] qp-main-q-number">${mainQ.displayNum}</span> 
                                    <span class="text-gray-500 text-sm">(<input type="number" value="${mainQ.maxMarks}" min="1" max="100" class="qp-main-q-marks-input w-12 text-center border rounded"> Marks)</span>
                                </h5>
                                <div class="flex items-center space-x-2">
                                    <span class="qp-total-marks-for-q text-sm font-bold ${mainQ.totalMarks === mainQ.maxMarks ? 'text-green-600' : (mainQ.totalMarks > mainQ.maxMarks ? 'text-red-600' : 'text-orange-500')}">
                                        ${mainQ.totalMarks}/${mainQ.maxMarks}
                                    </span>
                                    <button class="remove-main-btn text-red-500 hover:text-red-700 text-xl" title="Remove Main Question">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="qp-sub-questions-container space-y-2 min-h-[50px] border border-dashed border-gray-300 p-2 rounded">
                                ${mainQ.subQuestions.length === 0 ? '<p class="text-gray-500 text-sm">Drag questions here or add manually.</p>' : ''}
                            </div>
                            <button class="add-sub-question-btn mt-3 px-3 py-1 text-xs bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition duration-200">
                                <i class="fas fa-plus mr-1"></i> Add Sub-question
                            </button>
                        `;
                        qpPreviewList.appendChild(mainQElement);

                        const subQuestionsContainer = mainQElement.querySelector('.qp-sub-questions-container');
                        mainQ.subQuestions.forEach((subQ, subQIndex) => {
                            const subQElement = createSubQuestionElement(subQ, mainQIndex, subQIndex);
                            subQuestionsContainer.appendChild(subQElement);
                        });
                    });
                }
                updateOverallTotalMarks();
                attachQPEventListeners(); // Re-attach listeners after rendering

                // Maintain equal pane sizes after content changes
                if (window.maintainEqualPaneSizes) {
                    window.maintainEqualPaneSizes();
                }
            }

            function createSubQuestionElement(qData, mainQIndex, subQIndex) {
                const subQElement = document.createElement('div');
                subQElement.className = 'qp-sub-question relative group';
                subQElement.dataset.mainQIndex = mainQIndex;
                subQElement.dataset.subQIndex = subQIndex;
                subQElement.dataset.questionId = qData.firestore_id || `temp-q-${Date.now()}-${Math.random()}`;
                subQElement.dataset.questionData = JSON.stringify(qData);

                const subPartLabel = String.fromCharCode(97 + subQIndex); // 'a', 'b', 'c'

                subQElement.innerHTML = `
                    <button class="remove-sub-btn"><i class="fas fa-times"></i></button>
                    <div class="flex items-start">
                        <span class="qp-question-number">${subPartLabel}.</span>
                        <span contenteditable="true" class="qp-question-text text-gray-800">${qData.question_text}</span>
                        <input type="number" value="${qData.marks}" class="qp-marks-input ml-2" min="0" max="25" data-sub-q-index="${subQIndex}">
                    </div>
                    <div class="text-xs text-gray-600 flex flex-wrap gap-2 mt-1 ml-6">
                        <span>CO: <span class="font-medium">${qData.co || 'N/A'}</span></span>
                        <span>Level: <span class="font-medium">${qData.blooms_level || 'N/A'}</span></span>
                        <span>Module: <span class="font-medium text-blue-600">${qData.module || 'N/A'}</span></span>
                        <button class="rephrase-btn px-2 py-0.5 text-xs bg-purple-500 text-white rounded-md hover:bg-purple-600 transition duration-200">
                            Rephrase
                        </button>
                    </div>
                `;
                return subQElement;
            }

            function updateOverallTotalMarks() {
                let overallCurrentTotal = 0;
                currentQuestionPaper.forEach(mainQ => {
                    // More robust total marks calculation
                    const totalMarks = mainQ.totalMarks;
                    if (typeof totalMarks === 'number' && !isNaN(totalMarks)) {
                        overallCurrentTotal += totalMarks;
                    } else {
                        console.warn('Invalid totalMarks for main question:', mainQ);
                    }
                });

                const overallMaxAllowedMarks = parseInt(overallMaxMarksInput.value) || 0;

                qpCurrentTotalMarksDisplay.textContent = overallCurrentTotal;
                overallMaxMarksInput.value = overallMaxAllowedMarks;

                qpCurrentTotalMarksDisplay.classList.remove('text-red-600', 'text-orange-500', 'text-green-600');
                if (overallCurrentTotal === overallMaxAllowedMarks && overallMaxAllowedMarks > 0) {
                    qpCurrentTotalMarksDisplay.classList.add('text-green-600');
                } else if (overallCurrentTotal > overallMaxAllowedMarks && overallMaxAllowedMarks > 0) {
                    qpCurrentTotalMarksDisplay.classList.add('text-red-600');
                } else {
                    qpCurrentTotalMarksDisplay.classList.add('text-orange-500');
                }
            }

            function updateMainQuestionMarks(mainQIndex) {
                const mainQ = currentQuestionPaper[mainQIndex];
                let currentMarks = 0;

                console.log('Updating marks for main question', mainQIndex);
                console.log('Sub-questions:', mainQ.subQuestions);

                mainQ.subQuestions.forEach((q, index) => {
                    // More robust marks parsing
                    const marks = q.marks;
                    let parsedMarks = 0;

                    console.log(`Sub-question ${index}: marks =`, marks, 'Type:', typeof marks);

                    if (typeof marks === 'number' && !isNaN(marks)) {
                        parsedMarks = marks;
                    } else if (typeof marks === 'string') {
                        parsedMarks = parseInt(marks.trim()) || 0;
                    }

                    console.log(`Sub-question ${index}: parsed marks =`, parsedMarks);
                    currentMarks += parsedMarks;
                });

                console.log('Total marks for main question:', currentMarks);
                mainQ.totalMarks = currentMarks;

                const mainQElement = qpPreviewList.querySelector(`[data-main-q-index="${mainQIndex}"]`);
                if (mainQElement) {
                    const marksDisplay = mainQElement.querySelector('.qp-total-marks-for-q');
                    if (marksDisplay) {
                        marksDisplay.textContent = `${currentMarks}/${mainQ.maxMarks}`;
                        marksDisplay.classList.remove('text-green-600', 'text-red-600', 'text-orange-500');
                        if (currentMarks === mainQ.maxMarks) {
                            marksDisplay.classList.add('text-green-600');
                        } else if (currentMarks > mainQ.maxMarks) {
                            marksDisplay.classList.add('text-red-600');
                        } else {
                            marksDisplay.classList.add('text-orange-500');
                        }
                    }
                }
                updateOverallTotalMarks();
            }

            // --- Event Listeners for QP Preview Pane ---
            function attachQPEventListeners() {
                // Drag over/leave/drop for main question containers
                qpPreviewList.querySelectorAll('.qp-main-question .qp-sub-questions-container').forEach(container => {
                    container.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'copy';
                        container.classList.add('border-blue-400', 'border-2', 'border-dashed');
                    });
                    container.addEventListener('dragleave', () => {
                        container.classList.remove('border-blue-400', 'border-2', 'border-dashed');
                    });
                    container.addEventListener('drop', (e) => {
                        e.preventDefault();
                        container.classList.remove('border-blue-400', 'border-2', 'border-dashed');

                        const questionDataStr = e.dataTransfer.getData('application/json');
                        if (questionDataStr) {
                            const questionData = JSON.parse(questionDataStr);
                            const mainQElement = e.target.closest('.qp-main-question');
                            if (mainQElement) {
                                const mainQIndex = parseInt(mainQElement.dataset.mainQIndex);
                                addQuestionToMainQuestion(questionData, mainQIndex);
                            }
                        }
                    });
                });

                // Add Sub-question button listeners (delegated)
                qpPreviewList.querySelectorAll('.add-sub-question-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const mainQElement = e.target.closest('.qp-main-question');
                        if (mainQElement) {
                            const mainQIndex = parseInt(mainQElement.dataset.mainQIndex);
                            const blankQuestion = {
                                firestore_id: `manual-${Date.now()}-${Math.random()}`,
                                question_text: "New sub-question text...",
                                co: "N/A",
                                blooms_level: "N/A",
                                marks: 0,
                                module: "1"
                            };
                            addQuestionToMainQuestion(blankQuestion, mainQIndex);
                        }
                    });
                });

                // Remove Sub-question button listeners (delegated)
                qpPreviewList.addEventListener('click', (e) => {
                    if (e.target.closest('.remove-sub-btn')) {
                        const subQElement = e.target.closest('.qp-sub-question');
                        if (subQElement) {
                            const mainQIndex = parseInt(subQElement.dataset.mainQIndex);
                            const subQIndex = parseInt(subQElement.dataset.subQIndex);
                            removeQuestionFromQP(mainQIndex, subQIndex);
                        }
                    }
                });

                // Remove Main Question button listeners (delegated)
                qpPreviewList.addEventListener('click', (e) => {
                    if (e.target.closest('.remove-main-btn')) {
                        const mainQElement = e.target.closest('.qp-main-question');
                        if (mainQElement) {
                            const mainQIndex = parseInt(mainQElement.dataset.mainQIndex);
                            removeMainQuestion(mainQIndex);
                        }
                    }
                });

                // Content editable for main question number and sub-question text
                qpPreviewList.querySelectorAll('.qp-main-q-number[contenteditable="true"], .qp-question-text[contenteditable="true"]').forEach(element => {
                    element.addEventListener('input', (e) => {
                        const mainQElement = e.target.closest('.qp-main-question');
                        if (!mainQElement) return;

                        const mainQIndex = parseInt(mainQElement.dataset.mainQIndex);

                        if (e.target.classList.contains('qp-main-q-number')) {
                            currentQuestionPaper[mainQIndex].displayNum = e.target.textContent;
                        } else if (e.target.classList.contains('qp-question-text')) {
                            const subQElement = e.target.closest('.qp-sub-question');
                            const subQIndex = parseInt(subQElement.dataset.subQIndex);
                            currentQuestionPaper[mainQIndex].subQuestions[subQIndex].question_text = e.target.textContent;
                            subQElement.dataset.questionData = JSON.stringify(currentQuestionPaper[mainQIndex].subQuestions[subQIndex]);
                        }
                    });
                });

                // Input for marks (sub-question) and main question max marks
                qpPreviewList.querySelectorAll('.qp-marks-input, .qp-main-q-marks-input').forEach(element => {
                    element.addEventListener('change', (e) => {
                        const mainQElement = e.target.closest('.qp-main-question');
                        if (!mainQElement) return;

                        const mainQIndex = parseInt(mainQElement.dataset.mainQIndex);
                        const newValue = parseInt(e.target.value) || 0;

                        if (e.target.classList.contains('qp-marks-input')) { // Sub-question marks
                            const subQElement = e.target.closest('.qp-sub-question');
                            const subQIndex = parseInt(subQElement.dataset.subQIndex);
                            currentQuestionPaper[mainQIndex].subQuestions[subQIndex].marks = newValue;
                            subQElement.dataset.questionData = JSON.stringify(currentQuestionPaper[mainQIndex].subQuestions[subQIndex]);
                            updateMainQuestionMarks(mainQIndex);
                        } else if (e.target.classList.contains('qp-main-q-marks-input')) { // Main question max marks
                            currentQuestionPaper[mainQIndex].maxMarks = newValue;
                            updateMainQuestionMarks(mainQIndex);
                        }
                    });
                });


                // Rephrase button listeners (delegated for QP items)
                qpPreviewList.addEventListener('click', async (e) => {
                    if (e.target.classList.contains('rephrase-btn')) {
                        const rephraseButton = e.target;
                        rephraseButton.disabled = true;
                        rephraseButton.textContent = 'Rephrasing...';

                        const itemToRephrase = e.target.closest('.qp-sub-question');
                        if (!itemToRephrase) {
                            displayMessageBox("Could not find question text to rephrase.", 'error');
                            rephraseButton.disabled = false;
                            rephraseButton.textContent = 'Rephrase';
                            return;
                        }

                        const currentQuestionData = JSON.parse(itemToRephrase.dataset.questionData);
                        const currentQuestionTextElement = itemToRephrase.querySelector('.qp-question-text');

                        if (!currentQuestionTextElement) {
                            displayMessageBox("Could not find question text to rephrase.", 'error');
                            rephraseButton.disabled = false;
                            rephraseButton.textContent = 'Rephrase';
                            return;
                        }

                        displayMessageBox("Rephrasing question... Please wait.", 'info', 5000);
                        try {
                            const user = window.firebaseAuth.currentUser;
                            if (!user) {
                                displayMessageBox("You must be logged in to rephrase questions.", 'error');
                                rephraseButton.disabled = false;
                                rephraseButton.textContent = 'Rephrase';
                                return;
                            }
                            const idToken = await user.getIdToken();

                            const response = await fetch('/rephrase_question', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${idToken}`
                                },
                                body: JSON.stringify({
                                    question_id: currentQuestionData.firestore_id,
                                    original_text: currentQuestionData.question_text
                                })
                            });

                            const result = await response.json();

                            if (response.ok) {
                                const rephrasedText = result.rephrased_text;
                                currentQuestionTextElement.textContent = rephrasedText;
                                // Update the stored data in the data model and dataset
                                const mainQIndex = parseInt(itemToRephrase.dataset.mainQIndex);
                                const subQIndex = parseInt(itemToRephrase.dataset.subQIndex);
                                currentQuestionPaper[mainQIndex].subQuestions[subQIndex].question_text = rephrasedText;
                                itemToRephrase.dataset.questionData = JSON.stringify(currentQuestionPaper[mainQIndex].subQuestions[subQIndex]);
                                displayMessageBox("Question rephrased successfully!", 'success');
                            } else {
                                displayMessageBox(`Rephrasing failed: ${result.error || 'Unknown error'}`, 'error');
                            }
                        } catch (error) {
                            displayMessageBox(`Network error during rephrasing: ${error.message}`, 'error');
                            console.error('Rephrasing fetch error:', error);
                        } finally {
                            rephraseButton.disabled = false;
                            rephraseButton.textContent = 'Rephrase';
                        }
                    }
                });

                // Overall Max Marks Input Listener
                if (overallMaxMarksInput) {
                    overallMaxMarksInput.addEventListener('change', () => {
                        updateOverallTotalMarks();
                    });
                }
            }


            // Function to add a question to a specific main question's sub-questions
            function addQuestionToMainQuestion(questionData, mainQIndex) {
                const mainQ = currentQuestionPaper[mainQIndex];
                if (!mainQ) {
                    displayMessageBox("Please add a main question first!", 'warning');
                    return;
                }
                // Assign a temporary unique ID if it's a new manual question
                if (!questionData.firestore_id) {
                    questionData.firestore_id = `manual-${Date.now()}-${Math.random()}`;
                }
                mainQ.subQuestions.push(questionData);
                updateMainQuestionMarks(mainQIndex);
                renderQPPreview(); // Re-render the entire preview
            }

            // Function to remove a sub-question from the data model and re-render
            function removeQuestionFromQP(mainQIndex, subQIndex) {
                const mainQ = currentQuestionPaper[mainQIndex];
                if (subQIndex >= 0 && subQIndex < mainQ.subQuestions.length) {
                    mainQ.subQuestions.splice(subQIndex, 1);
                    updateMainQuestionMarks(mainQIndex);
                    renderQPPreview(); // Re-render the entire preview
                }
            }

            // Function to remove an entire main question from the data model and re-render
            function removeMainQuestion(mainQIndex) {
                if (mainQIndex >= 0 && mainQIndex < currentQuestionPaper.length) {
                    currentQuestionPaper.splice(mainQIndex, 1);
                    // Re-index display numbers for remaining main questions
                    currentQuestionPaper.forEach((q, i) => q.displayNum = i + 1);
                    mainQuestionCounter = currentQuestionPaper.length; // Keep counter in sync
                    renderQPPreview();
                    updateOverallTotalMarks(); // Recalculate overall total
                }
            }

            // --- Add New Main Question Button Logic ---
            addMainQuestionBtn.addEventListener('click', () => {
                mainQuestionCounter++;
                const newMainQuestion = {
                    id: `main-q-${Date.now()}-${Math.random()}`,
                    displayNum: mainQuestionCounter,
                    maxMarks: 25,
                    subQuestions: [],
                    totalMarks: 0
                };
                currentQuestionPaper.push(newMainQuestion);
                renderQPPreview();
                displayMessageBox(`Added Question ${newMainQuestion.displayNum} to the paper.`, 'info');
            });

            // --- Update Latest Upload Info ---
            function updateLatestUploadInfo(filename, questionCount) {
                const latestUploadText = document.getElementById('latest-upload-text');
                if (latestUploadText) {
                    const now = new Date();
                    const timeString = now.toLocaleTimeString();
                    latestUploadText.textContent = `Latest: "${filename}" (${questionCount} questions) uploaded at ${timeString}`;
                }
            }

            // --- Pattern Selection Logic ---
            const patternSelect = document.getElementById('question-pattern-select');
            const patternDescription = document.getElementById('pattern-description');

            const patternDescriptions = {
                'standard': 'Standard: 4 questions with 3 sub-questions each, covering all modules',
                'cie1': 'CIE1: Q1 OR Q2 from Module 1 (25 marks each), Q3 & Q4 from Modules 2&3 (25 marks each)',
                'cie2': 'CIE2: Q1 OR Q2 from Module 4 (25 marks each), Q3 & Q4 from Modules 5&3 (25 marks each)'
            };

            patternSelect.addEventListener('change', (e) => {
                const selectedPattern = e.target.value;
                patternDescription.textContent = patternDescriptions[selectedPattern] || patternDescriptions['standard'];
            });

            // --- Generate Questions Button Logic ---
            const generateQuestionsBtn = document.getElementById('generate-questions-btn');
            generateQuestionsBtn.addEventListener('click', async () => {
                const user = window.firebaseAuth.currentUser;
                if (!user) {
                    displayMessageBox('Please log in to generate questions.', 'error');
                    return;
                }

                try {
                    generateQuestionsBtn.disabled = true;
                    generateQuestionsBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Generating...';

                    // Get the selected question source option
                    const questionSourceRadio = document.querySelector('input[name="question-source"]:checked');
                    const useLatestUploadOnly = questionSourceRadio ? questionSourceRadio.value === 'latest' : true;

                    // Get the selected pattern
                    const selectedPattern = patternSelect.value || 'standard';

                    const idToken = await user.getIdToken();
                    const response = await fetch('/generate_question_paper', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${idToken}`
                        },
                        body: JSON.stringify({
                            subject: 'Auto-Generated Paper',
                            modules: ['1', '2', '3'],
                            use_latest_upload_only: useLatestUploadOnly,
                            pattern: selectedPattern
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // Clear existing question paper
                        currentQuestionPaper.length = 0;
                        mainQuestionCounter = 0;

                        // Add generated questions to the paper
                        data.questions.forEach((mainQ, index) => {
                            mainQuestionCounter++;
                            const newMainQuestion = {
                                id: `main-q-${Date.now()}-${index}`,
                                displayNum: mainQuestionCounter,
                                maxMarks: 25,
                                subQuestions: mainQ.sub_questions.map(subQ => ({
                                    firestore_id: `generated-${Date.now()}-${Math.random()}`,
                                    question_text: subQ.question_text,
                                    marks: subQ.marks,
                                    co: subQ.co || 'N/A',
                                    blooms_level: subQ.blooms_level || 'L2',
                                    module: subQ.module || 'N/A'
                                }))
                            };
                            currentQuestionPaper.push(newMainQuestion);
                        });

                        renderQPPreview();

                        // Store paper ID for export functionality
                        if (data.paper_id) {
                            window.currentPaperId = data.paper_id;
                        }

                        // Show approval section and check status
                        showApprovalSection();
                        setTimeout(() => {
                            checkApprovalStatus();
                        }, 1000);

                        // Create detailed success message with source and pattern information
                        const sourceInfo = data.source_info || {};
                        const sourceText = sourceInfo.latest_upload_only
                            ? `from "${sourceInfo.source_file}"`
                            : 'from all uploaded question banks';
                        const questionCount = sourceInfo.total_questions_used || 'unknown';
                        const patternText = selectedPattern.toUpperCase();

                        displayMessageBox(
                            `âœ… Successfully generated ${patternText} pattern with ${data.questions.length} main questions (25 marks each) ${sourceText}! Used ${questionCount} questions from the question bank.`,
                            'success'
                        );
                    } else {
                        displayMessageBox(`Failed to generate questions: ${data.error || 'Unknown error'}`, 'error');
                    }
                } catch (error) {
                    console.error('Generate questions error:', error);
                    let errorMessage = 'âŒ Failed to generate question paper. ';

                    if (error.message.includes('network') || error.message.includes('fetch')) {
                        errorMessage += 'Please check your internet connection and try again.';
                    } else if (error.message.includes('quota')) {
                        errorMessage += 'Database quota exceeded. Please try again later.';
                    } else if (error.message.includes('No questions found')) {
                        errorMessage += 'No questions found in your question bank. Please upload questions first.';
                    } else {
                        errorMessage += `Error: ${error.message}`;
                    }

                    displayMessageBox(errorMessage, 'error');
                } finally {
                    generateQuestionsBtn.disabled = false;
                    generateQuestionsBtn.innerHTML = '<i class="fas fa-magic mr-1"></i> Generate Questions (Auto)';
                }
            });

            // --- Approval System Functionality ---

            // Show approval section when paper is generated
            function showApprovalSection() {
                const approvalSection = document.getElementById('approval-section');
                const exportButtons = document.getElementById('export-buttons');
                if (approvalSection) {
                    approvalSection.classList.remove('hidden');
                }
                if (exportButtons) {
                    exportButtons.classList.remove('hidden');
                }
            }

            // Hide approval section
            function hideApprovalSection() {
                const approvalSection = document.getElementById('approval-section');
                if (approvalSection) {
                    approvalSection.classList.add('hidden');
                }
            }

            // Update approval status display
            function updateApprovalStatus(status, details = {}) {
                const statusBadge = document.getElementById('approval-status-badge');
                const submitBtn = document.getElementById('submit-approval-btn');
                const approvalDetails = document.getElementById('approval-details');

                if (!statusBadge) return;

                // Update status badge
                statusBadge.className = 'px-3 py-1 rounded-full text-xs font-medium ';
                statusBadge.textContent = status.replace('_', ' ').toUpperCase();

                switch (status) {
                    case 'not_submitted':
                        statusBadge.className += 'bg-gray-100 text-gray-800';
                        if (submitBtn) submitBtn.style.display = 'block';
                        if (approvalDetails) approvalDetails.classList.add('hidden');
                        break;
                    case 'pending_approval':
                        statusBadge.className += 'bg-yellow-100 text-yellow-800';
                        if (submitBtn) submitBtn.style.display = 'none';
                        if (approvalDetails) {
                            approvalDetails.classList.remove('hidden');
                            document.getElementById('approval-submitted-at').textContent =
                                `Submitted: ${new Date(details.submitted_at?.seconds * 1000).toLocaleString()}`;
                        }
                        break;
                    case 'approved':
                        statusBadge.className += 'bg-green-100 text-green-800';
                        if (submitBtn) submitBtn.style.display = 'none';
                        if (approvalDetails) {
                            approvalDetails.classList.remove('hidden');
                            document.getElementById('approval-approved-by').textContent =
                                `Approved by: ${details.approved_by}`;
                        }
                        break;
                    case 'revision_requested':
                        statusBadge.className += 'bg-red-100 text-red-800';
                        if (submitBtn) submitBtn.style.display = 'block';
                        if (approvalDetails) {
                            approvalDetails.classList.remove('hidden');
                            document.getElementById('approval-comments').textContent =
                                `HOD Comments: ${details.hod_comments}`;
                        }
                        break;
                }
            }

            // Check approval status for current paper
            async function checkApprovalStatus() {
                if (!window.currentPaperId) return;

                try {
                    const user = window.firebaseAuth.currentUser;
                    if (!user) return;

                    const idToken = await user.getIdToken();
                    const response = await fetch(`/get_approval_status?paper_id=${window.currentPaperId}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${idToken}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        updateApprovalStatus(data.status, data);
                    }
                } catch (error) {
                    console.error('Error checking approval status:', error);
                }
            }

            // Submit for approval
            async function submitForApproval() {
                if (!window.currentPaperId) {
                    displayMessageBox('No paper generated yet. Please generate a question paper first.', 'warning');
                    return;
                }

                try {
                    const user = window.firebaseAuth.currentUser;
                    if (!user) {
                        displayMessageBox('Please log in to submit for approval.', 'error');
                        return;
                    }

                    const comments = document.getElementById('approval-comments').value;
                    const idToken = await user.getIdToken();

                    const response = await fetch('/submit_for_approval', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${idToken}`
                        },
                        body: JSON.stringify({
                            paper_id: window.currentPaperId,
                            comments: comments
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        displayMessageBox(data.message, 'success');
                        closeModal('approval-modal');
                        updateApprovalStatus('pending_approval', { submitted_at: { seconds: Date.now() / 1000 } });
                    } else {
                        displayMessageBox(data.error || 'Failed to submit for approval', 'error');
                    }
                } catch (error) {
                    console.error('Error submitting for approval:', error);
                    displayMessageBox('Failed to submit for approval. Please try again.', 'error');
                }
            }

            // Event listeners for approval system
            document.addEventListener('DOMContentLoaded', () => {
                // Submit for approval button
                const submitApprovalBtn = document.getElementById('submit-approval-btn');
                if (submitApprovalBtn) {
                    submitApprovalBtn.addEventListener('click', () => {
                        showModal('approval-modal');
                    });
                }

                // Confirm approval submission
                const confirmApprovalBtn = document.getElementById('confirm-approval-btn');
                if (confirmApprovalBtn) {
                    confirmApprovalBtn.addEventListener('click', submitForApproval);
                }

                // Export buttons
                const exportDocxBtn = document.getElementById('export-docx-btn');
                const exportPdfBtn = document.getElementById('export-pdf-btn');

                if (exportDocxBtn) {
                    exportDocxBtn.addEventListener('click', async () => {
                        if (!window.currentPaperId) {
                            displayMessageBox('No paper generated yet. Please generate a question paper first.', 'warning');
                            return;
                        }

                        try {
                            const user = window.firebaseAuth.currentUser;
                            if (!user) {
                                displayMessageBox('Please log in to export.', 'error');
                                return;
                            }

                            const idToken = await user.getIdToken();
                            const response = await fetch('/export_question_paper', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${idToken}`
                                },
                                body: JSON.stringify({
                                    paper_id: window.currentPaperId,
                                    format: 'docx'
                                })
                            });

                            const data = await response.json();
                            if (response.ok) {
                                displayMessageBox('DOCX exported successfully!', 'success');
                                // Here you could trigger a download
                            } else {
                                displayMessageBox(data.error || 'Failed to export DOCX', 'error');
                            }
                        } catch (error) {
                            console.error('Error exporting DOCX:', error);
                            displayMessageBox('Failed to export DOCX. Please try again.', 'error');
                        }
                    });
                }

                if (exportPdfBtn) {
                    exportPdfBtn.addEventListener('click', async () => {
                        if (!window.currentPaperId) {
                            displayMessageBox('No paper generated yet. Please generate a question paper first.', 'warning');
                            return;
                        }

                        try {
                            const user = window.firebaseAuth.currentUser;
                            if (!user) {
                                displayMessageBox('Please log in to export.', 'error');
                                return;
                            }

                            const idToken = await user.getIdToken();
                            const response = await fetch('/export_question_paper', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${idToken}`
                                },
                                body: JSON.stringify({
                                    paper_id: window.currentPaperId,
                                    format: 'pdf'
                                })
                            });

                            const data = await response.json();
                            if (response.ok) {
                                displayMessageBox('PDF exported successfully!', 'success');
                                // Here you could trigger a download
                            } else {
                                displayMessageBox(data.error || 'Failed to export PDF', 'error');
                            }
                        } catch (error) {
                            console.error('Error exporting PDF:', error);
                            displayMessageBox('Failed to export PDF. Please try again.', 'error');
                        }
                    });
                }
            });

            // --- Generate Final Document Function (shared by both DOCX and PDF buttons) ---
            const generateFinalDocument = async (format = 'docx') => {
                const user = window.firebaseAuth.currentUser;
                if (!user) {
                    displayMessageBox('Please log in to generate the final document.', 'error');
                    return;
                }

                if (currentQuestionPaper.length === 0) {
                    displayMessageBox('Please add questions to the question paper first.', 'warning');
                    return;
                }

                const isDocx = format === 'docx';
                const btn = isDocx ? document.getElementById('generate-final-docx-btn') : document.getElementById('generate-final-pdf-btn');
                const originalText = isDocx ? '<i class="fas fa-file-word mr-1"></i> Generate DOCX' : '<i class="fas fa-file-pdf mr-1"></i> Generate PDF';
                const loadingText = `<i class="fas fa-spinner fa-spin mr-1"></i> Generating ${format.toUpperCase()}...`;
                const fileName = `Generated_Question_Paper.${format}`;

                try {
                    btn.disabled = true;
                    btn.innerHTML = loadingText;

                    const idToken = await user.getIdToken();

                    // Prepare metadata
                    const metadata = {
                        dept: 'CSE',
                        sem: '7',
                        div: 'A',
                        course: 'AIML',
                        elective: 'NLP',
                        date: new Date().toISOString().split('T')[0],
                        time: '3 Hrs',
                        code: '18CS71'
                    };

                    // Calculate total marks
                    const totalMarks = currentQuestionPaper.reduce((sum, mainQ) => sum + (mainQ.maxMarks || 25), 0);

                    const response = await fetch('/generate_final_document', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${idToken}`
                        },
                        body: JSON.stringify({
                            question_paper_data: currentQuestionPaper,
                            overall_max_marks: totalMarks,
                            metadata: metadata,
                            format: format
                        })
                    });

                    if (response.ok) {
                        // Handle file download
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = fileName;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);

                        // Add to recent QPs after successful generation
                        addGeneratedPaperToRecent(format, fileName);

                        displayMessageBox(`Question paper ${format.toUpperCase()} generated and downloaded successfully!`, 'success');
                    } else {
                        const errorData = await response.json();
                        displayMessageBox(`Failed to generate ${format.toUpperCase()}: ${errorData.error || 'Unknown error'}`, 'error');
                    }
                } catch (error) {
                    displayMessageBox(`Network error: ${error.message}`, 'error');
                    console.error(`Generate final ${format} error:`, error);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            };

            // --- Generate Final DOCX Button Logic ---
            const generateFinalDocxBtn = document.getElementById('generate-final-docx-btn');
            generateFinalDocxBtn.addEventListener('click', () => generateFinalDocument('docx'));

            // --- Generate Final PDF Button Logic ---
            const generateFinalPdfBtn = document.getElementById('generate-final-pdf-btn');
            generateFinalPdfBtn.addEventListener('click', () => generateFinalDocument('pdf'));

            // --- Save Question Paper Button Logic ---
            const saveQuestionPaperBtn = document.getElementById('save-question-paper-btn');
            saveQuestionPaperBtn.addEventListener('click', () => saveCurrentQuestionPaper());



            // --- Save Current Question Paper Function ---
            const saveCurrentQuestionPaper = async () => {
                if (currentQuestionPaper.length === 0) {
                    displayMessageBox('Please add questions to the question paper before saving.', 'warning');
                    return;
                }

                // Get current requirements for metadata
                const requirements = getCurrentRequirements();

                // Create a unique ID for this question paper
                const qpId = generateId();
                const timestamp = new Date().toISOString();

                // Calculate total marks
                const totalMarks = currentQuestionPaper.reduce((sum, mainQ) => sum + (mainQ.maxMarks || 25), 0);

                // Create question paper object
                const questionPaperData = {
                    id: qpId,
                    name: requirements.subject ? `${requirements.subject} - Question Paper` : 'Untitled Question Paper',
                    subject: requirements.subject || 'Unknown Subject',
                    courseCode: requirements.courseCode || '',
                    department: requirements.department || '',
                    semester: requirements.semester || '',
                    examType: requirements.examType || 'Regular',
                    duration: requirements.duration || '3 hours',
                    maxMarks: totalMarks,
                    createdDate: timestamp,
                    lastModified: timestamp,
                    questions: JSON.parse(JSON.stringify(currentQuestionPaper)), // Deep copy
                    metadata: {
                        totalQuestions: currentQuestionPaper.length,
                        totalMarks: totalMarks,
                        questionDistribution: getQuestionDistribution(),
                        bloomsDistribution: getBloomsDistribution(),
                        moduleDistribution: getModuleDistribution()
                    },
                    status: 'draft',
                    tags: generateTags(requirements)
                };

                try {
                    // Save to Firestore via backend
                    const user = window.firebaseAuth.currentUser;
                    if (!user) {
                        displayMessageBox('Please log in to save question papers.', 'error');
                        return;
                    }

                    const idToken = await user.getIdToken();
                    const response = await fetch('/save_question_paper', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${idToken}`
                        },
                        body: JSON.stringify(questionPaperData)
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // Also save to localStorage as backup
                        const savedQPs = JSON.parse(localStorage.getItem('saved-question-papers') || '[]');
                        savedQPs.unshift(questionPaperData);
                        localStorage.setItem('saved-question-papers', JSON.stringify(savedQPs));

                        // Add to recent QPs
                        addToRecentQPs(questionPaperData);

                        // Update UI
                        displayMessageBox(`âœ… Question paper "${questionPaperData.name}" saved successfully!`, 'success');
                    } else {
                        throw new Error(data.error || 'Failed to save to server');
                    }

                    // Update save button to show saved state
                    const saveBtn = document.getElementById('save-question-paper-btn');
                    if (saveBtn) {
                        saveBtn.innerHTML = '<i class="fas fa-check mr-1"></i> Saved!';
                        saveBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                        saveBtn.classList.add('bg-green-500');

                        // Reset button after 3 seconds
                        setTimeout(() => {
                            saveBtn.innerHTML = '<i class="fas fa-save mr-1"></i> Save Question Paper';
                            saveBtn.classList.remove('bg-green-500');
                            saveBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                        }, 3000);
                    }

                    // Force refresh both saved and recent content (regardless of visibility)
                    setTimeout(() => {
                        // Refresh saved content
                        if (typeof loadSavedItems === 'function') {
                            loadSavedItems();
                            if (typeof updateSavedStatistics === 'function') updateSavedStatistics();
                            if (typeof renderSavedItems === 'function') renderSavedItems();
                        }

                        // Refresh recent content
                        if (typeof loadRecentQPs === 'function') {
                            loadRecentQPs();
                            if (typeof updateRecentStatistics === 'function') updateRecentStatistics();
                            if (typeof renderRecentQPs === 'function') renderRecentQPs();
                        }

                    }, 100);

                } catch (error) {
                    console.error('Error saving question paper:', error);
                    let errorMessage = 'âŒ Failed to save question paper. ';

                    if (error.message.includes('network') || error.message.includes('fetch')) {
                        errorMessage += 'Please check your internet connection and try again.';
                    } else if (error.message.includes('quota')) {
                        errorMessage += 'Database quota exceeded. Please try again later.';
                    } else {
                        errorMessage += 'Please try again.';
                    }

                    displayMessageBox(errorMessage, 'error');
                }
            };

            // Helper function to get current requirements
            const getCurrentRequirements = () => {
                return {
                    subject: document.getElementById('subject')?.value || '',
                    courseCode: document.getElementById('course-code')?.value || '',
                    department: document.getElementById('department')?.value || '',
                    semester: document.getElementById('semester')?.value || '',
                    examType: document.getElementById('exam-type')?.value || 'Regular',
                    duration: document.getElementById('duration')?.value || '3 hours',
                    maxMarks: document.getElementById('max-marks')?.value || '100'
                };
            };

            // Helper function to get question distribution
            const getQuestionDistribution = () => {
                const distribution = {};
                currentQuestionPaper.forEach((mainQ, index) => {
                    distribution[`Q${index + 1}`] = {
                        subQuestions: mainQ.subQuestions ? mainQ.subQuestions.length : 0,
                        totalMarks: mainQ.maxMarks || 25
                    };
                });
                return distribution;
            };

            // Helper function to get Bloom's taxonomy distribution
            const getBloomsDistribution = () => {
                const distribution = {};
                currentQuestionPaper.forEach(mainQ => {
                    if (mainQ.subQuestions) {
                        mainQ.subQuestions.forEach(subQ => {
                            const blooms = subQ.blooms_level || 'Unknown';
                            distribution[blooms] = (distribution[blooms] || 0) + 1;
                        });
                    }
                });
                return distribution;
            };

            // Helper function to get module distribution
            const getModuleDistribution = () => {
                const distribution = {};
                currentQuestionPaper.forEach(mainQ => {
                    if (mainQ.subQuestions) {
                        mainQ.subQuestions.forEach(subQ => {
                            const module = subQ.module || 'Unknown';
                            distribution[`Module ${module}`] = (distribution[`Module ${module}`] || 0) + 1;
                        });
                    }
                });
                return distribution;
            };

            // Helper function to generate tags
            const generateTags = (requirements) => {
                const tags = [];
                if (requirements.subject) tags.push(requirements.subject);
                if (requirements.department) tags.push(requirements.department);
                if (requirements.semester) tags.push(`Sem ${requirements.semester}`);
                if (requirements.examType) tags.push(requirements.examType);
                return tags;
            };

            // Helper function to add to recent QPs
            const addToRecentQPs = (questionPaperData) => {
                const storedRecentQPs = JSON.parse(localStorage.getItem('recent-generated-qps') || '[]');

                const recentQP = {
                    id: questionPaperData.id,
                    name: questionPaperData.name,
                    subject: questionPaperData.subject,
                    courseCode: questionPaperData.courseCode,
                    department: questionPaperData.department,
                    generatedDate: questionPaperData.createdDate,
                    totalMarks: questionPaperData.maxMarks,
                    totalQuestions: questionPaperData.questions.length,
                    status: 'saved',
                    type: 'manual',
                    downloadCount: 0,
                    size: Math.round(JSON.stringify(questionPaperData).length / 1024 * 100) / 100, // KB
                    tags: questionPaperData.tags || []
                };

                storedRecentQPs.unshift(recentQP);

                // Keep only last 50 recent QPs
                if (storedRecentQPs.length > 50) {
                    storedRecentQPs.splice(50);
                }

                localStorage.setItem('recent-generated-qps', JSON.stringify(storedRecentQPs));

                // Update the global recentQPs array as well
                window.recentQPs = storedRecentQPs;
            };

            // Helper function to add generated papers to recent QPs
            const addGeneratedPaperToRecent = (format, fileName) => {
                const requirements = getCurrentRequirements();
                const timestamp = new Date().toISOString();
                const totalMarks = currentQuestionPaper.reduce((sum, mainQ) => sum + (mainQ.maxMarks || 25), 0);

                const recentQP = {
                    id: generateId(),
                    name: requirements.subject ? `${requirements.subject} - ${format.toUpperCase()}` : fileName,
                    subject: requirements.subject || 'Unknown Subject',
                    courseCode: requirements.courseCode || '',
                    department: requirements.department || '',
                    generatedDate: timestamp,
                    totalMarks: totalMarks,
                    totalQuestions: currentQuestionPaper.length,
                    status: 'generated',
                    type: 'generated',
                    format: format.toUpperCase(),
                    downloadCount: 1, // Already downloaded
                    size: Math.round(JSON.stringify(currentQuestionPaper).length / 1024 * 100) / 100, // KB
                    tags: generateTags(requirements),
                    fileName: fileName
                };

                const recentQPs = JSON.parse(localStorage.getItem('recent-generated-qps') || '[]');
                recentQPs.unshift(recentQP);

                // Keep only last 50 recent QPs
                if (recentQPs.length > 50) {
                    recentQPs.splice(50);
                }

                localStorage.setItem('recent-generated-qps', JSON.stringify(recentQPs));

                // Update the global recentQPs array as well
                window.recentQPs = recentQPs;

                // Update recent content if it's currently visible
                if (recentContent && !recentContent.classList.contains('hidden')) {
                    loadRecentQPs();
                    updateRecentStatistics();
                    renderRecentQPs();
                }
            };

            // --- "Add to QP" button on left pane questions ---
            parsedQuestionsList.addEventListener('click', (e) => {
                if (e.target.classList.contains('add-to-qp-btn')) {
                    const questionCard = e.target.closest('[data-question-data]');
                    if (questionCard) {
                        const questionData = JSON.parse(questionCard.dataset.questionData);

                        // Debug: Log the question data to see what's being passed
                        console.log('Adding question to QP:', questionData);
                        console.log('Question marks:', questionData.marks, 'Type:', typeof questionData.marks);

                        // For now, add to the first main question.
                        // Later, we can add a modal to ask where to place it.
                        if (currentQuestionPaper.length === 0) {
                            displayMessageBox("Please add a main question first!", 'warning');
                        } else {
                            addQuestionToMainQuestion(questionData, 0); // Add to first main question (index 0)
                            displayMessageBox(`Question added to Question 1.`, 'info');
                        }
                    }
                }
            });


            // --- Fetch Protected Data (for example purposes) ---
            const fetchProtectedData = async () => {
                const user = window.firebaseAuth.currentUser;
                if (!user) { return; }

                try {
                    const idToken = await user.getIdToken();
                    const response = await fetch('http://127.0.0.1:5000/protected_data', {
                        method: 'GET',
                        headers: { 'Authorization': `Bearer ${idToken}` },
                    });
                    const data = await response.json();
                    if (response.ok) { console.log('Protected data fetched:', data); }
                    else { console.error('Failed to fetch protected data:', data.message || 'Unknown error'); }
                } catch (error) {
                    console.error('Network or server error fetching protected data:', error);
                }
            };


            // --- Logout Functionality ---
            dropdownSignOutBtn.addEventListener('click', async (event) => {
                event.preventDefault();
                try {
                    await window.firebaseAuth.signOut();
                    console.log('User signed out.');
                    displayMessageBox('You have been logged out.', 'success');
                    setTimeout(() => { window.location.href = '/login'; }, 1500);
                } catch (error) {
                    console.error('Error signing out:', error);
                    displayMessageBox('Failed to log out. Please try again.', 'error');
                }
            });

            // --- Placeholder for Delete Account / Add Account ---
            dropdownDeleteAccountBtn.addEventListener('click', (event) => { event.preventDefault(); displayMessageBox('Delete Account functionality is a placeholder. This requires careful implementation!', 'info'); });
            dropdownAddAccountBtn.addEventListener('click', (event) => { event.preventDefault(); displayMessageBox('Add Account / Sign In functionality is a placeholder. This usually redirects to login/signup.', 'info'); window.location.href = '/login'; });


            // --- Theme Toggle Logic (Light/Dark Mode) ---
            const applyTheme = (isDark) => {
                if (isDark) { document.body.classList.add('dark'); localStorage.setItem('theme', 'dark'); }
                else { document.body.classList.remove('dark'); localStorage.setItem('theme', 'light'); }
            };
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') { themeToggle.checked = true; applyTheme(true); }
            else { themeToggle.checked = false; applyTheme(false); }
            themeToggle.addEventListener('change', () => { applyTheme(themeToggle.checked); });

            // --- Setup Role Switching Listeners ---
            setupRoleSwitchingListeners();

            // --- Firebase Auth & User Info Display ---
            const avatarColors = ['bg-avatar-1', 'bg-avatar-2', 'bg-avatar-3', 'bg-avatar-4', 'bg-avatar-5', 'bg-avatar-6', 'bg-avatar-7'];
            const getAvatarColorClass = (email) => {
                let hash = 0; for (let i = 0; i < email.length; i++) { hash = email.charCodeAt(i) + ((hash << 5) - hash); }
                const index = Math.abs(hash % avatarColors.length);
                return avatarColors[index];
            };

            window.firebaseAuth.onAuthStateChanged(async (user) => {
                if (user) {
                    const username = user.displayName || user.email.split('@')[0];
                    document.getElementById('welcome-message').textContent = `Welcome, ${username}!`;
                    const initial = username.charAt(0).toUpperCase();
                    accountInitial.textContent = initial;
                    accountAvatarCircle.classList.remove(...avatarColors);
                    accountAvatarCircle.classList.add(getAvatarColorClass(user.email));
                    dropdownEmail.textContent = user.email || 'N/A';
                    dropdownUsername.textContent = username;
                    console.log("User is logged in and state is confirmed:", user.uid, user.email);
                    // After user is authenticated, attempt to load their existing questions
                    await loadUserQuestions();
                } else {
                    console.log("No user logged in, redirecting to login page.");
                    displayMessageBox("You are not logged in. Please log in to access the dashboard.", 'warning');
                    setTimeout(() => { window.location.href = '/login'; }, 1500);
                }
            });

            // --- Load User Questions from Firestore on Auth State Change ---
            async function loadUserQuestions() {
                const user = window.firebaseAuth.currentUser;
                if (!user) return;

                try {
                    const idToken = await user.getIdToken();
                    const response = await fetch('/get_user_questions', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${idToken}`
                        }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        currentParsedQuestions = data.questions;
                        populateLeftPane(currentParsedQuestions);
                        displayMessageBox(`Loaded ${currentParsedQuestions.length} questions from your bank.`, 'success');
                    } else {
                        displayMessageBox(`Failed to load questions: ${data.error || 'Unknown error'}`, 'error');
                    }
                } catch (error) {
                    displayMessageBox(`Network error loading questions: ${error.message}`, 'error');
                    console.error('Load questions fetch error:', error);
                }
            }


            // --- Settings Section Collapsible Logic (using Flowbite's Collapse component) ---
            document.querySelectorAll('[data-collapse-toggle]').forEach(trigger => {
                const targetEl = document.getElementById(trigger.getAttribute('data-collapse-toggle'));
                if (targetEl) {
                    new Flowbite.Collapse(targetEl, trigger);
                    trigger.addEventListener('click', () => {
                        const icon = trigger.querySelector('.fas.fa-chevron-down');
                        if (icon) { icon.classList.toggle('rotate-180'); }
                    });
                }
            });

            // --- Custom Message Box (instead of alert/confirm) ---
            function displayMessageBox(message, type = 'info', duration = 3000) {
                let bgColor = 'bg-blue-500';
                if (type === 'success') bgColor = 'bg-green-500';
                else if (type === 'error') bgColor = 'bg-red-500';
                else if (type === 'warning') bgColor = 'bg-yellow-500';

                const messageBox = document.createElement('div');
                messageBox.className = `fixed bottom-4 right-4 p-4 rounded-lg text-white shadow-lg z-50 ${bgColor}`;
                messageBox.textContent = message;
                document.body.appendChild(messageBox);

                setTimeout(() => {
                    messageBox.remove();
                }, duration);
            }

            // --- Splitter (Resizable Panes) Logic ---
            const leftPane = document.getElementById('left-pane');
            const rightPane = document.getElementById('right-pane');
            const splitter = document.getElementById('splitter');
            const qpEditorFlexContainer = document.querySelector('.qp-editor-flex-container'); // Get the direct parent of panes

            let isDragging = false;

            if (splitter && leftPane && rightPane && qpEditorFlexContainer) {
                // Initialize panes to equal sizes
                function resetPanesToEqual() {
                    leftPane.style.flex = '1 1 0';
                    rightPane.style.flex = '1 1 0';
                    leftPane.style.width = '';
                    rightPane.style.width = '';
                    leftPane.style.minWidth = '0';
                    rightPane.style.minWidth = '0';
                    leftPane.style.maxWidth = 'none';
                    rightPane.style.maxWidth = 'none';
                }

                // Function to maintain equal sizes after content changes
                function maintainEqualSizes() {
                    // Use requestAnimationFrame to ensure DOM has updated
                    requestAnimationFrame(() => {
                        resetPanesToEqual();

                        // Add a subtle visual feedback (optional)
                        leftPane.style.transition = 'flex 0.2s ease';
                        rightPane.style.transition = 'flex 0.2s ease';

                        // Remove transition after animation
                        setTimeout(() => {
                            leftPane.style.transition = '';
                            rightPane.style.transition = '';
                        }, 200);
                    });
                }

                // Reset to equal sizes on load
                resetPanesToEqual();

                // Make the function globally available for use after content updates
                window.maintainEqualPaneSizes = maintainEqualSizes;

                // Set up MutationObserver to automatically maintain equal sizes when content changes
                const observer = new MutationObserver((mutations) => {
                    let shouldMaintainSizes = false;
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'childList' &&
                            (mutation.target === leftPane || mutation.target === rightPane ||
                                mutation.target.closest('#left-pane') || mutation.target.closest('#right-pane'))) {
                            shouldMaintainSizes = true;
                        }
                    });
                    if (shouldMaintainSizes) {
                        maintainEqualSizes();
                    }
                });

                // Start observing changes in both panes
                observer.observe(leftPane, { childList: true, subtree: true });
                observer.observe(rightPane, { childList: true, subtree: true });

                splitter.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    // Add class to body to prevent text selection during drag
                    document.body.classList.add('select-none');
                    // Capture pointer outside of splitter too
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });

                // Double-click splitter to reset to equal sizes
                splitter.addEventListener('dblclick', (e) => {
                    resetPanesToEqual();
                });

                function onMouseMove(e) {
                    if (!isDragging) return;

                    const containerWidth = qpEditorFlexContainer.offsetWidth;
                    const containerLeft = qpEditorFlexContainer.getBoundingClientRect().left;

                    let newLeftWidth = e.clientX - containerLeft;

                    // Convert to percentage
                    let newLeftPercent = (newLeftWidth / containerWidth) * 100;

                    // Apply min-width constraints (based on 25% of container)
                    const minWidthPercent = 25; // As defined in HTML inline style
                    if (newLeftPercent < minWidthPercent) {
                        newLeftPercent = minWidthPercent;
                    }
                    if (newLeftPercent > (100 - minWidthPercent)) {
                        newLeftPercent = (100 - minWidthPercent);
                    }

                    // Update the flex property to override the default flex: 1
                    leftPane.style.flex = `0 0 ${newLeftPercent}%`;
                    rightPane.style.flex = `0 0 ${100 - newLeftPercent}%`;
                }

                function onMouseUp() {
                    isDragging = false;
                    document.body.classList.remove('select-none');
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                }
            }

            // --- Requirements for QP Functionality ---

            // Global requirements object to store current requirements
            let currentRequirements = {};

            // Get all requirement form elements
            const requirementsForm = document.getElementById('qp-requirements-form');
            const validateBtn = document.getElementById('validate-requirements-btn');
            const resetBtn = document.getElementById('reset-requirements-btn');
            const previewBtn = document.getElementById('preview-requirements-btn');
            const applyBtn = document.getElementById('apply-requirements-btn');
            const saveTemplateBtn = document.getElementById('save-template-btn');
            const loadTemplateBtn = document.getElementById('load-template-btn');
            const requirementsSummary = document.getElementById('requirements-summary');
            const summaryContent = document.getElementById('summary-content');

            // Bloom's taxonomy validation
            function validateBloomsTaxonomy() {
                const l1 = parseInt(document.getElementById('req-l1-percent').value) || 0;
                const l2 = parseInt(document.getElementById('req-l2-percent').value) || 0;
                const l3 = parseInt(document.getElementById('req-l3-percent').value) || 0;
                const l4 = parseInt(document.getElementById('req-l4-percent').value) || 0;
                const l5 = parseInt(document.getElementById('req-l5-percent').value) || 0;
                const l6 = parseInt(document.getElementById('req-l6-percent').value) || 0;

                const total = l1 + l2 + l3 + l4 + l5 + l6;
                document.getElementById('blooms-total').textContent = total;

                const validation = document.getElementById('blooms-validation');
                if (total === 100) {
                    validation.textContent = 'âœ“ Valid';
                    validation.className = 'ml-4 text-sm text-green-600 font-semibold';
                    return true;
                } else {
                    validation.textContent = `âš  Must total 100% (currently ${total}%)`;
                    validation.className = 'ml-4 text-sm text-red-600 font-semibold';
                    return false;
                }
            }

            // CO weight validation
            function validateCOWeights() {
                const co1 = parseInt(document.getElementById('req-co1-weight').value) || 0;
                const co2 = parseInt(document.getElementById('req-co2-weight').value) || 0;
                const co3 = parseInt(document.getElementById('req-co3-weight').value) || 0;
                const co4 = parseInt(document.getElementById('req-co4-weight').value) || 0;
                const co5 = parseInt(document.getElementById('req-co5-weight').value) || 0;

                const total = co1 + co2 + co3 + co4 + co5;
                document.getElementById('co-total').textContent = total;

                const validation = document.getElementById('co-validation');
                if (total === 100) {
                    validation.textContent = 'âœ“ Valid';
                    validation.className = 'ml-4 text-sm text-green-600 font-semibold';
                    return true;
                } else {
                    validation.textContent = `âš  Must total 100% (currently ${total}%)`;
                    validation.className = 'ml-4 text-sm text-red-600 font-semibold';
                    return false;
                }
            }

            // Add event listeners for real-time validation
            ['req-l1-percent', 'req-l2-percent', 'req-l3-percent', 'req-l4-percent', 'req-l5-percent', 'req-l6-percent'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', validateBloomsTaxonomy);
                }
            });

            ['req-co1-weight', 'req-co2-weight', 'req-co3-weight', 'req-co4-weight', 'req-co5-weight'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', validateCOWeights);
                }
            });

            // Initial validation
            validateBloomsTaxonomy();
            validateCOWeights();

            // Collect all requirements from form
            function collectRequirements() {
                const formData = new FormData(requirementsForm);
                const requirements = {};

                // Basic Information
                requirements.subject = document.getElementById('req-subject').value;
                requirements.subjectCode = document.getElementById('req-subject-code').value;
                requirements.department = document.getElementById('req-department').value;
                requirements.semester = document.getElementById('req-semester').value;
                requirements.academicYear = document.getElementById('req-academic-year').value;
                requirements.examType = document.getElementById('req-exam-type').value;

                // Exam Details
                requirements.duration = document.getElementById('req-duration').value;
                requirements.totalMarks = document.getElementById('req-total-marks').value;
                requirements.examDate = document.getElementById('req-exam-date').value;
                requirements.examTime = document.getElementById('req-exam-time').value;

                // Question Distribution
                requirements.questionPattern = document.getElementById('req-question-pattern').value;
                requirements.numModules = document.getElementById('req-num-modules').value;
                requirements.moduleCoverage = document.getElementById('req-module-coverage').value;
                requirements.distributionRule = document.getElementById('req-distribution-rule').value;

                // Bloom's Taxonomy
                requirements.bloomsTaxonomy = {
                    l1: parseInt(document.getElementById('req-l1-percent').value) || 0,
                    l2: parseInt(document.getElementById('req-l2-percent').value) || 0,
                    l3: parseInt(document.getElementById('req-l3-percent').value) || 0,
                    l4: parseInt(document.getElementById('req-l4-percent').value) || 0,
                    l5: parseInt(document.getElementById('req-l5-percent').value) || 0,
                    l6: parseInt(document.getElementById('req-l6-percent').value) || 0
                };

                // Course Outcomes
                requirements.courseOutcomes = {
                    co1: parseInt(document.getElementById('req-co1-weight').value) || 0,
                    co2: parseInt(document.getElementById('req-co2-weight').value) || 0,
                    co3: parseInt(document.getElementById('req-co3-weight').value) || 0,
                    co4: parseInt(document.getElementById('req-co4-weight').value) || 0,
                    co5: parseInt(document.getElementById('req-co5-weight').value) || 0
                };

                // Additional Requirements
                requirements.selectionStrategy = document.getElementById('req-selection-strategy').value;
                requirements.difficultyLevel = document.getElementById('req-difficulty-level').value;
                requirements.specialInstructions = document.getElementById('req-special-instructions').value;

                return requirements;
            }

            // Validate all requirements
            function validateAllRequirements() {
                const requirements = collectRequirements();
                const errors = [];

                // Check required fields
                if (!requirements.subject) errors.push('Subject Name is required');
                if (!requirements.subjectCode) errors.push('Subject Code is required');
                if (!requirements.department) errors.push('Department is required');
                if (!requirements.semester) errors.push('Semester is required');
                if (!requirements.academicYear) errors.push('Academic Year is required');
                if (!requirements.examType) errors.push('Exam Type is required');
                if (!requirements.duration) errors.push('Duration is required');
                if (!requirements.totalMarks) errors.push('Total Marks is required');
                if (!requirements.questionPattern) errors.push('Question Pattern is required');
                if (!requirements.numModules) errors.push('Number of Modules is required');
                if (!requirements.moduleCoverage) errors.push('Module Coverage is required');
                if (!requirements.distributionRule) errors.push('Distribution Rule is required');

                // Validate Bloom's taxonomy
                if (!validateBloomsTaxonomy()) {
                    errors.push('Bloom\'s Taxonomy percentages must total 100%');
                }

                // Validate CO weights
                if (!validateCOWeights()) {
                    errors.push('Course Outcome weights must total 100%');
                }

                return { isValid: errors.length === 0, errors, requirements };
            }

            // Generate requirements summary
            function generateSummary(requirements) {
                return `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h5 class="font-semibold text-gray-800 mb-2">Basic Information</h5>
                            <ul class="text-sm space-y-1">
                                <li><strong>Subject:</strong> ${requirements.subject}</li>
                                <li><strong>Code:</strong> ${requirements.subjectCode}</li>
                                <li><strong>Department:</strong> ${requirements.department}</li>
                                <li><strong>Semester:</strong> ${requirements.semester}</li>
                                <li><strong>Exam Type:</strong> ${requirements.examType}</li>
                            </ul>
                        </div>
                        <div>
                            <h5 class="font-semibold text-gray-800 mb-2">Exam Details</h5>
                            <ul class="text-sm space-y-1">
                                <li><strong>Duration:</strong> ${requirements.duration} Hours</li>
                                <li><strong>Total Marks:</strong> ${requirements.totalMarks}</li>
                                <li><strong>Pattern:</strong> ${requirements.questionPattern}</li>
                                <li><strong>Modules:</strong> ${requirements.numModules}</li>
                            </ul>
                        </div>
                    </div>
                    <div class="mt-4">
                        <h5 class="font-semibold text-gray-800 mb-2">Bloom's Taxonomy Distribution</h5>
                        <div class="grid grid-cols-6 gap-2 text-sm">
                            <div>L1: ${requirements.bloomsTaxonomy.l1}%</div>
                            <div>L2: ${requirements.bloomsTaxonomy.l2}%</div>
                            <div>L3: ${requirements.bloomsTaxonomy.l3}%</div>
                            <div>L4: ${requirements.bloomsTaxonomy.l4}%</div>
                            <div>L5: ${requirements.bloomsTaxonomy.l5}%</div>
                            <div>L6: ${requirements.bloomsTaxonomy.l6}%</div>
                        </div>
                    </div>
                `;
            }

            // Event Handlers
            if (validateBtn) {
                validateBtn.addEventListener('click', () => {
                    const validation = validateAllRequirements();
                    if (validation.isValid) {
                        displayMessageBox('âœ… All requirements are valid! You can proceed to generate the question paper.', 'success');
                        currentRequirements = validation.requirements;
                    } else {
                        const errorList = validation.errors.map(error => `â€¢ ${error}`).join('\n');
                        displayMessageBox(`âŒ Please fix the following errors:\n\n${errorList}`, 'error');
                    }
                });
            }

            if (resetBtn) {
                resetBtn.addEventListener('click', () => {
                    if (confirm('Are you sure you want to reset all requirements? This will clear all entered data.')) {
                        requirementsForm.reset();
                        // Reset to default values
                        document.getElementById('req-l1-percent').value = 10;
                        document.getElementById('req-l2-percent').value = 20;
                        document.getElementById('req-l3-percent').value = 30;
                        document.getElementById('req-l4-percent').value = 25;
                        document.getElementById('req-l5-percent').value = 10;
                        document.getElementById('req-l6-percent').value = 5;

                        document.getElementById('req-co1-weight').value = 20;
                        document.getElementById('req-co2-weight').value = 20;
                        document.getElementById('req-co3-weight').value = 20;
                        document.getElementById('req-co4-weight').value = 20;
                        document.getElementById('req-co5-weight').value = 20;

                        validateBloomsTaxonomy();
                        validateCOWeights();
                        requirementsSummary.classList.add('hidden');
                        displayMessageBox('Requirements form has been reset to default values.', 'info');
                    }
                });
            }

            if (previewBtn) {
                previewBtn.addEventListener('click', () => {
                    const validation = validateAllRequirements();
                    if (validation.isValid) {
                        summaryContent.innerHTML = generateSummary(validation.requirements);
                        requirementsSummary.classList.remove('hidden');
                        requirementsSummary.scrollIntoView({ behavior: 'smooth' });
                    } else {
                        const errorList = validation.errors.map(error => `â€¢ ${error}`).join('\n');
                        displayMessageBox(`âŒ Cannot preview. Please fix errors:\n\n${errorList}`, 'error');
                    }
                });
            }

            if (applyBtn) {
                applyBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const validation = validateAllRequirements();
                    if (validation.isValid) {
                        currentRequirements = validation.requirements;
                        // Store requirements globally for use in question generation
                        window.currentQPRequirements = currentRequirements;

                        displayMessageBox('âœ… Requirements applied successfully! Switching to Question Paper Editor...', 'success');

                        // Switch to QP Editor with requirements applied
                        setTimeout(() => {
                            showContent(qpEditorCanvas, 'Question Paper Editor');
                            // Populate metadata in QP editor if needed
                            populateQPEditorWithRequirements(currentRequirements);
                        }, 1500);
                    } else {
                        const errorList = validation.errors.map(error => `â€¢ ${error}`).join('\n');
                        displayMessageBox(`âŒ Cannot apply requirements. Please fix errors:\n\n${errorList}`, 'error');
                    }
                });
            }

            // Template Management
            if (saveTemplateBtn) {
                saveTemplateBtn.addEventListener('click', () => {
                    const validation = validateAllRequirements();
                    if (validation.isValid) {
                        const templateName = prompt('Enter a name for this requirements template:');
                        if (templateName) {
                            const templates = JSON.parse(localStorage.getItem('qp-requirements-templates') || '{}');
                            templates[templateName] = validation.requirements;
                            localStorage.setItem('qp-requirements-templates', JSON.stringify(templates));
                            displayMessageBox(`âœ… Template "${templateName}" saved successfully!`, 'success');
                        }
                    } else {
                        displayMessageBox('âŒ Cannot save template. Please fix validation errors first.', 'error');
                    }
                });
            }

            if (loadTemplateBtn) {
                loadTemplateBtn.addEventListener('click', () => {
                    const templates = JSON.parse(localStorage.getItem('qp-requirements-templates') || '{}');
                    const templateNames = Object.keys(templates);

                    if (templateNames.length === 0) {
                        displayMessageBox('No saved templates found. Create and save a template first.', 'info');
                        return;
                    }

                    const templateName = prompt(`Select a template to load:\n\n${templateNames.map((name, i) => `${i + 1}. ${name}`).join('\n')}\n\nEnter the template name:`);

                    if (templateName && templates[templateName]) {
                        loadRequirementsTemplate(templates[templateName]);
                        displayMessageBox(`âœ… Template "${templateName}" loaded successfully!`, 'success');
                    } else if (templateName) {
                        displayMessageBox('âŒ Template not found. Please check the name and try again.', 'error');
                    }
                });
            }

            // Load requirements template into form
            function loadRequirementsTemplate(requirements) {
                // Basic Information
                document.getElementById('req-subject').value = requirements.subject || '';
                document.getElementById('req-subject-code').value = requirements.subjectCode || '';
                document.getElementById('req-department').value = requirements.department || '';
                document.getElementById('req-semester').value = requirements.semester || '';
                document.getElementById('req-academic-year').value = requirements.academicYear || '';
                document.getElementById('req-exam-type').value = requirements.examType || '';

                // Exam Details
                document.getElementById('req-duration').value = requirements.duration || '';
                document.getElementById('req-total-marks').value = requirements.totalMarks || '';
                document.getElementById('req-exam-date').value = requirements.examDate || '';
                document.getElementById('req-exam-time').value = requirements.examTime || '';

                // Question Distribution
                document.getElementById('req-question-pattern').value = requirements.questionPattern || '';
                document.getElementById('req-num-modules').value = requirements.numModules || '';
                document.getElementById('req-module-coverage').value = requirements.moduleCoverage || '';
                document.getElementById('req-distribution-rule').value = requirements.distributionRule || '';

                // Bloom's Taxonomy
                if (requirements.bloomsTaxonomy) {
                    document.getElementById('req-l1-percent').value = requirements.bloomsTaxonomy.l1 || 0;
                    document.getElementById('req-l2-percent').value = requirements.bloomsTaxonomy.l2 || 0;
                    document.getElementById('req-l3-percent').value = requirements.bloomsTaxonomy.l3 || 0;
                    document.getElementById('req-l4-percent').value = requirements.bloomsTaxonomy.l4 || 0;
                    document.getElementById('req-l5-percent').value = requirements.bloomsTaxonomy.l5 || 0;
                    document.getElementById('req-l6-percent').value = requirements.bloomsTaxonomy.l6 || 0;
                }

                // Course Outcomes
                if (requirements.courseOutcomes) {
                    document.getElementById('req-co1-weight').value = requirements.courseOutcomes.co1 || 0;
                    document.getElementById('req-co2-weight').value = requirements.courseOutcomes.co2 || 0;
                    document.getElementById('req-co3-weight').value = requirements.courseOutcomes.co3 || 0;
                    document.getElementById('req-co4-weight').value = requirements.courseOutcomes.co4 || 0;
                    document.getElementById('req-co5-weight').value = requirements.courseOutcomes.co5 || 0;
                }

                // Additional Requirements
                document.getElementById('req-selection-strategy').value = requirements.selectionStrategy || 'random';
                document.getElementById('req-difficulty-level').value = requirements.difficultyLevel || 'mixed';
                document.getElementById('req-special-instructions').value = requirements.specialInstructions || '';

                // Revalidate after loading
                validateBloomsTaxonomy();
                validateCOWeights();
            }

            // Populate QP Editor with requirements
            function populateQPEditorWithRequirements(requirements) {
                // This function can be used to pre-populate the QP editor with requirement data
                console.log('Requirements applied to QP Editor:', requirements);

                // Update the metadata in the generate final document function
                if (window.updateQPMetadataFromRequirements) {
                    window.updateQPMetadataFromRequirements(requirements);
                }
            }

            // --- Cool Dashboard Functionality ---

            // Animate dashboard elements on load
            function animateDashboard() {
                // Animate stats cards with staggered delay
                const statCards = document.querySelectorAll('[id^="stat-"]');
                statCards.forEach((card, index) => {
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(30px)';
                    setTimeout(() => {
                        card.style.transition = 'all 0.6s cubic-bezier(0.4, 0, 0.2, 1)';
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, index * 150);
                });

                // Animate quick action buttons
                const quickActions = document.querySelectorAll('.quick-action-btn');
                quickActions.forEach((btn, index) => {
                    btn.style.opacity = '0';
                    btn.style.transform = 'translateX(-30px)';
                    setTimeout(() => {
                        btn.style.transition = 'all 0.5s ease-out';
                        btn.style.opacity = '1';
                        btn.style.transform = 'translateX(0)';
                    }, 800 + (index * 100));
                });

                // Animate recent activity items
                const activityItems = document.querySelectorAll('#recent-activity-list > div');
                activityItems.forEach((item, index) => {
                    item.style.opacity = '0';
                    item.style.transform = 'translateX(30px)';
                    setTimeout(() => {
                        item.style.transition = 'all 0.4s ease-out';
                        item.style.opacity = '1';
                        item.style.transform = 'translateX(0)';
                    }, 1200 + (index * 200));
                });
            }

            // Update dashboard statistics
            function updateDashboardStats() {
                // Get actual counts from the system
                const totalQuestions = currentParsedQuestions ? currentParsedQuestions.length : 0;
                const savedTemplates = Object.keys(JSON.parse(localStorage.getItem('qp-requirements-templates') || '{}')).length;

                // Animate counter updates
                animateCounter('total-questions-count', totalQuestions);
                animateCounter('saved-templates-count', savedTemplates);

                // Simulate other stats for demo
                animateCounter('generated-papers-count', Math.floor(Math.random() * 20) + 5);
            }

            // Animate number counters
            function animateCounter(elementId, targetValue) {
                const element = document.getElementById(elementId);
                if (!element) return;

                const startValue = 0;
                const duration = 2000;
                const startTime = performance.now();

                function updateCounter(currentTime) {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);

                    // Easing function for smooth animation
                    const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                    const currentValue = Math.floor(startValue + (targetValue - startValue) * easeOutQuart);

                    element.textContent = currentValue;

                    if (progress < 1) {
                        requestAnimationFrame(updateCounter);
                    }
                }

                requestAnimationFrame(updateCounter);
            }

            // Add click handlers for quick action buttons
            function setupQuickActions() {
                const quickActions = {
                    'quick-new-qp': () => showContent(newQpCanvas, 'New Question Paper'),
                    'quick-upload': () => {
                        showContent(newQpCanvas, 'New Question Paper');
                        // Focus on upload section
                        setTimeout(() => {
                            const uploadSection = document.querySelector('#upload-section');
                            if (uploadSection) uploadSection.scrollIntoView({ behavior: 'smooth' });
                        }, 300);
                    },
                    'quick-requirements': () => showContent(requirementsContent, 'Requirements for QP'),
                    'quick-saved': () => {
                        showContent(savedContent, 'Saved QPs & Banks');
                        setTimeout(() => {
                            if (typeof initializeSavedContent === 'function') {
                                initializeSavedContent();
                            }
                        }, 100);
                    },
                    'quick-recent': () => {
                        showContent(recentContent, 'Recent Generated QPs');
                        setTimeout(() => {
                            if (typeof initializeRecentContent === 'function') {
                                initializeRecentContent();
                            }
                        }, 100);
                    },
                    'quick-settings': () => showContent(settingsContent, 'Settings'),
                    'quick-hod-dashboard': () => {
                        console.log('HOD Dashboard quick action clicked');

                        // Use the main switchToHODView function for consistency
                        if (typeof switchToHODView === 'function') {
                            switchToHODView();
                        } else {
                            console.error('switchToHODView function not available');
                            displayMessageBox('âŒ HOD Dashboard not available. Please refresh the page.', 'error');
                        }
                    }
                };

                Object.entries(quickActions).forEach(([id, handler]) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('click', () => {
                            // Add click animation
                            element.style.transform = 'scale(0.95)';
                            setTimeout(() => {
                                element.style.transform = '';
                                handler();
                            }, 150);
                        });
                    }
                });
            }

            // Add hover effects for stat cards
            function setupStatCardEffects() {
                const statCards = document.querySelectorAll('[id^="stat-"]');
                statCards.forEach(card => {
                    card.addEventListener('mouseenter', () => {
                        card.style.transform = 'translateY(-8px) scale(1.02)';
                        card.style.boxShadow = '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)';
                    });

                    card.addEventListener('mouseleave', () => {
                        card.style.transform = 'translateY(0) scale(1)';
                        card.style.boxShadow = '';
                    });
                });
            }

            // Update user name in welcome message
            function updateWelcomeMessage() {
                const userNameDisplay = document.getElementById('user-name-display');
                if (userNameDisplay && window.firebaseAuth && window.firebaseAuth.currentUser) {
                    const user = window.firebaseAuth.currentUser;
                    const displayName = user.displayName || user.email.split('@')[0];
                    userNameDisplay.textContent = displayName;
                }
            }

            // Initialize cool dashboard when welcome content is shown
            function initializeCoolDashboard() {
                if (document.getElementById('welcome-content').classList.contains('hidden')) return;

                setTimeout(() => {
                    updateWelcomeMessage();
                    updateDashboardStats();
                    animateDashboard();
                    setupQuickActions();
                    setupStatCardEffects();
                }, 100);
            }

            // Make dashboard functions globally available
            window.initializeCoolDashboard = initializeCoolDashboard;
            window.updateDashboardStats = updateDashboardStats;

            // --- Saved QPs & Banks Functionality ---

            // Global storage for saved items
            let savedItems = {
                questionPapers: [],
                questionBanks: [],
                templates: []
            };

            let currentFilter = 'all';
            let currentSort = 'date-desc';
            let currentPage = 1;
            const itemsPerPage = 10;

            // Initialize saved content when shown
            function initializeSavedContent() {
                loadSavedItems();
                setupSavedEventListeners();
                updateSavedStatistics();
                renderSavedItems();
            }

            // Load saved items from localStorage and other sources
            async function loadSavedItems() {
                try {
                    const user = window.firebaseAuth.currentUser;
                    if (!user) {
                        console.error('User not authenticated');
                        loadSavedItemsFromLocalStorage();
                        return;
                    }

                    const idToken = await user.getIdToken();
                    const response = await fetch('/get_saved_items', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${idToken}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();

                        // Process question papers
                        savedItems.questionPapers = data.question_papers.map(qp => ({
                            id: qp.id,
                            type: 'question-paper',
                            name: qp.paper_name || 'Untitled Question Paper',
                            subject: qp.subject || 'Unknown Subject',
                            createdDate: qp.created_at ? new Date(qp.created_at.seconds * 1000).toISOString() : new Date().toISOString(),
                            modifiedDate: qp.updated_at ? new Date(qp.updated_at.seconds * 1000).toISOString() : new Date().toISOString(),
                            size: calculateSize(qp),
                            questions: qp.questions || [],
                            metadata: qp.metadata || {},
                            questionCount: qp.questions ? qp.questions.length : (qp.metadata ? qp.metadata.totalQuestions : 0),
                            totalMarks: qp.maxMarks || (qp.metadata ? qp.metadata.totalMarks : 100),
                            status: qp.status || 'draft',
                            tags: qp.tags || [],
                            data: qp
                        }));

                        // Process question banks
                        savedItems.questionBanks = data.question_banks.map(bank => ({
                            id: bank.id,
                            type: 'question-bank',
                            name: bank.source_file || 'Question Bank',
                            subject: bank.subject || 'Unknown Subject',
                            createdDate: bank.uploaded_at ? new Date(bank.uploaded_at.seconds * 1000).toISOString() : new Date().toISOString(),
                            modifiedDate: bank.uploaded_at ? new Date(bank.uploaded_at.seconds * 1000).toISOString() : new Date().toISOString(),
                            size: calculateSize(bank),
                            questionCount: 1, // Each document represents one question
                            data: bank
                        }));

                        // Add current parsed questions as a bank if available
                        if (currentParsedQuestions && currentParsedQuestions.length > 0) {
                            const currentBank = {
                                id: 'current-bank',
                                type: 'question-bank',
                                name: 'Current Question Bank',
                                subject: 'Current Session',
                                createdDate: new Date().toISOString(),
                                modifiedDate: new Date().toISOString(),
                                size: calculateSize({ questions: currentParsedQuestions }),
                                questionCount: currentParsedQuestions.length,
                                data: { questions: currentParsedQuestions }
                            };

                            // Remove existing current bank and add updated one
                            savedItems.questionBanks = savedItems.questionBanks.filter(bank => bank.id !== 'current-bank');
                            savedItems.questionBanks.unshift(currentBank);
                        }

                        // Process templates (placeholder for now)
                        savedItems.templates = data.templates || [];

                        updateSavedStatistics();
                        renderSavedItems();
                    } else {
                        console.error('Failed to load saved items:', await response.text());
                        loadSavedItemsFromLocalStorage();
                    }
                } catch (error) {
                    console.error('Error loading saved items:', error);
                    loadSavedItemsFromLocalStorage();
                }
            }

            // Fallback function to load from localStorage
            function loadSavedItemsFromLocalStorage() {
                // Load question papers from localStorage
                const savedQPs = JSON.parse(localStorage.getItem('saved-question-papers') || '[]');

                savedItems.questionPapers = savedQPs.map(qp => ({
                    id: qp.id || generateId(),
                    type: 'question-paper',
                    name: qp.name || 'Untitled Question Paper',
                    subject: qp.subject || 'Unknown Subject',
                    createdDate: qp.createdDate || new Date().toISOString(),
                    modifiedDate: qp.lastModified || qp.modifiedDate || new Date().toISOString(),
                    size: calculateSize(qp),
                    questions: qp.questions || [],
                    metadata: qp.metadata || {},
                    questionCount: qp.questions ? qp.questions.length : (qp.metadata ? qp.metadata.totalQuestions : 0),
                    totalMarks: qp.maxMarks || (qp.metadata ? qp.metadata.totalMarks : 100),
                    status: qp.status || 'draft',
                    tags: qp.tags || [],
                    data: qp
                }));

                // Load question banks (from current parsed questions and saved banks)
                const savedBanks = JSON.parse(localStorage.getItem('saved-question-banks') || '[]');
                savedItems.questionBanks = savedBanks.map(bank => ({
                    id: bank.id || generateId(),
                    type: 'question-bank',
                    name: bank.name || 'Question Bank',
                    subject: bank.subject || 'Unknown Subject',
                    createdDate: bank.createdDate || new Date().toISOString(),
                    modifiedDate: bank.modifiedDate || new Date().toISOString(),
                    size: calculateSize(bank),
                    questionCount: bank.questions ? bank.questions.length : 0,
                    data: bank
                }));

                // Add current parsed questions as a bank if available
                if (currentParsedQuestions && currentParsedQuestions.length > 0) {
                    const currentBank = {
                        id: 'current-bank',
                        type: 'question-bank',
                        name: 'Current Question Bank',
                        subject: 'Current Session',
                        createdDate: new Date().toISOString(),
                        modifiedDate: new Date().toISOString(),
                        size: calculateSize({ questions: currentParsedQuestions }),
                        questionCount: currentParsedQuestions.length,
                        data: { questions: currentParsedQuestions }
                    };

                    // Remove existing current bank and add updated one
                    savedItems.questionBanks = savedItems.questionBanks.filter(bank => bank.id !== 'current-bank');
                    savedItems.questionBanks.unshift(currentBank);
                }

                // Load templates
                const savedTemplates = JSON.parse(localStorage.getItem('qp-requirements-templates') || '{}');
                savedItems.templates = Object.entries(savedTemplates).map(([name, template]) => ({
                    id: generateId(),
                    type: 'template',
                    name: name,
                    subject: template.subject || 'Unknown Subject',
                    createdDate: template.createdDate || new Date().toISOString(),
                    modifiedDate: template.modifiedDate || new Date().toISOString(),
                    size: calculateSize(template),
                    data: template
                }));

                updateSavedStatistics();
                renderSavedItems();
            }

            // Generate unique ID
            function generateId() {
                return 'item_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            // Calculate item size in KB
            function calculateSize(item) {
                const jsonString = JSON.stringify(item);
                return Math.round(jsonString.length / 1024 * 100) / 100; // KB with 2 decimal places
            }

            // Update statistics
            function updateSavedStatistics() {
                const qpCount = savedItems.questionPapers.length;
                const bankCount = savedItems.questionBanks.length;
                const templateCount = savedItems.templates.length;
                const totalSize = [...savedItems.questionPapers, ...savedItems.questionBanks, ...savedItems.templates]
                    .reduce((sum, item) => sum + item.size, 0);

                document.getElementById('saved-qp-count').textContent = qpCount;
                document.getElementById('saved-bank-count').textContent = bankCount;
                document.getElementById('saved-template-count').textContent = templateCount;
                document.getElementById('saved-total-size').textContent = totalSize.toFixed(1) + ' KB';

                // Update tab counts
                document.getElementById('tab-all-count').textContent = qpCount + bankCount + templateCount;
                document.getElementById('tab-qp-count').textContent = qpCount;
                document.getElementById('tab-bank-count').textContent = bankCount;
                document.getElementById('tab-template-count').textContent = templateCount;
            }

            // Get filtered and sorted items
            function getFilteredItems() {
                let allItems = [];

                if (currentFilter === 'all') {
                    allItems = [...savedItems.questionPapers, ...savedItems.questionBanks, ...savedItems.templates];
                } else if (currentFilter === 'question-papers') {
                    allItems = [...savedItems.questionPapers];
                } else if (currentFilter === 'question-banks') {
                    allItems = [...savedItems.questionBanks];
                } else if (currentFilter === 'templates') {
                    allItems = [...savedItems.templates];
                }

                // Apply search filter
                const searchTerm = document.getElementById('saved-search').value.toLowerCase();
                if (searchTerm) {
                    allItems = allItems.filter(item =>
                        item.name.toLowerCase().includes(searchTerm) ||
                        item.subject.toLowerCase().includes(searchTerm) ||
                        item.type.toLowerCase().includes(searchTerm)
                    );
                }

                // Apply sorting
                allItems.sort((a, b) => {
                    switch (currentSort) {
                        case 'date-desc':
                            return new Date(b.modifiedDate) - new Date(a.modifiedDate);
                        case 'date-asc':
                            return new Date(a.modifiedDate) - new Date(b.modifiedDate);
                        case 'name-asc':
                            return a.name.localeCompare(b.name);
                        case 'name-desc':
                            return b.name.localeCompare(a.name);
                        case 'size-desc':
                            return b.size - a.size;
                        default:
                            return 0;
                    }
                });

                return allItems;
            }

            // Render saved items
            function renderSavedItems() {
                const filteredItems = getFilteredItems();
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const pageItems = filteredItems.slice(startIndex, endIndex);

                const container = document.getElementById('saved-items-list');
                const emptyState = document.getElementById('saved-empty');
                const pagination = document.getElementById('saved-pagination');

                if (filteredItems.length === 0) {
                    container.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    pagination.classList.add('hidden');
                    return;
                }

                emptyState.classList.add('hidden');

                container.innerHTML = pageItems.map(item => createItemCard(item)).join('');

                // Update pagination
                updatePagination(filteredItems.length);

                // Add event listeners to new cards
                addItemEventListeners();
            }

            // Create item card HTML
            function createItemCard(item) {
                const typeIcon = getTypeIcon(item.type);
                const typeColor = getTypeColor(item.type);
                const formattedDate = new Date(item.modifiedDate).toLocaleDateString();
                const formattedTime = new Date(item.modifiedDate).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                return `
                    <div class="item-card bg-gray-50 rounded-lg p-4 hover:bg-gray-100 transition-colors duration-200 border border-gray-200" data-item-id="${item.id}">
                        <div class="flex items-start justify-between">
                            <div class="flex items-start space-x-4 flex-1">
                                <div class="bg-${typeColor}-100 rounded-lg p-3">
                                    <i class="${typeIcon} text-${typeColor}-600 text-xl"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h4 class="text-lg font-semibold text-gray-900 truncate">${item.name}</h4>
                                    <p class="text-gray-600 text-sm mb-2">${item.subject}</p>
                                    <div class="flex items-center space-x-4 text-sm text-gray-500">
                                        <span class="flex items-center">
                                            <i class="fas fa-calendar-alt mr-1"></i>
                                            ${formattedDate} at ${formattedTime}
                                        </span>
                                        <span class="flex items-center">
                                            <i class="fas fa-hdd mr-1"></i>
                                            ${item.size} KB
                                        </span>
                                        ${item.questionCount ? `
                                            <span class="flex items-center">
                                                <i class="fas fa-question-circle mr-1"></i>
                                                ${item.questionCount} questions
                                            </span>
                                        ` : ''}
                                    </div>
                                    <div class="mt-2">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-${typeColor}-100 text-${typeColor}-800">
                                            ${item.type.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2 ml-4">
                                <button class="view-item-btn p-2 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded-md transition-colors duration-200" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="use-item-btn p-2 text-green-600 hover:text-green-800 hover:bg-green-50 rounded-md transition-colors duration-200" title="Use This Item">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button class="download-item-btn p-2 text-purple-600 hover:text-purple-800 hover:bg-purple-50 rounded-md transition-colors duration-200" title="Download">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="delete-item-btn p-2 text-red-600 hover:text-red-800 hover:bg-red-50 rounded-md transition-colors duration-200" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Get type icon
            function getTypeIcon(type) {
                switch (type) {
                    case 'question-paper': return 'fas fa-file-alt';
                    case 'question-bank': return 'fas fa-database';
                    case 'template': return 'fas fa-bookmark';
                    default: return 'fas fa-file';
                }
            }

            // Get type color
            function getTypeColor(type) {
                switch (type) {
                    case 'question-paper': return 'blue';
                    case 'question-bank': return 'green';
                    case 'template': return 'purple';
                    default: return 'gray';
                }
            }

            // Update pagination
            function updatePagination(totalItems) {
                const pagination = document.getElementById('saved-pagination');
                const startSpan = document.getElementById('pagination-start');
                const endSpan = document.getElementById('pagination-end');
                const totalSpan = document.getElementById('pagination-total');
                const prevBtn = document.getElementById('pagination-prev');
                const nextBtn = document.getElementById('pagination-next');

                if (totalItems <= itemsPerPage) {
                    pagination.classList.add('hidden');
                    return;
                }

                pagination.classList.remove('hidden');

                const startIndex = (currentPage - 1) * itemsPerPage + 1;
                const endIndex = Math.min(currentPage * itemsPerPage, totalItems);

                startSpan.textContent = startIndex;
                endSpan.textContent = endIndex;
                totalSpan.textContent = totalItems;

                prevBtn.disabled = currentPage === 1;
                nextBtn.disabled = currentPage === Math.ceil(totalItems / itemsPerPage);

                // Update page numbers
                const numbersContainer = document.getElementById('pagination-numbers');
                const totalPages = Math.ceil(totalItems / itemsPerPage);
                const maxVisiblePages = 5;

                let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
                let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

                if (endPage - startPage + 1 < maxVisiblePages) {
                    startPage = Math.max(1, endPage - maxVisiblePages + 1);
                }

                let numbersHTML = '';
                for (let i = startPage; i <= endPage; i++) {
                    const isActive = i === currentPage;
                    numbersHTML += `
                        <button class="pagination-number px-3 py-1 border rounded-md text-sm ${isActive ? 'bg-green-600 text-white border-green-600' : 'border-gray-300 hover:bg-gray-50'}" data-page="${i}">
                            ${i}
                        </button>
                    `;
                }

                numbersContainer.innerHTML = numbersHTML;
            }

            // Setup event listeners
            function setupSavedEventListeners() {
                // Search input
                const searchInput = document.getElementById('saved-search');
                if (searchInput) {
                    searchInput.addEventListener('input', debounce(() => {
                        currentPage = 1;
                        renderSavedItems();
                    }, 300));
                }

                // Filter dropdown
                const filterSelect = document.getElementById('saved-filter');
                if (filterSelect) {
                    filterSelect.addEventListener('change', (e) => {
                        currentFilter = e.target.value;
                        currentPage = 1;
                        updateActiveTab();
                        renderSavedItems();
                    });
                }

                // Sort dropdown
                const sortSelect = document.getElementById('saved-sort');
                if (sortSelect) {
                    sortSelect.addEventListener('change', (e) => {
                        currentSort = e.target.value;
                        renderSavedItems();
                    });
                }

                // Tab buttons
                document.querySelectorAll('.saved-tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const tab = e.target.dataset.tab;
                        currentFilter = tab;
                        currentPage = 1;

                        // Update filter dropdown
                        document.getElementById('saved-filter').value = tab;

                        updateActiveTab();
                        renderSavedItems();
                    });
                });

                // Refresh button
                const refreshBtn = document.getElementById('refresh-saved-btn');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', () => {
                        loadSavedItems();
                        updateSavedStatistics();
                        renderSavedItems();
                        displayMessageBox('âœ… Saved items refreshed successfully!', 'success');
                    });
                }

                // Export button
                const exportBtn = document.getElementById('export-all-btn');
                if (exportBtn) {
                    exportBtn.addEventListener('click', () => {
                        showModal('export-modal');
                    });
                }

                // Pagination buttons
                document.getElementById('pagination-prev').addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        renderSavedItems();
                    }
                });

                document.getElementById('pagination-next').addEventListener('click', () => {
                    const totalItems = getFilteredItems().length;
                    const totalPages = Math.ceil(totalItems / itemsPerPage);
                    if (currentPage < totalPages) {
                        currentPage++;
                        renderSavedItems();
                    }
                });

                // Pagination number clicks
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('pagination-number')) {
                        currentPage = parseInt(e.target.dataset.page);
                        renderSavedItems();
                    }
                });
            }

            // Update active tab
            function updateActiveTab() {
                document.querySelectorAll('.saved-tab-btn').forEach(btn => {
                    const tab = btn.dataset.tab;
                    if (tab === currentFilter) {
                        btn.classList.add('active', 'border-green-500', 'text-green-600');
                        btn.classList.remove('border-transparent', 'text-gray-500');
                    } else {
                        btn.classList.remove('active', 'border-green-500', 'text-green-600');
                        btn.classList.add('border-transparent', 'text-gray-500');
                    }
                });
            }

            // Add event listeners to item cards
            function addItemEventListeners() {
                // View item buttons
                document.querySelectorAll('.view-item-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const itemId = e.target.closest('.item-card').dataset.itemId;
                        viewItem(itemId);
                    });
                });

                // Use item buttons
                document.querySelectorAll('.use-item-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const itemId = e.target.closest('.item-card').dataset.itemId;
                        useItem(itemId);
                    });
                });

                // Download item buttons
                document.querySelectorAll('.download-item-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const itemId = e.target.closest('.item-card').dataset.itemId;
                        downloadItem(itemId);
                    });
                });

                // Delete item buttons
                document.querySelectorAll('.delete-item-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const itemId = e.target.closest('.item-card').dataset.itemId;
                        confirmDeleteItem(itemId);
                    });
                });
            }

            // Debounce function
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // Find item by ID
            function findItemById(itemId) {
                const allItems = [...savedItems.questionPapers, ...savedItems.questionBanks, ...savedItems.templates];
                return allItems.find(item => item.id === itemId);
            }

            // View item details
            function viewItem(itemId) {
                const item = findItemById(itemId);
                if (!item) return;

                const modal = document.getElementById('view-modal');
                const title = document.getElementById('view-modal-title');
                const content = document.getElementById('view-modal-content');

                title.textContent = `${item.name} - Details`;

                let contentHTML = `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-2">Basic Information</h4>
                                <dl class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <dt class="text-gray-600">Name:</dt>
                                        <dd class="font-medium">${item.name}</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-600">Type:</dt>
                                        <dd class="font-medium">${item.type.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-600">Subject:</dt>
                                        <dd class="font-medium">${item.subject}</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-600">Size:</dt>
                                        <dd class="font-medium">${item.size} KB</dd>
                                    </div>
                                </dl>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-2">Dates</h4>
                                <dl class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <dt class="text-gray-600">Created:</dt>
                                        <dd class="font-medium">${new Date(item.createdDate).toLocaleString()}</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-600">Modified:</dt>
                                        <dd class="font-medium">${new Date(item.modifiedDate).toLocaleString()}</dd>
                                    </div>
                                </dl>
                            </div>
                        </div>
                `;

                if (item.type === 'question-bank' && item.questionCount) {
                    contentHTML += `
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">Question Bank Details</h4>
                            <p class="text-sm text-gray-600">Contains ${item.questionCount} questions</p>
                        </div>
                    `;
                }

                if (item.type === 'template' && item.data) {
                    contentHTML += `
                        <div>
                            <h4 class="font-semibold text-gray-900 mb-2">Template Configuration</h4>
                            <div class="bg-gray-50 rounded-lg p-4 text-sm">
                                <pre class="whitespace-pre-wrap">${JSON.stringify(item.data, null, 2)}</pre>
                            </div>
                        </div>
                    `;
                }

                contentHTML += '</div>';
                content.innerHTML = contentHTML;

                // Set up action button
                const actionBtn = document.getElementById('view-modal-action');
                actionBtn.onclick = () => {
                    closeModal('view-modal');
                    useItem(itemId);
                };

                showModal(modal.id);
            }

            // Use item
            function useItem(itemId) {
                const item = findItemById(itemId);
                if (!item) return;

                switch (item.type) {
                    case 'question-paper':
                        // Load question paper into editor
                        if (item.data && item.data.questions) {
                            currentQuestionPaper.length = 0;
                            currentQuestionPaper.push(...item.data.questions);
                            showContent(qpEditorCanvas, 'Question Paper Editor');
                            renderQPPreview();
                            displayMessageBox(`âœ… Question paper "${item.name}" loaded successfully!`, 'success');
                        }
                        break;

                    case 'question-bank':
                        // Load question bank into left pane
                        if (item.data && item.data.questions) {
                            currentParsedQuestions = item.data.questions;
                            showContent(qpEditorCanvas, 'Question Paper Editor');
                            populateLeftPane(currentParsedQuestions);
                            displayMessageBox(`âœ… Question bank "${item.name}" loaded successfully!`, 'success');
                        }
                        break;

                    case 'template':
                        // Load template into requirements
                        if (item.data) {
                            showContent(requirementsContent, 'Requirements for QP');
                            setTimeout(() => {
                                if (window.loadRequirementsTemplate) {
                                    window.loadRequirementsTemplate(item.data);
                                    displayMessageBox(`âœ… Template "${item.name}" loaded successfully!`, 'success');
                                }
                            }, 300);
                        }
                        break;
                }
            }

            // Download item
            function downloadItem(itemId) {
                const item = findItemById(itemId);
                if (!item) return;

                if (item.type === 'question-paper') {
                    // For question papers, show format selection
                    showDownloadFormatModal(item);
                } else {
                    // For other items, download as JSON
                    const dataStr = JSON.stringify(item.data, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);

                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${item.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);

                    displayMessageBox(`âœ… "${item.name}" downloaded successfully!`, 'success');
                }
            }

            // Show download format modal for question papers
            function showDownloadFormatModal(item) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                        <h3 class="text-lg font-semibold mb-4">Download "${item.name}"</h3>
                        <p class="text-gray-600 mb-6">Choose the format for download:</p>
                        <div class="flex gap-3">
                            <button onclick="downloadQuestionPaperAs('${item.id}', 'docx')" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                <i class="fas fa-file-word mr-2"></i>DOCX
                            </button>
                            <button onclick="downloadQuestionPaperAs('${item.id}', 'pdf')" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                                <i class="fas fa-file-pdf mr-2"></i>PDF
                            </button>
                            <button onclick="downloadQuestionPaperAs('${item.id}', 'json')" class="flex-1 px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                                <i class="fas fa-code mr-2"></i>JSON
                            </button>
                        </div>
                        <button onclick="this.closest('.fixed').remove()" class="mt-4 w-full px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                            Cancel
                        </button>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            // Download question paper in specific format
            window.downloadQuestionPaperAs = async function (itemId, format) {
                const item = findItemById(itemId);
                if (!item) return;

                // Close modal
                document.querySelector('.fixed.inset-0')?.remove();

                if (format === 'json') {
                    // Download as JSON
                    const dataStr = JSON.stringify(item.data, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);

                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${item.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);

                    displayMessageBox(`âœ… "${item.name}" downloaded as JSON!`, 'success');
                } else {
                    // Generate and download as DOCX/PDF
                    await generateDocumentFromSaved(item.data, format);
                }
            };

            // Confirm delete item
            function confirmDeleteItem(itemId) {
                const item = findItemById(itemId);
                if (!item) return;

                const modal = document.getElementById('delete-modal');
                const message = document.getElementById('delete-modal-message');

                message.textContent = `Are you sure you want to delete "${item.name}"? This action cannot be undone.`;

                const confirmBtn = document.getElementById('confirm-delete-btn');
                confirmBtn.onclick = () => {
                    deleteItem(itemId);
                    closeModal('delete-modal');
                };

                showModal(modal.id);
            }

            // Delete item
            function deleteItem(itemId) {
                const item = findItemById(itemId);
                if (!item) return;

                // Remove from appropriate array
                if (item.type === 'question-paper') {
                    savedItems.questionPapers = savedItems.questionPapers.filter(qp => qp.id !== itemId);
                    // Update localStorage
                    const savedQPs = savedItems.questionPapers.map(qp => qp.data);
                    localStorage.setItem('saved-question-papers', JSON.stringify(savedQPs));
                } else if (item.type === 'question-bank') {
                    savedItems.questionBanks = savedItems.questionBanks.filter(bank => bank.id !== itemId);
                    // Update localStorage (excluding current bank)
                    const savedBanks = savedItems.questionBanks.filter(bank => bank.id !== 'current-bank').map(bank => bank.data);
                    localStorage.setItem('saved-question-banks', JSON.stringify(savedBanks));
                } else if (item.type === 'template') {
                    savedItems.templates = savedItems.templates.filter(template => template.id !== itemId);
                    // Update localStorage
                    const templates = JSON.parse(localStorage.getItem('qp-requirements-templates') || '{}');
                    delete templates[item.name];
                    localStorage.setItem('qp-requirements-templates', JSON.stringify(templates));
                }

                updateSavedStatistics();
                renderSavedItems();
                displayMessageBox(`âœ… "${item.name}" deleted successfully!`, 'success');
            }

            // Close modal
            window.closeModal = function (modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex', 'grid');
                }
            };

            // Helper function to show modals with proper display classes
            window.showModal = function (modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    showModal(modal.id);
                    // Add flex class for modal display
                    if (modal.id.includes('modal')) {
                        modal.classList.add('flex');
                    }
                }
            };

            // Initialize saved content when the section is shown
            function initSavedContentWhenShown() {
                if (document.getElementById('saved-content').classList.contains('hidden')) return;
                initializeSavedContent();
            }

            // Make functions globally available
            window.initializeSavedContent = initializeSavedContent;
            window.initSavedContentWhenShown = initSavedContentWhenShown;

            // --- Recent Generated QPs Functionality ---

            // Global storage for recent QPs
            let recentQPs = [];
            let currentRecentFilter = 'all';
            let currentRecentPeriod = 'all';
            let currentRecentStatus = 'all';
            let currentRecentSort = 'date-desc';
            let currentRecentPage = 1;
            let currentRecentView = 'list';
            const recentItemsPerPage = 10;

            // Initialize recent content when shown
            function initializeRecentContent() {
                loadRecentQPs();
                setupRecentEventListeners();
                updateRecentStatistics();
                renderRecentQPs();
            }

            // Load recent QPs from localStorage and session data
            async function loadRecentQPs() {
                try {
                    const user = window.firebaseAuth.currentUser;
                    if (!user) {
                        console.error('User not authenticated');
                        loadRecentQPsFromLocalStorage();
                        return;
                    }

                    const idToken = await user.getIdToken();
                    const response = await fetch('/get_recent_papers', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${idToken}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();

                        // Process recent papers from backend
                        recentQPs = data.recent_papers.map(paper => ({
                            id: paper.id,
                            name: paper.paper_name || 'Untitled Question Paper',
                            subject: paper.subject || 'Unknown Subject',
                            examType: paper.exam_type || 'Mid-Term',
                            generatedDate: paper.created_at ? new Date(paper.created_at.seconds * 1000).toISOString() : new Date().toISOString(),
                            status: paper.status || 'success',
                            downloadCount: paper.download_count || 0,
                            size: paper.size || 0,
                            tags: paper.tags || [],
                            data: paper
                        }));

                        // Sort by date (newest first) by default
                        recentQPs.sort((a, b) => new Date(b.generatedDate) - new Date(a.generatedDate));

                        updateRecentStatistics();
                        renderRecentQPs();
                    } else {
                        console.error('Failed to load recent papers:', await response.text());
                        loadRecentQPsFromLocalStorage();
                    }
                } catch (error) {
                    console.error('Error loading recent papers:', error);
                    loadRecentQPsFromLocalStorage();
                }
            }

            // Fallback function to load from localStorage
            function loadRecentQPsFromLocalStorage() {
                // Load from localStorage
                const storedRecent = JSON.parse(localStorage.getItem('recent-generated-qps') || '[]');

                // Don't add sample data if we have real data
                if (storedRecent.length === 0) {
                    recentQPs = [];
                } else {
                    recentQPs = storedRecent;
                }

                // Sort by date (newest first) by default
                recentQPs.sort((a, b) => new Date(b.generatedDate) - new Date(a.generatedDate));

                updateRecentStatistics();
                renderRecentQPs();
            }

            // No more sample data - load real data from backend

            // Update recent statistics
            function updateRecentStatistics() {
                const totalCount = recentQPs.length;
                const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                const weekCount = recentQPs.filter(qp => new Date(qp.generatedDate) >= weekAgo).length;
                const downloadedCount = recentQPs.filter(qp => qp.status === 'downloaded' || qp.downloadCount > 0).length;
                const successRate = totalCount > 0 ? Math.round((recentQPs.filter(qp => qp.status === 'success' || qp.status === 'downloaded' || qp.status === 'shared').length / totalCount) * 100) : 100;

                document.getElementById('recent-total-count').textContent = totalCount;
                document.getElementById('recent-week-count').textContent = weekCount;
                document.getElementById('recent-downloaded-count').textContent = downloadedCount;
                document.getElementById('recent-success-rate').textContent = successRate + '%';
            }

            // Get filtered recent QPs
            function getFilteredRecentQPs() {
                let filtered = [...recentQPs];

                // Apply search filter
                const searchTerm = document.getElementById('recent-search').value.toLowerCase();
                if (searchTerm) {
                    filtered = filtered.filter(qp =>
                        qp.name.toLowerCase().includes(searchTerm) ||
                        qp.subject.toLowerCase().includes(searchTerm) ||
                        qp.examType.toLowerCase().includes(searchTerm) ||
                        new Date(qp.generatedDate).toLocaleDateString().includes(searchTerm)
                    );
                }

                // Apply period filter
                if (currentRecentPeriod !== 'all') {
                    const now = new Date();
                    let cutoffDate;

                    switch (currentRecentPeriod) {
                        case 'today':
                            cutoffDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                            break;
                        case 'week':
                            cutoffDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                            break;
                        case 'month':
                            cutoffDate = new Date(now.getFullYear(), now.getMonth(), 1);
                            break;
                        case 'quarter':
                            cutoffDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
                            break;
                    }

                    if (cutoffDate) {
                        filtered = filtered.filter(qp => new Date(qp.generatedDate) >= cutoffDate);
                    }
                }

                // Apply status filter
                if (currentRecentStatus !== 'all') {
                    filtered = filtered.filter(qp => qp.status === currentRecentStatus);
                }

                // Apply sorting
                filtered.sort((a, b) => {
                    switch (currentRecentSort) {
                        case 'date-desc':
                            return new Date(b.generatedDate) - new Date(a.generatedDate);
                        case 'date-asc':
                            return new Date(a.generatedDate) - new Date(b.generatedDate);
                        case 'name-asc':
                            return a.name.localeCompare(b.name);
                        case 'name-desc':
                            return b.name.localeCompare(a.name);
                        case 'downloads-desc':
                            return b.downloadCount - a.downloadCount;
                        default:
                            return 0;
                    }
                });

                return filtered;
            }

            // Render recent QPs based on current view
            function renderRecentQPs() {
                const filteredQPs = getFilteredRecentQPs();
                const startIndex = (currentRecentPage - 1) * recentItemsPerPage;
                const endIndex = startIndex + recentItemsPerPage;
                const pageQPs = filteredQPs.slice(startIndex, endIndex);

                const emptyState = document.getElementById('recent-empty');
                const listView = document.getElementById('recent-list-view');
                const timelineView = document.getElementById('recent-timeline-view');
                const gridView = document.getElementById('recent-grid-view');
                const pagination = document.getElementById('recent-pagination');

                // Hide all views first
                if (listView) listView.classList.add('hidden');
                if (timelineView) timelineView.classList.add('hidden');
                if (gridView) gridView.classList.add('hidden');

                if (filteredQPs.length === 0) {
                    if (emptyState) emptyState.classList.remove('hidden');
                    if (pagination) pagination.classList.add('hidden');
                    return;
                }

                emptyState.classList.add('hidden');

                // Show appropriate view
                switch (currentRecentView) {
                    case 'list':
                        listView.classList.remove('hidden');
                        renderListView(pageQPs);
                        break;
                    case 'timeline':
                        timelineView.classList.remove('hidden');
                        renderTimelineView(pageQPs);
                        break;
                    case 'grid':
                        gridView.classList.remove('hidden');
                        renderGridView(pageQPs);
                        break;
                }

                // Update pagination
                updateRecentPagination(filteredQPs.length);

                // Add event listeners
                addRecentEventListeners();
            }

            // Render list view
            function renderListView(qps) {
                const container = document.getElementById('recent-list-view');
                container.innerHTML = qps.map(qp => createListItemCard(qp)).join('');
            }

            // Render timeline view
            function renderTimelineView(qps) {
                const container = document.getElementById('recent-timeline-items');
                container.innerHTML = qps.map(qp => createTimelineItem(qp)).join('');
            }

            // Render grid view
            function renderGridView(qps) {
                const container = document.getElementById('recent-grid-view');
                container.innerHTML = qps.map(qp => createGridCard(qp)).join('');
            }

            // Create list item card
            function createListItemCard(qp) {
                const formattedDate = new Date(qp.generatedDate).toLocaleDateString();
                const formattedTime = new Date(qp.generatedDate).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const statusColor = getStatusColor(qp.status);
                const statusIcon = getStatusIcon(qp.status);

                return `
                    <div class="recent-item-card bg-gray-50 rounded-lg p-4 hover:bg-gray-100 transition-colors duration-200 border border-gray-200" data-qp-id="${qp.id}">
                        <div class="flex items-start justify-between">
                            <div class="flex items-start space-x-4 flex-1">
                                <div class="bg-yellow-100 rounded-lg p-3">
                                    <i class="fas fa-file-alt text-yellow-600 text-xl"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h4 class="text-lg font-semibold text-gray-900 truncate">${qp.name}</h4>
                                    <p class="text-gray-600 text-sm mb-2">${qp.subject}</p>
                                    <div class="flex items-center space-x-4 text-sm text-gray-500 mb-2">
                                        <span class="flex items-center">
                                            <i class="fas fa-calendar-alt mr-1"></i>
                                            ${formattedDate} at ${formattedTime}
                                        </span>
                                        <span class="flex items-center">
                                            <i class="fas fa-clock mr-1"></i>
                                            ${qp.duration}h
                                        </span>
                                        <span class="flex items-center">
                                            <i class="fas fa-star mr-1"></i>
                                            ${qp.totalMarks} marks
                                        </span>
                                        <span class="flex items-center">
                                            <i class="fas fa-question-circle mr-1"></i>
                                            ${qp.questionCount} questions
                                        </span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-${statusColor}-100 text-${statusColor}-800">
                                            <i class="${statusIcon} mr-1"></i>
                                            ${qp.status.charAt(0).toUpperCase() + qp.status.slice(1)}
                                        </span>
                                        <span class="text-xs text-gray-500">
                                            <i class="fas fa-download mr-1"></i>${qp.downloadCount} downloads
                                        </span>
                                        <span class="text-xs text-gray-500">
                                            <i class="fas fa-share mr-1"></i>${qp.shareCount} shares
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2 ml-4">
                                <button class="view-recent-btn p-2 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded-md transition-colors duration-200" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="share-recent-btn p-2 text-green-600 hover:text-green-800 hover:bg-green-50 rounded-md transition-colors duration-200" title="Share">
                                    <i class="fas fa-share-alt"></i>
                                </button>
                                <button class="download-docx-btn p-2 text-purple-600 hover:text-purple-800 hover:bg-purple-50 rounded-md transition-colors duration-200" title="Download DOCX">
                                    <i class="fas fa-file-word"></i>
                                </button>
                                <button class="download-pdf-btn p-2 text-red-600 hover:text-red-800 hover:bg-red-50 rounded-md transition-colors duration-200" title="Download PDF">
                                    <i class="fas fa-file-pdf"></i>
                                </button>
                                <button class="rename-recent-btn p-2 text-gray-600 hover:text-gray-800 hover:bg-gray-50 rounded-md transition-colors duration-200" title="Rename">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="delete-recent-btn p-2 text-red-600 hover:text-red-800 hover:bg-red-50 rounded-md transition-colors duration-200" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Create timeline item
            function createTimelineItem(qp) {
                const formattedDate = new Date(qp.generatedDate).toLocaleDateString();
                const formattedTime = new Date(qp.generatedDate).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const statusColor = getStatusColor(qp.status);
                const statusIcon = getStatusIcon(qp.status);

                return `
                    <div class="recent-timeline-item relative pl-16" data-qp-id="${qp.id}">
                        <!-- Timeline dot -->
                        <div class="absolute left-6 w-4 h-4 bg-yellow-500 rounded-full border-4 border-white shadow-md"></div>

                        <!-- Content -->
                        <div class="bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition-shadow duration-200">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="text-lg font-semibold text-gray-900">${qp.name}</h4>
                                    <p class="text-gray-600 text-sm">${qp.subject}</p>
                                </div>
                                <span class="text-sm text-gray-500">${formattedTime}</span>
                            </div>

                            <div class="flex items-center space-x-4 text-sm text-gray-500 mb-3">
                                <span><i class="fas fa-clock mr-1"></i>${qp.duration}h</span>
                                <span><i class="fas fa-star mr-1"></i>${qp.totalMarks} marks</span>
                                <span><i class="fas fa-question-circle mr-1"></i>${qp.questionCount} questions</span>
                            </div>

                            <div class="flex justify-between items-center">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-${statusColor}-100 text-${statusColor}-800">
                                    <i class="${statusIcon} mr-1"></i>
                                    ${qp.status.charAt(0).toUpperCase() + qp.status.slice(1)}
                                </span>

                                <div class="flex space-x-2">
                                    <button class="view-recent-btn p-1 text-blue-600 hover:text-blue-800" title="View">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="share-recent-btn p-1 text-green-600 hover:text-green-800" title="Share">
                                        <i class="fas fa-share-alt"></i>
                                    </button>
                                    <button class="download-pdf-btn p-1 text-red-600 hover:text-red-800" title="Download PDF">
                                        <i class="fas fa-file-pdf"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Create grid card
            function createGridCard(qp) {
                const formattedDate = new Date(qp.generatedDate).toLocaleDateString();
                const statusColor = getStatusColor(qp.status);
                const statusIcon = getStatusIcon(qp.status);

                return `
                    <div class="recent-grid-card bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow duration-200 overflow-hidden" data-qp-id="${qp.id}">
                        <!-- Header -->
                        <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 p-4 text-white">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-lg truncate">${qp.name}</h4>
                                    <p class="text-yellow-100 text-sm truncate">${qp.subject}</p>
                                </div>
                                <i class="fas fa-file-alt text-2xl text-yellow-200"></i>
                            </div>
                        </div>

                        <!-- Content -->
                        <div class="p-4">
                            <div class="space-y-2 mb-4">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Generated:</span>
                                    <span class="font-medium">${formattedDate}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Duration:</span>
                                    <span class="font-medium">${qp.duration} hours</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Total Marks:</span>
                                    <span class="font-medium">${qp.totalMarks}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Questions:</span>
                                    <span class="font-medium">${qp.questionCount}</span>
                                </div>
                            </div>

                            <div class="flex justify-between items-center mb-4">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-${statusColor}-100 text-${statusColor}-800">
                                    <i class="${statusIcon} mr-1"></i>
                                    ${qp.status.charAt(0).toUpperCase() + qp.status.slice(1)}
                                </span>
                                <div class="text-xs text-gray-500">
                                    <i class="fas fa-download mr-1"></i>${qp.downloadCount}
                                    <i class="fas fa-share ml-2 mr-1"></i>${qp.shareCount}
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="flex space-x-2">
                                <button class="view-recent-btn flex-1 px-3 py-2 bg-blue-600 text-white text-sm rounded-md hover:bg-blue-700 transition duration-200">
                                    <i class="fas fa-eye mr-1"></i>View
                                </button>
                                <button class="download-pdf-btn flex-1 px-3 py-2 bg-red-600 text-white text-sm rounded-md hover:bg-red-700 transition duration-200">
                                    <i class="fas fa-file-pdf mr-1"></i>PDF
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Get status color
            function getStatusColor(status) {
                switch (status) {
                    case 'success': return 'green';
                    case 'downloaded': return 'blue';
                    case 'shared': return 'purple';
                    case 'archived': return 'gray';
                    default: return 'yellow';
                }
            }

            // Get status icon
            function getStatusIcon(status) {
                switch (status) {
                    case 'success': return 'fas fa-check-circle';
                    case 'downloaded': return 'fas fa-download';
                    case 'shared': return 'fas fa-share-alt';
                    case 'archived': return 'fas fa-archive';
                    default: return 'fas fa-clock';
                }
            }

            // Update recent pagination
            function updateRecentPagination(totalItems) {
                const pagination = document.getElementById('recent-pagination');
                const startSpan = document.getElementById('recent-pagination-start');
                const endSpan = document.getElementById('recent-pagination-end');
                const totalSpan = document.getElementById('recent-pagination-total');
                const prevBtn = document.getElementById('recent-pagination-prev');
                const nextBtn = document.getElementById('recent-pagination-next');

                if (totalItems <= recentItemsPerPage) {
                    pagination.classList.add('hidden');
                    return;
                }

                pagination.classList.remove('hidden');

                const startIndex = (currentRecentPage - 1) * recentItemsPerPage + 1;
                const endIndex = Math.min(currentRecentPage * recentItemsPerPage, totalItems);

                startSpan.textContent = startIndex;
                endSpan.textContent = endIndex;
                totalSpan.textContent = totalItems;

                prevBtn.disabled = currentRecentPage === 1;
                nextBtn.disabled = currentRecentPage === Math.ceil(totalItems / recentItemsPerPage);

                // Update page numbers
                const numbersContainer = document.getElementById('recent-pagination-numbers');
                const totalPages = Math.ceil(totalItems / recentItemsPerPage);
                const maxVisiblePages = 5;

                let startPage = Math.max(1, currentRecentPage - Math.floor(maxVisiblePages / 2));
                let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

                if (endPage - startPage + 1 < maxVisiblePages) {
                    startPage = Math.max(1, endPage - maxVisiblePages + 1);
                }

                let numbersHTML = '';
                for (let i = startPage; i <= endPage; i++) {
                    const isActive = i === currentRecentPage;
                    numbersHTML += `
                        <button class="recent-pagination-number px-3 py-1 border rounded-md text-sm ${isActive ? 'bg-yellow-600 text-white border-yellow-600' : 'border-gray-300 hover:bg-gray-50'}" data-page="${i}">
                            ${i}
                        </button>
                    `;
                }

                numbersContainer.innerHTML = numbersHTML;
            }

            // Update active view button
            function updateActiveViewButton() {
                document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                    btn.classList.remove('active', 'bg-yellow-600', 'text-white');
                    btn.classList.add('bg-gray-300', 'text-gray-700');
                });

                const activeBtn = document.getElementById(`${currentRecentView}-view-btn`);
                if (activeBtn) {
                    activeBtn.classList.add('active', 'bg-yellow-600', 'text-white');
                    activeBtn.classList.remove('bg-gray-300', 'text-gray-700');
                }
            }

            // Add event listeners to recent items
            function addRecentEventListeners() {
                // View buttons
                document.querySelectorAll('.view-recent-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const qpId = e.target.closest('[data-qp-id]').dataset.qpId;
                        viewRecentQP(qpId);
                    });
                });

                // Share buttons
                document.querySelectorAll('.share-recent-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const qpId = e.target.closest('[data-qp-id]').dataset.qpId;
                        shareRecentQP(qpId);
                    });
                });

                // Download buttons
                document.querySelectorAll('.download-docx-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const qpId = e.target.closest('[data-qp-id]').dataset.qpId;
                        downloadRecentQP(qpId, 'docx');
                    });
                });

                document.querySelectorAll('.download-pdf-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const qpId = e.target.closest('[data-qp-id]').dataset.qpId;
                        downloadRecentQP(qpId, 'pdf');
                    });
                });

                // Rename buttons
                document.querySelectorAll('.rename-recent-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const qpId = e.target.closest('[data-qp-id]').dataset.qpId;
                        renameRecentQP(qpId);
                    });
                });

                // Delete buttons
                document.querySelectorAll('.delete-recent-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const qpId = e.target.closest('[data-qp-id]').dataset.qpId;
                        deleteRecentQP(qpId);
                    });
                });
            }

            // Find recent QP by ID
            function findRecentQPById(qpId) {
                return recentQPs.find(qp => qp.id === qpId);
            }

            // View recent QP details
            function viewRecentQP(qpId) {
                const qp = findRecentQPById(qpId);
                if (!qp) return;

                const modal = document.getElementById('recent-view-modal');
                const title = document.getElementById('recent-view-modal-title');
                const content = document.getElementById('recent-view-modal-content');

                title.textContent = `${qp.name} - Details`;

                content.innerHTML = `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-3">Basic Information</h4>
                                <dl class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <dt class="text-gray-600">Name:</dt>
                                        <dd class="font-medium">${qp.name}</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-600">Subject:</dt>
                                        <dd class="font-medium">${qp.subject}</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-600">Exam Type:</dt>
                                        <dd class="font-medium">${qp.examType}</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-600">Duration:</dt>
                                        <dd class="font-medium">${qp.duration} hours</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-600">Total Marks:</dt>
                                        <dd class="font-medium">${qp.totalMarks}</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-600">Questions:</dt>
                                        <dd class="font-medium">${qp.questionCount}</dd>
                                    </div>
                                </dl>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-3">Generation Details</h4>
                                <dl class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <dt class="text-gray-600">Generated:</dt>
                                        <dd class="font-medium">${new Date(qp.generatedDate).toLocaleString()}</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-600">Status:</dt>
                                        <dd class="font-medium">
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-${getStatusColor(qp.status)}-100 text-${getStatusColor(qp.status)}-800">
                                                <i class="${getStatusIcon(qp.status)} mr-1"></i>
                                                ${qp.status.charAt(0).toUpperCase() + qp.status.slice(1)}
                                            </span>
                                        </dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-600">Downloads:</dt>
                                        <dd class="font-medium">${qp.downloadCount}</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-600">Shares:</dt>
                                        <dd class="font-medium">${qp.shareCount}</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-600">File Size:</dt>
                                        <dd class="font-medium">${qp.fileSize} KB</dd>
                                    </div>
                                </dl>
                            </div>
                        </div>

                        ${qp.metadata ? `
                            <div>
                                <h4 class="font-semibold text-gray-900 mb-3">Academic Information</h4>
                                <dl class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                    <div class="flex justify-between">
                                        <dt class="text-gray-600">Department:</dt>
                                        <dd class="font-medium">${qp.metadata.department || 'N/A'}</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-600">Semester:</dt>
                                        <dd class="font-medium">${qp.metadata.semester || 'N/A'}</dd>
                                    </div>
                                    <div class="flex justify-between">
                                        <dt class="text-gray-600">Academic Year:</dt>
                                        <dd class="font-medium">${qp.metadata.academicYear || 'N/A'}</dd>
                                    </div>
                                </dl>
                            </div>
                        ` : ''}
                    </div>
                `;

                // Set up download button
                const downloadBtn = document.getElementById('recent-view-modal-download');
                downloadBtn.onclick = () => {
                    downloadRecentQP(qpId, 'pdf');
                };

                showModal(modal.id);
            }

            // Close recent modal
            window.closeRecentModal = function (modalId) {
                document.getElementById(modalId).classList.add('hidden');
            };

            // Placeholder functions for actions (to be implemented)
            function shareRecentQP(qpId) {
                const qp = findRecentQPById(qpId);
                if (!qp) return;

                // Show share modal
                const modal = document.getElementById('recent-share-modal');
                const linkInput = document.getElementById('share-link-input');

                // Generate share link (placeholder)
                const shareLink = `${window.location.origin}/share/qp/${qpId}`;
                linkInput.value = shareLink;

                showModal(modal.id);

                // Copy link functionality
                document.getElementById('copy-link-btn').onclick = () => {
                    linkInput.select();
                    document.execCommand('copy');
                    displayMessageBox('âœ… Share link copied to clipboard!', 'success');
                };
            }

            function downloadRecentQP(qpId, format) {
                const qp = findRecentQPById(qpId);
                if (!qp) return;

                // Try to find the corresponding saved question paper
                const savedQPs = JSON.parse(localStorage.getItem('saved-question-papers') || '[]');
                const savedQP = savedQPs.find(saved => saved.id === qpId);

                if (savedQP && savedQP.questions) {
                    // Generate and download the actual document
                    generateDocumentFromSaved(savedQP, format);
                } else {
                    // If no saved data, show message
                    displayMessageBox(`âš ï¸ Original question paper data not found. Please regenerate the question paper.`, 'warning');
                    return;
                }

                // Update download count
                qp.downloadCount++;
                qp.status = 'downloaded';
                localStorage.setItem('recent-generated-qps', JSON.stringify(recentQPs));

                // Refresh display
                updateRecentStatistics();
                renderRecentQPs();
            }

            // Function to generate document from saved question paper
            async function generateDocumentFromSaved(savedQP, format) {
                const user = window.firebaseAuth.currentUser;
                if (!user) {
                    displayMessageBox('Please log in to download the document.', 'error');
                    return;
                }

                try {
                    const idToken = await user.getIdToken();
                    const fileName = `${savedQP.name.replace(/[^a-z0-9]/gi, '_')}.${format}`;

                    const response = await fetch('/generate_final_document', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${idToken}`
                        },
                        body: JSON.stringify({
                            questions: savedQP.questions,
                            metadata: {
                                subject: savedQP.subject,
                                courseCode: savedQP.courseCode,
                                department: savedQP.department,
                                semester: savedQP.semester,
                                examType: savedQP.examType,
                                duration: savedQP.duration,
                                maxMarks: savedQP.maxMarks,
                                date: new Date().toLocaleDateString(),
                                time: savedQP.duration || '3 hours'
                            },
                            format: format
                        })
                    });

                    if (response.ok) {
                        // Handle file download
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = fileName;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);

                        displayMessageBox(`âœ… "${savedQP.name}" downloaded as ${format.toUpperCase()}!`, 'success');
                    } else {
                        const errorData = await response.json();
                        displayMessageBox(`âŒ Failed to generate ${format.toUpperCase()}: ${errorData.error || 'Unknown error'}`, 'error');
                    }
                } catch (error) {
                    console.error('Download error:', error);
                    displayMessageBox(`âŒ Network error: ${error.message}`, 'error');
                }
            }

            function renameRecentQP(qpId) {
                const qp = findRecentQPById(qpId);
                if (!qp) return;

                const modal = document.getElementById('recent-rename-modal');
                const input = document.getElementById('rename-input');

                input.value = qp.name;
                showModal(modal.id);

                document.getElementById('confirm-rename-btn').onclick = () => {
                    const newName = input.value.trim();
                    if (newName && newName !== qp.name) {
                        qp.name = newName;
                        localStorage.setItem('recent-generated-qps', JSON.stringify(recentQPs));
                        renderRecentQPs();
                        displayMessageBox('âœ… Question paper renamed successfully!', 'success');
                    }
                    closeRecentModal('recent-rename-modal');
                };
            }

            function deleteRecentQP(qpId) {
                const qp = findRecentQPById(qpId);
                if (!qp) return;

                const modal = document.getElementById('recent-delete-modal');
                const message = document.getElementById('recent-delete-modal-message');

                message.textContent = `Are you sure you want to delete "${qp.name}"? This action cannot be undone.`;
                showModal(modal.id);

                document.getElementById('recent-confirm-delete-btn').onclick = () => {
                    recentQPs = recentQPs.filter(item => item.id !== qpId);
                    localStorage.setItem('recent-generated-qps', JSON.stringify(recentQPs));
                    updateRecentStatistics();
                    renderRecentQPs();
                    displayMessageBox('âœ… Question paper deleted successfully!', 'success');
                    closeRecentModal('recent-delete-modal');
                };
            }

            function exportRecentQPs() {
                const filteredQPs = getFilteredRecentQPs();
                const dataStr = JSON.stringify(filteredQPs, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `recent_question_papers_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                displayMessageBox('âœ… Recent QPs exported successfully!', 'success');
            }

            // Setup event listeners for recent functionality
            function setupRecentEventListeners() {
                // Search input
                const searchInput = document.getElementById('recent-search');
                if (searchInput) {
                    searchInput.addEventListener('input', debounce(() => {
                        currentRecentPage = 1;
                        renderRecentQPs();
                    }, 300));
                }

                // Filter dropdowns
                const periodFilter = document.getElementById('recent-period-filter');
                if (periodFilter) {
                    periodFilter.addEventListener('change', (e) => {
                        currentRecentPeriod = e.target.value;
                        currentRecentPage = 1;
                        renderRecentQPs();
                    });
                }

                const statusFilter = document.getElementById('recent-status-filter');
                if (statusFilter) {
                    statusFilter.addEventListener('change', (e) => {
                        currentRecentStatus = e.target.value;
                        currentRecentPage = 1;
                        renderRecentQPs();
                    });
                }

                const sortSelect = document.getElementById('recent-sort');
                if (sortSelect) {
                    sortSelect.addEventListener('change', (e) => {
                        currentRecentSort = e.target.value;
                        renderRecentQPs();
                    });
                }

                // View toggle buttons
                document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const viewType = e.target.id.replace('-view-btn', '').replace('list', 'list').replace('timeline', 'timeline').replace('grid', 'grid');
                        currentRecentView = viewType;
                        updateActiveViewButton();
                        renderRecentQPs();
                    });
                });

                // Header buttons
                const refreshBtn = document.getElementById('refresh-recent-btn');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', () => {
                        loadRecentQPs();
                        updateRecentStatistics();
                        renderRecentQPs();
                        displayMessageBox('âœ… Recent QPs refreshed successfully!', 'success');
                    });
                }

                const clearHistoryBtn = document.getElementById('clear-history-btn');
                if (clearHistoryBtn) {
                    clearHistoryBtn.addEventListener('click', () => {
                        if (confirm('Are you sure you want to clear all recent question papers? This action cannot be undone.')) {
                            recentQPs = [];
                            localStorage.setItem('recent-generated-qps', JSON.stringify([]));
                            updateRecentStatistics();
                            renderRecentQPs();
                            displayMessageBox('âœ… Recent QPs history cleared!', 'success');
                        }
                    });
                }

                const exportBtn = document.getElementById('export-recent-btn');
                if (exportBtn) {
                    exportBtn.addEventListener('click', () => {
                        exportRecentQPs();
                    });
                }

                // Pagination buttons
                document.getElementById('recent-pagination-prev').addEventListener('click', () => {
                    if (currentRecentPage > 1) {
                        currentRecentPage--;
                        renderRecentQPs();
                    }
                });

                document.getElementById('recent-pagination-next').addEventListener('click', () => {
                    const totalItems = getFilteredRecentQPs().length;
                    const totalPages = Math.ceil(totalItems / recentItemsPerPage);
                    if (currentRecentPage < totalPages) {
                        currentRecentPage++;
                        renderRecentQPs();
                    }
                });

                // Pagination number clicks
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('recent-pagination-number')) {
                        currentRecentPage = parseInt(e.target.dataset.page);
                        renderRecentQPs();
                    }
                });
            }

            // --- Settings & Help Functionality ---

            // Settings management
            let userSettings = {
                general: {
                    defaultSubject: '',
                    defaultDepartment: '',
                    defaultSemester: '',
                    defaultAcademicYear: '',
                    notifyGenerationComplete: true,
                    notifySaveSuccess: true,
                    notifyErrors: true,
                    notifyTips: true,
                    autoSaveEnabled: true,
                    autoSaveInterval: 300,
                    backupToCloud: false
                },
                appearance: {
                    themeMode: 'light',
                    fontSize: 'medium',
                    sidebarWidth: 'normal',
                    enableAnimations: true,
                    enableHoverEffects: true,
                    enableLoadingAnimations: true,
                    reduceMotion: false,
                    primaryColor: '#3B82F6',
                    accentColor: '#10B981',
                    warningColor: '#F59E0B',
                    dangerColor: '#EF4444'
                },
                generation: {
                    defaultTotalMarks: 100,
                    defaultDuration: 3,
                    defaultSelectionStrategy: 'balanced',
                    defaultDifficulty: 'mixed',
                    defaultFormat: 'docx',
                    includeHeader: true,
                    includeInstructions: true,
                    includeMarkingScheme: false,
                    numberQuestions: true,
                    validateBloomsTaxonomy: true,
                    validateCoCoverage: true,
                    validateDifficultyBalance: true,
                    checkDuplicateQuestions: true,
                    validateTotalMarks: true
                },
                advanced: {
                    enableDebugMode: false,
                    showPerformanceMetrics: false,
                    enableExperimentalFeatures: false,
                    encryptLocalData: false,
                    clearOnExit: false,
                    anonymousUsage: false
                }
            };

            // Initialize settings when shown
            function initializeSettingsContent() {
                loadUserSettings();
                setupSettingsEventListeners();
                updateSettingsUI();
                updateStorageInfo();
                updateSystemInfo();
            }

            // Load user settings from localStorage
            function loadUserSettings() {
                const savedSettings = localStorage.getItem('smartqpgen-settings');
                if (savedSettings) {
                    try {
                        const parsed = JSON.parse(savedSettings);
                        userSettings = { ...userSettings, ...parsed };
                    } catch (e) {
                        console.warn('Failed to load settings:', e);
                    }
                }
            }

            // Save user settings to localStorage
            function saveUserSettings() {
                localStorage.setItem('smartqpgen-settings', JSON.stringify(userSettings));
                displayMessageBox('âœ… Settings saved successfully!', 'success');
            }

            // Update settings UI with current values
            function updateSettingsUI() {
                // General settings
                document.getElementById('default-subject').value = userSettings.general.defaultSubject;
                document.getElementById('default-department').value = userSettings.general.defaultDepartment;
                document.getElementById('default-semester').value = userSettings.general.defaultSemester;
                document.getElementById('default-academic-year').value = userSettings.general.defaultAcademicYear;

                // Notification checkboxes
                document.getElementById('notify-generation-complete').checked = userSettings.general.notifyGenerationComplete;
                document.getElementById('notify-save-success').checked = userSettings.general.notifySaveSuccess;
                document.getElementById('notify-errors').checked = userSettings.general.notifyErrors;
                document.getElementById('notify-tips').checked = userSettings.general.notifyTips;

                // Auto-save settings
                document.getElementById('auto-save-enabled').checked = userSettings.general.autoSaveEnabled;
                document.getElementById('auto-save-interval').value = userSettings.general.autoSaveInterval;
                document.getElementById('backup-to-cloud').checked = userSettings.general.backupToCloud;

                // Appearance settings
                document.querySelector(`input[name="theme-mode"][value="${userSettings.appearance.themeMode}"]`).checked = true;
                document.getElementById('font-size-setting').value = userSettings.appearance.fontSize;
                document.getElementById('sidebar-width-setting').value = userSettings.appearance.sidebarWidth;

                // Animation checkboxes
                document.getElementById('enable-animations').checked = userSettings.appearance.enableAnimations;
                document.getElementById('enable-hover-effects').checked = userSettings.appearance.enableHoverEffects;
                document.getElementById('enable-loading-animations').checked = userSettings.appearance.enableLoadingAnimations;
                document.getElementById('reduce-motion').checked = userSettings.appearance.reduceMotion;

                // Color settings
                document.getElementById('primary-color').value = userSettings.appearance.primaryColor;
                document.getElementById('accent-color').value = userSettings.appearance.accentColor;
                document.getElementById('warning-color').value = userSettings.appearance.warningColor;
                document.getElementById('danger-color').value = userSettings.appearance.dangerColor;

                // Generation settings
                document.getElementById('default-total-marks').value = userSettings.generation.defaultTotalMarks;
                document.getElementById('default-duration').value = userSettings.generation.defaultDuration;
                document.getElementById('default-selection-strategy').value = userSettings.generation.defaultSelectionStrategy;
                document.getElementById('default-difficulty').value = userSettings.generation.defaultDifficulty;

                // Format settings
                document.querySelector(`input[name="default-format"][value="${userSettings.generation.defaultFormat}"]`).checked = true;
                document.getElementById('include-header').checked = userSettings.generation.includeHeader;
                document.getElementById('include-instructions').checked = userSettings.generation.includeInstructions;
                document.getElementById('include-marking-scheme').checked = userSettings.generation.includeMarkingScheme;
                document.getElementById('number-questions').checked = userSettings.generation.numberQuestions;

                // Validation settings
                document.getElementById('validate-blooms-taxonomy').checked = userSettings.generation.validateBloomsTaxonomy;
                document.getElementById('validate-co-coverage').checked = userSettings.generation.validateCoCoverage;
                document.getElementById('validate-difficulty-balance').checked = userSettings.generation.validateDifficultyBalance;
                document.getElementById('check-duplicate-questions').checked = userSettings.generation.checkDuplicateQuestions;
                document.getElementById('validate-total-marks').checked = userSettings.generation.validateTotalMarks;

                // Advanced settings
                document.getElementById('enable-debug-mode').checked = userSettings.advanced.enableDebugMode;
                document.getElementById('show-performance-metrics').checked = userSettings.advanced.showPerformanceMetrics;
                document.getElementById('enable-experimental-features').checked = userSettings.advanced.enableExperimentalFeatures;
                document.getElementById('encrypt-local-data').checked = userSettings.advanced.encryptLocalData;
                document.getElementById('clear-on-exit').checked = userSettings.advanced.clearOnExit;
                document.getElementById('anonymous-usage').checked = userSettings.advanced.anonymousUsage;
            }

            // Update storage information
            function updateStorageInfo() {
                // Get storage data
                const qpData = JSON.parse(localStorage.getItem('saved-question-papers') || '[]');
                const bankData = JSON.parse(localStorage.getItem('saved-question-banks') || '[]');
                const templateData = JSON.parse(localStorage.getItem('qp-requirements-templates') || '{}');

                // Calculate sizes
                const qpSize = JSON.stringify(qpData).length / 1024; // KB
                const bankSize = JSON.stringify(bankData).length / 1024; // KB
                const templateSize = JSON.stringify(templateData).length / 1024; // KB
                const totalSize = qpSize + bankSize + templateSize;

                // Update UI
                document.getElementById('storage-qp-count').textContent = qpData.length;
                document.getElementById('storage-qp-size').textContent = qpSize.toFixed(1) + ' KB';
                document.getElementById('storage-bank-count').textContent = bankData.length;
                document.getElementById('storage-bank-size').textContent = bankSize.toFixed(1) + ' KB';
                document.getElementById('storage-template-count').textContent = Object.keys(templateData).length;
                document.getElementById('storage-template-size').textContent = templateSize.toFixed(1) + ' KB';
                document.getElementById('total-storage-size').textContent = totalSize.toFixed(1) + ' KB';

                // Update progress bar (assuming 10MB limit)
                const progressPercent = Math.min((totalSize / (10 * 1024)) * 100, 100);
                document.getElementById('storage-progress-bar').style.width = progressPercent + '%';
            }

            // Update system information
            function updateSystemInfo() {
                // Browser info
                const browserInfo = navigator.userAgent.split(' ').pop();
                document.getElementById('browser-info').textContent = browserInfo;

                // Screen resolution
                document.getElementById('screen-resolution').textContent = `${screen.width}x${screen.height}`;

                // Storage support
                document.getElementById('storage-support').textContent = typeof (Storage) !== "undefined" ? 'Supported' : 'Not Supported';

                // Last updated (current date)
                document.getElementById('last-updated').textContent = new Date().toLocaleDateString();

                // Session duration (placeholder)
                document.getElementById('session-duration').textContent = '0:00:00';
            }

            // Make functions globally available
            window.initializeRecentContent = initializeRecentContent;
            window.initializeSettingsContent = initializeSettingsContent;

            // Setup settings event listeners
            function setupSettingsEventListeners() {
                // Tab switching
                document.querySelectorAll('.settings-tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const tab = e.target.dataset.tab;
                        switchSettingsTab(tab);
                    });
                });

                // Auto-save settings on change
                const settingsInputs = document.querySelectorAll('#settings-content input, #settings-content select');
                settingsInputs.forEach(input => {
                    input.addEventListener('change', () => {
                        updateSettingsFromUI();
                        saveUserSettings();
                    });
                });

                // Color picker updates
                document.querySelectorAll('input[type="color"]').forEach(picker => {
                    picker.addEventListener('change', (e) => {
                        const textInput = e.target.nextElementSibling;
                        textInput.value = e.target.value;
                        updateSettingsFromUI();
                        saveUserSettings();
                    });
                });

                // Reset buttons
                document.getElementById('reset-settings-btn').addEventListener('click', resetAllSettings);
                document.getElementById('reset-colors-btn').addEventListener('click', resetColors);
                document.getElementById('export-settings-btn').addEventListener('click', exportSettings);

                // Data management buttons
                document.getElementById('export-all-data-btn').addEventListener('click', () => exportData('all'));
                document.getElementById('export-qp-data-btn').addEventListener('click', () => exportData('qp'));
                document.getElementById('export-settings-data-btn').addEventListener('click', () => exportData('settings'));
                document.getElementById('import-data-btn').addEventListener('click', importData);
                document.getElementById('clear-all-data-btn').addEventListener('click', clearAllData);

                // Reset options
                document.getElementById('reset-settings-only-btn').addEventListener('click', () => resetData('settings'));
                document.getElementById('reset-data-only-btn').addEventListener('click', () => resetData('data'));
                document.getElementById('factory-reset-btn').addEventListener('click', () => resetData('factory'));
            }

            // Switch settings tab
            function switchSettingsTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.settings-tab-btn').forEach(btn => {
                    if (btn.dataset.tab === tabName) {
                        btn.classList.add('active', 'border-gray-500', 'text-gray-600');
                        btn.classList.remove('border-transparent', 'text-gray-500');
                    } else {
                        btn.classList.remove('active', 'border-gray-500', 'text-gray-600');
                        btn.classList.add('border-transparent', 'text-gray-500');
                    }
                });

                // Update tab content
                document.querySelectorAll('.settings-tab-content').forEach(content => {
                    if (content.id === `settings-${tabName}-tab`) {
                        content.classList.remove('hidden');
                    } else {
                        content.classList.add('hidden');
                    }
                });
            }

            // Update settings object from UI
            function updateSettingsFromUI() {
                // General settings
                userSettings.general.defaultSubject = document.getElementById('default-subject').value;
                userSettings.general.defaultDepartment = document.getElementById('default-department').value;
                userSettings.general.defaultSemester = document.getElementById('default-semester').value;
                userSettings.general.defaultAcademicYear = document.getElementById('default-academic-year').value;

                userSettings.general.notifyGenerationComplete = document.getElementById('notify-generation-complete').checked;
                userSettings.general.notifySaveSuccess = document.getElementById('notify-save-success').checked;
                userSettings.general.notifyErrors = document.getElementById('notify-errors').checked;
                userSettings.general.notifyTips = document.getElementById('notify-tips').checked;

                userSettings.general.autoSaveEnabled = document.getElementById('auto-save-enabled').checked;
                userSettings.general.autoSaveInterval = parseInt(document.getElementById('auto-save-interval').value);
                userSettings.general.backupToCloud = document.getElementById('backup-to-cloud').checked;

                // Appearance settings
                const themeMode = document.querySelector('input[name="theme-mode"]:checked');
                if (themeMode) userSettings.appearance.themeMode = themeMode.value;

                userSettings.appearance.fontSize = document.getElementById('font-size-setting').value;
                userSettings.appearance.sidebarWidth = document.getElementById('sidebar-width-setting').value;

                userSettings.appearance.enableAnimations = document.getElementById('enable-animations').checked;
                userSettings.appearance.enableHoverEffects = document.getElementById('enable-hover-effects').checked;
                userSettings.appearance.enableLoadingAnimations = document.getElementById('enable-loading-animations').checked;
                userSettings.appearance.reduceMotion = document.getElementById('reduce-motion').checked;

                userSettings.appearance.primaryColor = document.getElementById('primary-color').value;
                userSettings.appearance.accentColor = document.getElementById('accent-color').value;
                userSettings.appearance.warningColor = document.getElementById('warning-color').value;
                userSettings.appearance.dangerColor = document.getElementById('danger-color').value;

                // Generation settings
                userSettings.generation.defaultTotalMarks = parseInt(document.getElementById('default-total-marks').value);
                userSettings.generation.defaultDuration = parseFloat(document.getElementById('default-duration').value);
                userSettings.generation.defaultSelectionStrategy = document.getElementById('default-selection-strategy').value;
                userSettings.generation.defaultDifficulty = document.getElementById('default-difficulty').value;

                const defaultFormat = document.querySelector('input[name="default-format"]:checked');
                if (defaultFormat) userSettings.generation.defaultFormat = defaultFormat.value;

                userSettings.generation.includeHeader = document.getElementById('include-header').checked;
                userSettings.generation.includeInstructions = document.getElementById('include-instructions').checked;
                userSettings.generation.includeMarkingScheme = document.getElementById('include-marking-scheme').checked;
                userSettings.generation.numberQuestions = document.getElementById('number-questions').checked;

                userSettings.generation.validateBloomsTaxonomy = document.getElementById('validate-blooms-taxonomy').checked;
                userSettings.generation.validateCoCoverage = document.getElementById('validate-co-coverage').checked;
                userSettings.generation.validateDifficultyBalance = document.getElementById('validate-difficulty-balance').checked;
                userSettings.generation.checkDuplicateQuestions = document.getElementById('check-duplicate-questions').checked;
                userSettings.generation.validateTotalMarks = document.getElementById('validate-total-marks').checked;

                // Advanced settings
                userSettings.advanced.enableDebugMode = document.getElementById('enable-debug-mode').checked;
                userSettings.advanced.showPerformanceMetrics = document.getElementById('show-performance-metrics').checked;
                userSettings.advanced.enableExperimentalFeatures = document.getElementById('enable-experimental-features').checked;
                userSettings.advanced.encryptLocalData = document.getElementById('encrypt-local-data').checked;
                userSettings.advanced.clearOnExit = document.getElementById('clear-on-exit').checked;
                userSettings.advanced.anonymousUsage = document.getElementById('anonymous-usage').checked;
            }

            // Help functionality
            function initializeHelpContent() {
                setupHelpEventListeners();
                setupFAQToggle();
            }

            // Setup help event listeners
            function setupHelpEventListeners() {
                // Tab switching
                document.querySelectorAll('.help-tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const tab = e.target.dataset.tab;
                        switchHelpTab(tab);
                    });
                });

                // Search functionality
                document.getElementById('help-search-btn').addEventListener('click', toggleHelpSearch);
                document.getElementById('help-search-input').addEventListener('input', searchHelp);
                document.getElementById('help-print-btn').addEventListener('click', printHelp);
            }

            // Switch help tab
            function switchHelpTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.help-tab-btn').forEach(btn => {
                    if (btn.dataset.tab === tabName) {
                        btn.classList.add('active', 'border-orange-500', 'text-orange-600');
                        btn.classList.remove('border-transparent', 'text-gray-500');
                    } else {
                        btn.classList.remove('active', 'border-orange-500', 'text-orange-600');
                        btn.classList.add('border-transparent', 'text-gray-500');
                    }
                });

                // Update tab content
                document.querySelectorAll('.help-tab-content').forEach(content => {
                    if (content.id === `help-${tabName}-tab`) {
                        content.classList.remove('hidden');
                    } else {
                        content.classList.add('hidden');
                    }
                });
            }

            // Setup FAQ toggle functionality
            function setupFAQToggle() {
                document.querySelectorAll('.faq-question').forEach(question => {
                    question.addEventListener('click', () => {
                        const answer = question.nextElementSibling;
                        const icon = question.querySelector('i');

                        if (answer.classList.contains('hidden')) {
                            answer.classList.remove('hidden');
                            icon.classList.remove('fa-chevron-down');
                            icon.classList.add('fa-chevron-up');
                        } else {
                            answer.classList.add('hidden');
                            icon.classList.remove('fa-chevron-up');
                            icon.classList.add('fa-chevron-down');
                        }
                    });
                });
            }

            // Toggle help search
            function toggleHelpSearch() {
                const searchBox = document.getElementById('help-search-box');
                searchBox.classList.toggle('hidden');
                if (!searchBox.classList.contains('hidden')) {
                    document.getElementById('help-search-input').focus();
                }
            }

            // Search help content
            function searchHelp() {
                const query = document.getElementById('help-search-input').value.toLowerCase();
                const resultsContainer = document.getElementById('help-search-results');

                if (query.length < 2) {
                    resultsContainer.classList.add('hidden');
                    return;
                }

                // Simple search implementation
                const searchResults = [];
                const helpContent = document.getElementById('help-content');
                const textNodes = helpContent.querySelectorAll('p, li, h4, h5');

                textNodes.forEach(node => {
                    if (node.textContent.toLowerCase().includes(query)) {
                        searchResults.push({
                            text: node.textContent.substring(0, 100) + '...',
                            element: node
                        });
                    }
                });

                if (searchResults.length > 0) {
                    resultsContainer.innerHTML = `
                        <h5 class="font-medium text-gray-800 mb-2">Search Results (${searchResults.length})</h5>
                        <div class="space-y-2">
                            ${searchResults.slice(0, 5).map(result => `
                                <div class="p-2 bg-gray-50 rounded cursor-pointer hover:bg-gray-100" onclick="scrollToElement(this.dataset.target)">
                                    <p class="text-sm text-gray-700">${result.text}</p>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    resultsContainer.classList.remove('hidden');
                } else {
                    resultsContainer.innerHTML = '<p class="text-sm text-gray-500">No results found.</p>';
                    resultsContainer.classList.remove('hidden');
                }
            }

            // Print help guide
            function printHelp() {
                window.print();
            }

            // Utility functions for settings
            function resetAllSettings() {
                if (confirm('Are you sure you want to reset all settings to default? This action cannot be undone.')) {
                    localStorage.removeItem('smartqpgen-settings');
                    location.reload();
                }
            }

            function resetColors() {
                userSettings.appearance.primaryColor = '#3B82F6';
                userSettings.appearance.accentColor = '#10B981';
                userSettings.appearance.warningColor = '#F59E0B';
                userSettings.appearance.dangerColor = '#EF4444';
                updateSettingsUI();
                saveUserSettings();
            }

            function exportSettings() {
                const dataStr = JSON.stringify(userSettings, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `smartqpgen_settings_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                displayMessageBox('âœ… Settings exported successfully!', 'success');
            }

            function exportData(type) {
                let data = {};
                let filename = '';

                switch (type) {
                    case 'all':
                        data = {
                            questionPapers: JSON.parse(localStorage.getItem('saved-question-papers') || '[]'),
                            questionBanks: JSON.parse(localStorage.getItem('saved-question-banks') || '[]'),
                            templates: JSON.parse(localStorage.getItem('qp-requirements-templates') || '{}'),
                            recentQPs: JSON.parse(localStorage.getItem('recent-generated-qps') || '[]'),
                            settings: userSettings
                        };
                        filename = 'smartqpgen_all_data';
                        break;
                    case 'qp':
                        data = {
                            questionPapers: JSON.parse(localStorage.getItem('saved-question-papers') || '[]'),
                            recentQPs: JSON.parse(localStorage.getItem('recent-generated-qps') || '[]')
                        };
                        filename = 'smartqpgen_question_papers';
                        break;
                    case 'settings':
                        data = userSettings;
                        filename = 'smartqpgen_settings';
                        break;
                }

                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `${filename}_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                displayMessageBox(`âœ… ${type === 'all' ? 'All data' : type === 'qp' ? 'Question papers' : 'Settings'} exported successfully!`, 'success');
            }

            function importData() {
                document.getElementById('import-data-file').click();

                document.getElementById('import-data-file').onchange = function (e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = function (event) {
                        try {
                            const data = JSON.parse(event.target.result);

                            if (confirm('This will overwrite existing data. Are you sure you want to continue?')) {
                                // Import data based on structure
                                if (data.questionPapers) localStorage.setItem('saved-question-papers', JSON.stringify(data.questionPapers));
                                if (data.questionBanks) localStorage.setItem('saved-question-banks', JSON.stringify(data.questionBanks));
                                if (data.templates) localStorage.setItem('qp-requirements-templates', JSON.stringify(data.templates));
                                if (data.recentQPs) localStorage.setItem('recent-generated-qps', JSON.stringify(data.recentQPs));
                                if (data.settings) localStorage.setItem('smartqpgen-settings', JSON.stringify(data.settings));

                                displayMessageBox('âœ… Data imported successfully! Refreshing page...', 'success');
                                setTimeout(() => location.reload(), 2000);
                            }
                        } catch (error) {
                            displayMessageBox('âŒ Invalid file format. Please select a valid JSON file.', 'error');
                        }
                    };
                    reader.readAsText(file);
                };
            }

            function clearAllData() {
                if (confirm('Are you sure you want to clear ALL data? This action cannot be undone and will remove all question papers, banks, templates, and settings.')) {
                    if (confirm('This is your final warning. All data will be permanently deleted. Continue?')) {
                        localStorage.clear();
                        displayMessageBox('âœ… All data cleared successfully! Refreshing page...', 'success');
                        setTimeout(() => location.reload(), 2000);
                    }
                }
            }

            function resetData(type) {
                let message = '';
                let action = null;

                switch (type) {
                    case 'settings':
                        message = 'Are you sure you want to reset all settings to default?';
                        action = () => {
                            localStorage.removeItem('smartqpgen-settings');
                            location.reload();
                        };
                        break;
                    case 'data':
                        message = 'Are you sure you want to clear all question papers, banks, and templates?';
                        action = () => {
                            localStorage.removeItem('saved-question-papers');
                            localStorage.removeItem('saved-question-banks');
                            localStorage.removeItem('qp-requirements-templates');
                            localStorage.removeItem('recent-generated-qps');
                            location.reload();
                        };
                        break;
                    case 'factory':
                        message = 'Are you sure you want to perform a factory reset? This will clear ALL data and settings.';
                        action = () => {
                            localStorage.clear();
                            location.reload();
                        };
                        break;
                }

                if (confirm(message)) {
                    if (confirm('This action cannot be undone. Continue?')) {
                        action();
                    }
                }
            }

            // --- HOD Dashboard Functionality ---

            // Initialize HOD dashboard when shown
            function initializeHODDashboard() {
                loadHODData();
                setupHODDashboardEventListeners(); // Renamed to avoid confusion
                updateHODStatistics();
                renderHODContent();
                loadPendingApprovals(); // Load approval data
            }

            // Load HOD data (sample data for demonstration)
            function loadHODData() {
                // Load existing question papers and add HOD-specific metadata
                const existingQPs = JSON.parse(localStorage.getItem('recent-generated-qps') || '[]');

                // Generate sample HOD data if none exists
                const hodData = JSON.parse(localStorage.getItem('hod-question-papers') || '[]');
                if (hodData.length === 0) {
                    hodQuestionPapers = generateSampleHODData();
                    localStorage.setItem('hod-question-papers', JSON.stringify(hodQuestionPapers));
                } else {
                    hodQuestionPapers = hodData;
                }

                // Load faculty list
                const storedFaculty = JSON.parse(localStorage.getItem('hod-faculty-list') || '[]');
                if (storedFaculty.length === 0) {
                    facultyList = generateSampleFacultyData();
                    localStorage.setItem('hod-faculty-list', JSON.stringify(facultyList));
                } else {
                    facultyList = storedFaculty;
                }
            }

            // No more sample HOD data - load real data from backend

            // No more sample faculty data - load real data from backend

            // Generate sample questions for papers
            function generateSampleQuestions(count) {
                const sampleQuestions = [
                    'Explain the concept of dynamic programming with an example.',
                    'Compare and contrast different sorting algorithms.',
                    'Design a database schema for a library management system.',
                    'Discuss the OSI model and its layers.',
                    'What are the principles of software engineering?',
                    'Implement a binary search tree in your preferred language.',
                    'Explain the concept of normalization in databases.',
                    'Describe the TCP/IP protocol suite.',
                    'What is the difference between process and thread?',
                    'Discuss various software testing techniques.'
                ];

                const questions = [];
                for (let i = 0; i < count; i++) {
                    questions.push({
                        id: i + 1,
                        text: sampleQuestions[Math.floor(Math.random() * sampleQuestions.length)],
                        marks: [5, 10, 15, 20][Math.floor(Math.random() * 4)],
                        difficulty: ['easy', 'medium', 'hard'][Math.floor(Math.random() * 3)],
                        co: `CO${Math.floor(Math.random() * 5) + 1}`,
                        blooms: ['remember', 'understand', 'apply', 'analyze', 'evaluate', 'create'][Math.floor(Math.random() * 6)]
                    });
                }

                return questions;
            }

            // Update HOD statistics
            function updateHODStatistics() {
                const pendingCount = hodQuestionPapers.filter(paper => paper.status === 'pending').length;
                const approvedCount = hodQuestionPapers.filter(paper => paper.status === 'approved').length;
                const revisionCount = hodQuestionPapers.filter(paper => paper.status === 'revision').length;
                const facultyCount = facultyList.length;

                document.getElementById('hod-pending-count').textContent = pendingCount;
                document.getElementById('hod-approved-count').textContent = approvedCount;
                document.getElementById('hod-revision-count').textContent = revisionCount;
                document.getElementById('hod-faculty-count').textContent = facultyCount;

                // Update tab counts
                document.getElementById('tab-pending-count').textContent = pendingCount;
                document.getElementById('tab-approved-count').textContent = approvedCount;
                document.getElementById('tab-revision-count').textContent = revisionCount;
            }

            // Make functions globally available
            window.initializeHelpContent = initializeHelpContent;
            window.initializeSettingsContent = initializeSettingsContent;
            // --- HOD Approval Management Functions ---

            // Load pending approvals
            async function loadPendingApprovals() {
                try {
                    const user = window.firebaseAuth.currentUser;
                    if (!user) {
                        console.error('User not authenticated');
                        return;
                    }

                    const idToken = await user.getIdToken();
                    const response = await fetch('/get_pending_approvals', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${idToken}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        renderApprovalsList(data.approvals);
                        updateApprovalStatistics(data.approvals);
                    } else {
                        console.error('Failed to load pending approvals:', await response.text());
                        showNoApprovalsMessage();
                    }
                } catch (error) {
                    console.error('Error loading pending approvals:', error);
                    showNoApprovalsMessage();
                }
            }

            // Render approvals list
            function renderApprovalsList(approvals) {
                const approvalsList = document.getElementById('approvals-list');
                const noApprovalsMessage = document.getElementById('no-approvals-message');

                if (!approvalsList) return;

                if (!approvals || approvals.length === 0) {
                    approvalsList.innerHTML = '';
                    if (noApprovalsMessage) {
                        noApprovalsMessage.classList.remove('hidden');
                    }
                    return;
                }

                if (noApprovalsMessage) {
                    noApprovalsMessage.classList.add('hidden');
                }

                approvalsList.innerHTML = approvals.map(approval => createApprovalCard(approval)).join('');
            }

            // Create approval card
            function createApprovalCard(approval) {
                const submittedDate = new Date(approval.submitted_at?.seconds * 1000).toLocaleString();
                const priorityClass = getPriorityClass(approval.priority);
                const statusClass = getStatusClass(approval.status);

                return `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-2">
                                    <h5 class="font-semibold text-gray-800">${approval.paper_name}</h5>
                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">
                                        ${approval.status.replace('_', ' ').toUpperCase()}
                                    </span>
                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${priorityClass}">
                                        ${approval.priority.toUpperCase()}
                                    </span>
                                </div>
                                <div class="text-sm text-gray-600 space-y-1">
                                    <p><strong>Faculty:</strong> ${approval.faculty_name}</p>
                                    <p><strong>Subject:</strong> ${approval.subject}</p>
                                    <p><strong>Pattern:</strong> ${approval.pattern.toUpperCase()}</p>
                                    <p><strong>Submitted:</strong> ${submittedDate}</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="viewApprovalDetails('${approval.id}')" class="px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">
                                    <i class="fas fa-eye mr-1"></i>View
                                </button>
                                ${approval.status === 'pending_approval' ? `
                                    <button onclick="approvePaper('${approval.id}')" class="px-3 py-1 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm">
                                        <i class="fas fa-check mr-1"></i>Approve
                                    </button>
                                    <button onclick="requestRevision('${approval.id}')" class="px-3 py-1 bg-yellow-600 text-white rounded-md hover:bg-yellow-700 text-sm">
                                        <i class="fas fa-edit mr-1"></i>Request Revision
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        
                        ${approval.faculty_comments ? `
                            <div class="mt-3 p-3 bg-blue-50 rounded-lg border-l-4 border-blue-400">
                                <p class="text-sm text-blue-800"><strong>Faculty Comments:</strong> ${approval.faculty_comments}</p>
                            </div>
                        ` : ''}
                        
                        ${approval.hod_comments ? `
                            <div class="mt-3 p-3 bg-purple-50 rounded-lg border-l-4 border-purple-400">
                                <p class="text-sm text-purple-800"><strong>HOD Comments:</strong> ${approval.hod_comments}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // Get priority class for styling
            function getPriorityClass(priority) {
                switch (priority) {
                    case 'urgent': return 'bg-red-100 text-red-800';
                    case 'high': return 'bg-orange-100 text-orange-800';
                    case 'medium': return 'bg-yellow-100 text-yellow-800';
                    case 'low': return 'bg-green-100 text-green-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            }

            // Get status class for styling
            function getStatusClass(status) {
                switch (status) {
                    case 'pending_approval': return 'bg-yellow-100 text-yellow-800';
                    case 'approved': return 'bg-green-100 text-green-800';
                    case 'revision_requested': return 'bg-red-100 text-red-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            }

            // Update approval statistics
            function updateApprovalStatistics(approvals) {
                const pendingCount = approvals.filter(a => a.status === 'pending_approval').length;
                const approvedCount = approvals.filter(a => a.status === 'approved').length;
                const revisionCount = approvals.filter(a => a.status === 'revision_requested').length;

                const pendingElement = document.getElementById('hod-pending-count');
                const approvedElement = document.getElementById('hod-approved-count');
                const revisionElement = document.getElementById('hod-revision-count');

                if (pendingElement) pendingElement.textContent = pendingCount;
                if (approvedElement) approvedElement.textContent = approvedCount;
                if (revisionElement) revisionElement.textContent = revisionCount;
            }

            // Show no approvals message
            function showNoApprovalsMessage() {
                const approvalsList = document.getElementById('approvals-list');
                const noApprovalsMessage = document.getElementById('no-approvals-message');

                if (approvalsList) approvalsList.innerHTML = '';
                if (noApprovalsMessage) noApprovalsMessage.classList.remove('hidden');
            }

            // Approve paper
            async function approvePaper(approvalId) {
                const comments = prompt('Add approval comments (optional):');
                if (comments === null) return; // User cancelled

                try {
                    const user = window.firebaseAuth.currentUser;
                    if (!user) {
                        displayMessageBox('Please log in to approve papers.', 'error');
                        return;
                    }

                    const idToken = await user.getIdToken();
                    const response = await fetch('/approve_paper', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${idToken}`
                        },
                        body: JSON.stringify({
                            approval_id: approvalId,
                            comments: comments
                        })
                    });

                    const data = await response.json();
                    if (response.ok) {
                        displayMessageBox(data.message, 'success');
                        loadPendingApprovals(); // Refresh the list
                    } else {
                        displayMessageBox(data.error || 'Failed to approve paper', 'error');
                    }
                } catch (error) {
                    console.error('Error approving paper:', error);
                    displayMessageBox('Failed to approve paper. Please try again.', 'error');
                }
            }

            // Request revision
            async function requestRevision(approvalId) {
                const comments = prompt('Add revision comments:');
                if (!comments || comments.trim() === '') {
                    displayMessageBox('Please provide revision comments.', 'warning');
                    return;
                }

                const revisionType = prompt('Revision type (minor/major/complete_rewrite):', 'minor');
                if (!revisionType) return;

                try {
                    const user = window.firebaseAuth.currentUser;
                    if (!user) {
                        displayMessageBox('Please log in to request revisions.', 'error');
                        return;
                    }

                    const idToken = await user.getIdToken();
                    const response = await fetch('/request_revision', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${idToken}`
                        },
                        body: JSON.stringify({
                            approval_id: approvalId,
                            comments: comments,
                            revision_type: revisionType
                        })
                    });

                    const data = await response.json();
                    if (response.ok) {
                        displayMessageBox(data.message, 'success');
                        loadPendingApprovals(); // Refresh the list
                    } else {
                        displayMessageBox(data.error || 'Failed to request revision', 'error');
                    }
                } catch (error) {
                    console.error('Error requesting revision:', error);
                    displayMessageBox('Failed to request revision. Please try again.', 'error');
                }
            }

            // View approval details
            function viewApprovalDetails(approvalId) {
                // This would open a detailed view modal
                displayMessageBox('Detailed view functionality coming soon!', 'info');
            }

            // Make functions globally available
            window.approvePaper = approvePaper;
            window.requestRevision = requestRevision;
            window.viewApprovalDetails = viewApprovalDetails;

            window.initializeHODDashboard = initializeHODDashboard;
            window.switchToHODView = switchToHODView;
            window.switchToFacultyView = switchToFacultyView;
            window.setupRoleSwitchingListeners = setupRoleSwitchingListeners;

            // Role switching functionality
            function switchToHODView() {
                try {
                    console.log('Switching to HOD view...');
                    currentUserRole = 'hod';
                    updateUserInterface();

                    // Update user display
                    const roleBadge = document.getElementById('user-role-badge');
                    if (roleBadge) {
                        roleBadge.innerHTML = '<i class="fas fa-crown mr-1"></i>HOD';
                        roleBadge.className = 'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800';
                    }

                    // Update dropdown
                    const switchToHOD = document.getElementById('switch-to-hod-view');
                    const switchToFaculty = document.getElementById('switch-to-faculty-view');
                    if (switchToHOD) switchToHOD.classList.add('hidden');
                    if (switchToFaculty) switchToFaculty.classList.remove('hidden');

                    // Show HOD content
                    const hodContent = document.getElementById('hod-dashboard-content');
                    if (hodContent && typeof showContent === 'function') {
                        showContent(hodContent, 'HOD Dashboard');
                    } else {
                        // Fallback: show content manually
                        document.querySelectorAll('#main-canvas > div').forEach(div => div.classList.add('hidden'));
                        if (hodContent) hodContent.classList.remove('hidden');
                        const title = document.getElementById('current-view-title');
                        if (title) title.textContent = 'HOD Dashboard';
                    }

                    displayMessageBox('âœ… Switched to HOD view successfully!', 'success');
                    console.log('HOD view activated successfully');
                } catch (error) {
                    console.error('Error switching to HOD view:', error);
                    displayMessageBox('âŒ Error switching to HOD view. Check console for details.', 'error');
                }
            }

            function switchToFacultyView() {
                currentUserRole = 'faculty';
                updateUserInterface();
                showContent(welcomeContent, 'Dashboard');

                // Update user display
                document.getElementById('user-role-badge').innerHTML = '<i class="fas fa-user mr-1"></i>Faculty';
                document.getElementById('user-role-badge').className = 'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800';

                // Update dropdown
                document.getElementById('switch-to-faculty-view').classList.add('hidden');
                document.getElementById('switch-to-hod-view').classList.remove('hidden');

                displayMessageBox('âœ… Switched to Faculty view successfully!', 'success');
            }

            // Update UI based on current role
            function updateUserInterface() {
                // This function can be expanded to show/hide different menu items based on role
                if (currentUserRole === 'hod') {
                    // HOD-specific UI updates
                    console.log('HOD interface activated');
                } else {
                    // Faculty-specific UI updates
                    console.log('Faculty interface activated');
                }
            }

            // Setup role switching event listeners (called immediately on page load)
            function setupRoleSwitchingListeners() {
                // Role switching
                const switchToHODBtn = document.getElementById('switch-to-hod-view');
                const switchToFacultyBtn = document.getElementById('switch-to-faculty-view');

                if (switchToHODBtn) {
                    switchToHODBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        console.log('Switch to HOD clicked'); // Debug log
                        switchToHODView();
                    });
                }

                if (switchToFacultyBtn) {
                    switchToFacultyBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        console.log('Switch to Faculty clicked'); // Debug log
                        switchToFacultyView();
                    });
                }
            }

            // Setup HOD dashboard event listeners (called when HOD dashboard is shown)
            function setupHODDashboardEventListeners() {
                // HOD tab switching
                document.querySelectorAll('.hod-tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const tab = e.target.dataset.tab;
                        switchHODTab(tab);
                    });
                });

                // Search and filters
                const searchInput = document.getElementById('hod-search');
                if (searchInput) {
                    searchInput.addEventListener('input', debounce(() => {
                        currentHODPage = 1;
                        renderHODContent();
                    }, 300));
                }

                const statusFilter = document.getElementById('hod-status-filter');
                if (statusFilter) {
                    statusFilter.addEventListener('change', (e) => {
                        currentHODFilter = e.target.value;
                        currentHODPage = 1;
                        renderHODContent();
                    });
                }

                const facultyFilter = document.getElementById('hod-faculty-filter');
                if (facultyFilter) {
                    // Populate faculty filter options
                    facultyFilter.innerHTML = '<option value="all">All Faculty</option>' +
                        facultyList.map(faculty => `<option value="${faculty.id}">${faculty.name}</option>`).join('');

                    facultyFilter.addEventListener('change', (e) => {
                        currentHODPage = 1;
                        renderHODContent();
                    });
                }

                const sortSelect = document.getElementById('hod-sort');
                if (sortSelect) {
                    sortSelect.addEventListener('change', (e) => {
                        renderHODContent();
                    });
                }

                // Header buttons
                document.getElementById('hod-refresh-btn').addEventListener('click', () => {
                    loadHODData();
                    updateHODStatistics();
                    renderHODContent();
                    displayMessageBox('âœ… HOD dashboard refreshed!', 'success');
                });

                document.getElementById('hod-reports-btn').addEventListener('click', () => {
                    showModal('hod-reports-modal');
                });

                document.getElementById('hod-settings-btn').addEventListener('click', () => {
                    displayMessageBox('ðŸ”§ HOD settings coming soon!', 'info');
                });
            }

            // Switch HOD tab
            function switchHODTab(tabName) {
                currentHODTab = tabName;

                // Update tab buttons
                document.querySelectorAll('.hod-tab-btn').forEach(btn => {
                    if (btn.dataset.tab === tabName) {
                        btn.classList.add('active', 'border-purple-500', 'text-purple-600');
                        btn.classList.remove('border-transparent', 'text-gray-500');
                    } else {
                        btn.classList.remove('active', 'border-purple-500', 'text-purple-600');
                        btn.classList.add('border-transparent', 'text-gray-500');
                    }
                });

                // Show/hide content based on tab
                if (tabName === 'faculty') {
                    document.getElementById('hod-papers-list').classList.add('hidden');
                    document.getElementById('hod-faculty-management').classList.remove('hidden');
                    renderFacultyManagement();
                } else {
                    document.getElementById('hod-faculty-management').classList.add('hidden');
                    document.getElementById('hod-papers-list').classList.remove('hidden');
                    renderHODContent();
                }
            }

            // Render HOD content based on current tab and filters
            function renderHODContent() {
                if (currentHODTab === 'faculty') {
                    renderFacultyManagement();
                    return;
                }

                const filteredPapers = getFilteredHODPapers();
                const startIndex = (currentHODPage - 1) * hodItemsPerPage;
                const endIndex = startIndex + hodItemsPerPage;
                const pagePapers = filteredPapers.slice(startIndex, endIndex);

                const container = document.getElementById('hod-papers-list');
                const emptyState = document.getElementById('hod-empty');

                if (filteredPapers.length === 0) {
                    container.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    return;
                }

                emptyState.classList.add('hidden');
                container.innerHTML = pagePapers.map(paper => createHODPaperCard(paper)).join('');

                // Add event listeners to paper cards
                addHODPaperEventListeners();
            }

            // Get filtered HOD papers
            function getFilteredHODPapers() {
                let filtered = [...hodQuestionPapers];

                // Filter by tab
                if (currentHODTab !== 'all') {
                    filtered = filtered.filter(paper => paper.status === currentHODTab);
                }

                // Filter by status
                if (currentHODFilter !== 'all') {
                    filtered = filtered.filter(paper => paper.status === currentHODFilter);
                }

                // Filter by faculty
                const facultyFilter = document.getElementById('hod-faculty-filter');
                if (facultyFilter && facultyFilter.value !== 'all') {
                    const selectedFaculty = facultyList.find(f => f.id === facultyFilter.value);
                    if (selectedFaculty) {
                        filtered = filtered.filter(paper => paper.facultyName === selectedFaculty.name);
                    }
                }

                // Apply search
                const searchTerm = document.getElementById('hod-search').value.toLowerCase();
                if (searchTerm) {
                    filtered = filtered.filter(paper =>
                        paper.facultyName.toLowerCase().includes(searchTerm) ||
                        paper.subject.toLowerCase().includes(searchTerm) ||
                        paper.paperName.toLowerCase().includes(searchTerm)
                    );
                }

                // Apply sorting
                const sortValue = document.getElementById('hod-sort').value;
                filtered.sort((a, b) => {
                    switch (sortValue) {
                        case 'date-desc':
                            return new Date(b.submittedDate) - new Date(a.submittedDate);
                        case 'date-asc':
                            return new Date(a.submittedDate) - new Date(b.submittedDate);
                        case 'priority-desc':
                            const priorityOrder = { urgent: 4, high: 3, medium: 2, low: 1 };
                            return priorityOrder[b.priority] - priorityOrder[a.priority];
                        case 'faculty-asc':
                            return a.facultyName.localeCompare(b.facultyName);
                        case 'subject-asc':
                            return a.subject.localeCompare(b.subject);
                        default:
                            return 0;
                    }
                });

                return filtered;
            }

            // Create HOD paper card
            function createHODPaperCard(paper) {
                const statusColor = getHODStatusColor(paper.status);
                const priorityColor = getPriorityColor(paper.priority);
                const formattedDate = new Date(paper.submittedDate).toLocaleDateString();
                const formattedTime = new Date(paper.submittedDate).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                return `
                    <div class="hod-paper-card bg-gray-50 rounded-lg p-4 hover:bg-gray-100 transition-colors duration-200 border border-gray-200" data-paper-id="${paper.id}">
                        <div class="flex items-start justify-between">
                            <div class="flex items-start space-x-4 flex-1">
                                <div class="bg-purple-100 rounded-lg p-3">
                                    <i class="fas fa-file-alt text-purple-600 text-xl"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h4 class="text-lg font-semibold text-gray-900 truncate">${paper.paperName}</h4>
                                    <p class="text-gray-600 text-sm mb-2">by ${paper.facultyName} â€¢ ${paper.subject}</p>
                                    <div class="flex items-center space-x-4 text-sm text-gray-500 mb-2">
                                        <span class="flex items-center">
                                            <i class="fas fa-calendar-alt mr-1"></i>
                                            ${formattedDate} at ${formattedTime}
                                        </span>
                                        <span class="flex items-center">
                                            <i class="fas fa-clock mr-1"></i>
                                            ${paper.duration}h
                                        </span>
                                        <span class="flex items-center">
                                            <i class="fas fa-star mr-1"></i>
                                            ${paper.totalMarks} marks
                                        </span>
                                        <span class="flex items-center">
                                            <i class="fas fa-question-circle mr-1"></i>
                                            ${paper.questionCount} questions
                                        </span>
                                    </div>
                                    <div class="flex items-center space-x-2">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-${statusColor}-100 text-${statusColor}-800">
                                            ${getStatusIcon(paper.status)} ${paper.status.charAt(0).toUpperCase() + paper.status.slice(1)}
                                        </span>
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-${priorityColor}-100 text-${priorityColor}-800">
                                            ${getPriorityIcon(paper.priority)} ${paper.priority.charAt(0).toUpperCase() + paper.priority.slice(1)}
                                        </span>
                                        ${paper.comments ? `<span class="text-xs text-blue-600"><i class="fas fa-comment mr-1"></i>Has Comments</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2 ml-4">
                                <button class="review-paper-btn p-2 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded-md transition-colors duration-200" title="Review Paper">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${paper.status === 'pending' ? `
                                    <button class="quick-approve-btn p-2 text-green-600 hover:text-green-800 hover:bg-green-50 rounded-md transition-colors duration-200" title="Quick Approve">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="quick-revision-btn p-2 text-yellow-600 hover:text-yellow-800 hover:bg-yellow-50 rounded-md transition-colors duration-200" title="Request Revision">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                ` : ''}
                                <button class="download-paper-btn p-2 text-purple-600 hover:text-purple-800 hover:bg-purple-50 rounded-md transition-colors duration-200" title="Download">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </div>
                        ${paper.comments ? `
                            <div class="mt-3 p-3 bg-blue-50 rounded-lg border-l-4 border-blue-400">
                                <p class="text-sm text-blue-800"><strong>HOD Comments:</strong> ${paper.comments}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            // Get status color
            function getHODStatusColor(status) {
                switch (status) {
                    case 'pending': return 'yellow';
                    case 'approved': return 'green';
                    case 'revision': return 'orange';
                    case 'rejected': return 'red';
                    default: return 'gray';
                }
            }

            // Get priority color
            function getPriorityColor(priority) {
                switch (priority) {
                    case 'urgent': return 'red';
                    case 'high': return 'orange';
                    case 'medium': return 'yellow';
                    case 'low': return 'green';
                    default: return 'gray';
                }
            }

            // Get status icon
            function getStatusIcon(status) {
                switch (status) {
                    case 'pending': return '<i class="fas fa-clock mr-1"></i>';
                    case 'approved': return '<i class="fas fa-check-circle mr-1"></i>';
                    case 'revision': return '<i class="fas fa-edit mr-1"></i>';
                    case 'rejected': return '<i class="fas fa-times-circle mr-1"></i>';
                    default: return '<i class="fas fa-question mr-1"></i>';
                }
            }

            // Get priority icon
            function getPriorityIcon(priority) {
                switch (priority) {
                    case 'urgent': return '<i class="fas fa-exclamation-triangle mr-1"></i>';
                    case 'high': return '<i class="fas fa-arrow-up mr-1"></i>';
                    case 'medium': return '<i class="fas fa-minus mr-1"></i>';
                    case 'low': return '<i class="fas fa-arrow-down mr-1"></i>';
                    default: return '<i class="fas fa-circle mr-1"></i>';
                }
            }

            // Quick approve paper
            function quickApprovePaper(paperId) {
                const paper = hodQuestionPapers.find(p => p.id === paperId);
                if (!paper) return;

                paper.status = 'approved';
                paper.reviewedDate = new Date().toISOString();
                paper.comments = 'Quick approved by HOD';

                saveHODData();
                updateHODStatistics();
                renderHODContent();
                displayMessageBox(`âœ… Paper "${paper.paperName}" approved successfully!`, 'success');
            }

            // Quick request revision
            function quickRequestRevision(paperId) {
                const paper = hodQuestionPapers.find(p => p.id === paperId);
                if (!paper) return;

                const comment = prompt('Please provide revision comments:');
                if (comment) {
                    paper.status = 'revision';
                    paper.reviewedDate = new Date().toISOString();
                    paper.comments = comment;

                    saveHODData();
                    updateHODStatistics();
                    renderHODContent();
                    displayMessageBox(`âœ… Revision requested for "${paper.paperName}"!`, 'success');
                }
            }

            // Download paper
            function downloadPaper(paperId) {
                const paper = hodQuestionPapers.find(p => p.id === paperId);
                if (!paper) return;

                const dataStr = JSON.stringify(paper, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);

                const link = document.createElement('a');
                link.href = url;
                link.download = `${paper.paperName.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

                displayMessageBox(`âœ… "${paper.paperName}" downloaded successfully!`, 'success');
            }

            // Save HOD data
            function saveHODData() {
                localStorage.setItem('hod-question-papers', JSON.stringify(hodQuestionPapers));
                localStorage.setItem('hod-faculty-list', JSON.stringify(facultyList));
            }

            // Close HOD modal
            window.closeHODModal = function (modalId) {
                document.getElementById(modalId).classList.add('hidden');
            };

            // Render faculty management
            function renderFacultyManagement() {
                // Update faculty statistics
                document.getElementById('active-faculty-count').textContent = facultyList.length;
                document.getElementById('monthly-papers-count').textContent = hodQuestionPapers.filter(p => {
                    const paperDate = new Date(p.submittedDate);
                    const now = new Date();
                    return paperDate.getMonth() === now.getMonth() && paperDate.getFullYear() === now.getFullYear();
                }).length;

                const avgReviewTime = facultyList.reduce((sum, faculty) => {
                    return sum + parseFloat(faculty.avgReviewTime.replace(/[^0-9.]/g, ''));
                }, 0) / facultyList.length;
                document.getElementById('avg-review-time').textContent = avgReviewTime.toFixed(1) + 'h';

                // Render faculty performance list
                const performanceContainer = document.getElementById('faculty-performance-list');
                performanceContainer.innerHTML = facultyList.map(faculty => `
                    <div class="bg-white rounded-lg p-4 border border-gray-200">
                        <div class="flex justify-between items-start">
                            <div>
                                <h5 class="font-semibold text-gray-900">${faculty.name}</h5>
                                <p class="text-sm text-gray-600">${faculty.specialization}</p>
                                <p class="text-xs text-gray-500">${faculty.email}</p>
                            </div>
                            <div class="text-right">
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getPerformanceBadgeClass(faculty.performance)}">
                                    ${faculty.performance.charAt(0).toUpperCase() + faculty.performance.slice(1)}
                                </span>
                            </div>
                        </div>
                        <div class="mt-3 grid grid-cols-3 gap-4 text-sm">
                            <div class="text-center">
                                <p class="font-semibold text-blue-600">${faculty.papersSubmitted}</p>
                                <p class="text-gray-500">Submitted</p>
                            </div>
                            <div class="text-center">
                                <p class="font-semibold text-green-600">${faculty.papersApproved}</p>
                                <p class="text-gray-500">Approved</p>
                            </div>
                            <div class="text-center">
                                <p class="font-semibold text-yellow-600">${faculty.avgReviewTime}</p>
                                <p class="text-gray-500">Avg Review</p>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            // Get performance badge class
            function getPerformanceBadgeClass(performance) {
                switch (performance) {
                    case 'excellent': return 'bg-green-100 text-green-800';
                    case 'good': return 'bg-blue-100 text-blue-800';
                    case 'average': return 'bg-yellow-100 text-yellow-800';
                    case 'developing': return 'bg-orange-100 text-orange-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            }

            // Initialize saved and recent content on page load
            document.addEventListener('DOMContentLoaded', function () {
                // Pre-load saved items data
                if (typeof loadSavedItems === 'function') {
                    loadSavedItems();
                }

                // Pre-load recent QPs data
                if (typeof loadRecentQPs === 'function') {
                    loadRecentQPs();
                }


            });
        });

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                    .then(registration => {
                        console.log('Service Worker registered successfully:', registration.scope);

                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New content is available, show update notification
                                    showUpdateNotification();
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallButton();
        });

        function showInstallButton() {
            const installButton = document.createElement('button');
            installButton.textContent = 'Install App';
            installButton.className = 'fixed bottom-4 right-4 bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-indigo-700 transition duration-200 z-50';
            installButton.onclick = installApp;
            document.body.appendChild(installButton);
        }

        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    deferredPrompt = null;
                });
            }
        }

        function showUpdateNotification() {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>New version available!</span>
                    <button onclick="location.reload()" class="ml-4 bg-green-700 px-3 py-1 rounded text-sm hover:bg-green-800">
                        Update
                    </button>
                </div>
            `;
            document.body.appendChild(notification);

            // Auto-hide after 10 seconds
            setTimeout(() => {
                notification.remove();
            }, 10000);
        }

        // Offline detection
        window.addEventListener('online', () => {
            console.log('Connection restored');
            showConnectionStatus('online');
        });

        window.addEventListener('offline', () => {
            console.log('Connection lost');
            showConnectionStatus('offline');
        });

        function showConnectionStatus(status) {
            const statusDiv = document.createElement('div');
            statusDiv.className = `fixed top-4 left-4 px-4 py-2 rounded-lg shadow-lg z-50 ${status === 'online' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'
                }`;
            statusDiv.textContent = status === 'online' ? 'Back online' : 'You are offline';
            document.body.appendChild(statusDiv);

            setTimeout(() => {
                statusDiv.remove();
            }, 3000);
        }
    </script>
</body>

</html>